<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha de Personagem</title>
    <style>
                :root {
            --bg-body: #09090b;
            --bg-card: #18181b;
            --bg-input: #27272a;
            --text-main: #e4e4e7;
            --text-muted: #a1a1aa;
            
            --color-primary: #8b5cf6; /* Roxo */
            --color-secondary: #10b981; /* Verde */
            --color-life: #ef4444; /* Vermelho */
            --color-mana: #3b82f6; /* Azul */
            --color-foco: #269c2c; /* F√∫csia */
            --color-gold: #eab308; /* Dourado */
            --color-skill: #22d3ee; /* Ciano (Per√≠cias) */
            --color-damage: #f97316; /* Laranja para Dano */

            
            --border-radius: 12px;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 40px 20px 180px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 40px;

            /* TRANSI√á√ÉO SUAVE DE FUNDO */
            transition: background 0.8s ease-in-out;
            min-height: 100vh;
        }

        /* --- RESSON√ÇNCIA DIN√ÇMICA --- */
        body.ressonancia-ativa {
            /* O segredo est√° aqui: var(--ressonancia-color) √© calculado pelo JS baseado no n√≠vel */
            background: radial-gradient(circle at center bottom, var(--ressonancia-color, #1e1b4b), #050505 80%);
            background-size: 100% 120%;
            animation: backgroundPulse 3s infinite alternate ease-in-out;
        }

        @keyframes backgroundPulse {
            0% { background-size: 100% 120%; filter: brightness(1); }
            100% { background-size: 105% 125%; filter: brightness(1.2); }
        }

        /* REMOVE AS SETINHAS (SPIN BUTTONS) DE TODOS OS CAMPOS NUM√âRICOS */
        input[type=number]::-webkit-outer-spin-button,
        input[type=number]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* --- CABE√áALHO --- */
        .header-container { width: 100%; max-width: 1100px; display: flex; justify-content: space-between; align-items: flex-start; }
        .header-nome { flex-grow: 1; }
        .label-topo { color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; font-weight: 700; margin-bottom: 8px; display: block; }
        .input-nome { background: transparent; border: none; border-bottom: 2px solid var(--bg-input); color: white; font-size: 2.5rem; padding: 10px 0; width: 100%; transition: 0.3s; }
        .input-nome:focus { outline: none; border-bottom-color: var(--color-primary); }

        /* SWITCH MODO JOGO */
        .switch-container { display: flex; align-items: center; gap: 10px; background: var(--bg-card); padding: 10px 15px; border-radius: 20px; border: 1px solid #3f3f46; }
        .switch-label { font-size: 0.8rem; font-weight: bold; color: var(--text-muted); text-transform: uppercase; }
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #3f3f46; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--color-secondary); }
        input:checked + .slider:before { transform: translateX(26px); }

        /* --- PAINEL PRINCIPAL --- */
        .painel-principal {
            background-color: var(--bg-card); padding: 30px; border-radius: var(--border-radius);
            width: 100%; max-width: 1100px; display: flex; flex-direction: column; gap: 30px;
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5);
        }
        /* --- CONTROLE DE MODOS (CORRIGIDO) --- */
        body.modo-jogo .editavel-apenas { display: none !important; }
        body.modo-jogo .jogo-apenas { display: flex !important; }
        body.modo-edicao .jogo-apenas { display: none !important; }

        /* Oculta bot√µes n√£o selecionados no modo jogo */
        body.modo-jogo .btn-habilidade:not(.selecionado):not(.info),
        body.modo-jogo .btn-magia:not(.selecionado):not(.info) { display: none !important; }

        /* CORRE√á√ÉO AQUI: Aplica o travamento APENAS aos selects da √°rea de origem, n√£o aos do modal */
        body.modo-jogo .secao-origem select { 
            pointer-events: none; 
            background-color: transparent; 
            border: none; 
            appearance: none; 
            padding: 0; 
            font-size: 1.2rem; 
            font-weight: bold; 
            color: var(--color-gold); 
        }

        /* CORRE√á√ÉO AQUI: Travamento apenas para os c√≠rculos de atributos/per√≠cias */
        body.modo-jogo .circulo-atributo, 
        body.modo-jogo .circulo-pericia { 
            border-color: #3f3f46; 
            background-color: #121214; 
        }

        /* CORRE√á√ÉO AQUI: Travamento apenas para inputs dentro dos c√≠rculos */
        body.modo-jogo .circulo-atributo .input-numero, 
        body.modo-jogo .circulo-pericia .input-numero { 
            pointer-events: none; 
            color: #a1a1aa; 
        }
        body.modo-jogo .input-numero { pointer-events: none; color: #a1a1aa; } /* Trava atributos */

        .secao-origem { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .grupo-input { display: flex; flex-direction: column; }
        select {
            padding: 12px; background-color: var(--bg-input); border: 1px solid #3f3f46;
            color: white; border-radius: 8px; font-size: 1rem; cursor: pointer; transition: 0.2s;
        }
        select:hover { border-color: #52525b; }
        select:focus { outline: none; border-color: var(--color-primary); }

        .separador { height: 1px; background-color: #3f3f46; width: 100%; opacity: 0.5; }

        .box-nivel-container { display: flex; justify-content: center; padding: 10px 0; }
        .box-nivel {
            display: flex; flex-direction: column; align-items: center; gap: 10px;
            background-color: var(--bg-input); padding: 15px 30px; border-radius: 12px; border: 1px solid #3f3f46;
        }
        .input-nivel {
            background: transparent; border: none; color: white; font-size: 2rem; font-weight: bold; width: 60px; text-align: center;
        }
        .input-nivel:focus { outline: none; color: var(--color-primary); }

        /* ATRIBUTOS */
        .cabecalho-secao { display: flex; justify-content: space-between; align-items: flex-end; }
        .titulo-secao { font-size: 1.1rem; font-weight: bold; color: white; display: flex; align-items: center; gap: 10px; }
        .badge-pontos {
            font-size: 0.9rem; padding: 6px 12px; border-radius: 6px; font-weight: 600;
            background-color: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
        }
        .pontos-attr { color: #fba94c; border-color: #fba94c; }
        .pontos-skill { color: var(--color-primary); border-color: var(--color-primary); }
        .pontos-magia { color: var(--color-magic); border-color: var(--color-magic); background-color: rgba(192, 132, 252, 0.1); }
        .pontos-pericia { color: var(--color-skill); border-color: var(--color-skill); background-color: rgba(6, 182, 212, 0.1); }

        .secao-atributos { display: flex; justify-content: center; gap: 30px; flex-wrap: wrap; margin-top: 5px; }
        .atributo-container { display: flex; flex-direction: column; align-items: center; gap: 12px; }
        .circulo-atributo {
            width: 70px; height: 70px; border-radius: 50%; background-color: var(--bg-input); border: 2px solid #3f3f46;
            display: flex; justify-content: center; align-items: center; transition: 0.3s; position: relative;
        }
        .circulo-atributo:focus-within { border-color: var(--color-gold); box-shadow: 0 0 15px rgba(234, 179, 8, 0.2); }
        .input-atributo {
            background: transparent; border: none; color: white; font-size: 1.6rem; font-weight: bold; width: 100%; height: 100%;
            text-align: center; border-radius: 50%;
        }
        .input-atributo:focus { outline: none; }
        .input-atributo::-webkit-outer-spin-button, .input-atributo::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }/*Essa linha esta obsoleta, n√£o faz mais nada
        .label-atributo { font-size: 0.9rem; color: var(--text-muted); font-weight: 500; }

        /* AFINIDADE */
        .secao-afinidade {
            background: linear-gradient(135deg, rgba(234, 179, 8, 0.15), rgba(234, 179, 8, 0.02));
            border: 1px solid rgba(234, 179, 8, 0.4); 
            border-radius: var(--border-radius);
            padding: 25px; 
            text-align: center;
            display: none; 
            flex-direction: column; 
            gap: 20px; 
            animation: slideIn 0.5s ease; 
            margin-top: 0px;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .titulo-afinidade { color: var(--color-gold); font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        .grid-afinidade { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .card-afinidade {
            background-color: rgba(0,0,0,0.3); border: 1px solid rgba(234, 179, 8, 0.2); padding: 20px; border-radius: 8px; cursor: pointer; transition: 0.3s; text-align: center;
        }
        .card-afinidade:hover { background-color: rgba(234, 179, 8, 0.1); border-color: var(--color-gold); }
        .card-afinidade.selecionado {
            background-color: var(--color-gold); color: #000; border-color: var(--color-gold); box-shadow: 0 0 20px rgba(234, 179, 8, 0.3);
        }

        /* --- HABILIDADES (DESIGN "ANTIGO" RESTAURADO) --- */
        .grid-habilidades {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr; /* 3 Colunas Fixas */
            gap: 25px; /* Mais espa√ßo entre colunas */
            width: 100%;
            max-width: 1200px;
        }
        .coluna {
            background-color: var(--bg-card);
            padding: 20px;
            border-radius: var(--border-radius);
            display: flex;
            flex-direction: column;
            gap: 15px; /* Mais espa√ßo entre bot√µes */
        }
        .coluna h2 {
            text-align: center; font-size: 1.1rem; color: var(--text-muted);
            text-transform: uppercase; margin-top: 0; border-bottom: 2px solid #3f3f46; padding-bottom: 15px;
        }

        /* Bot√£o Grande e Robusto */
        .btn-habilidade {
            background-color: #27272a; /* Cor base s√≥lida */
            border: 1px solid #3f3f46;
            border-left: 5px solid #52525b; /* Borda lateral grossa */
            padding: 20px; /* Bastante padding */
            margin: 6px 30px;
            border-radius: 8px;
            color: var(--text-main);
            cursor: pointer;
            transition: all 0.2s;
            min-height: 80px; /* Altura m√≠nima garantida */
            min-width: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-weight: 600;
            font-size: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2); /* Sombra para dar volume */
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative; /* Necess√°rio para o √≠cone absoluto */
        }

        .btn-habilidade:hover {
            transform: translateY(-5px) scale(1.02); 
            box-shadow: 0 10px 20px rgba(0,0,0,0.4); 
            background-color: #323238;
            border-color: #52525b;
            z-index: 10;
        }

        /* Estados do Bot√£o */
        .btn-habilidade.info {
            background-color: rgba(59, 130, 246, 0.15);
            border-color: var(--color-mana);
            border-left-color: var(--color-mana);
            color: #bfdbfe;
            font-size: 0.9rem; /* Texto levemente menor para descri√ß√£o */
            font-style: italic;
            display: inline-block;
        }

        .btn-habilidade.selecionado { 
            background-color: rgba(16, 185, 129, 0.15); 
            border-color: var(--color-secondary); 
            border-left-color: var(--color-secondary); 
            color: var(--color-secondary); 
        }
        .btn-habilidade.selecionado::after {
            content: '‚úî';
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 1.2rem;
            color: var(--color-secondary);
            opacity: 0;
            transform: scale(0);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .btn-habilidade.selecionado:hover::after {
            opacity: 1; transform: scale(1); top: -8px; right: -5px;
        }

        .btn-habilidade.bloqueado {
            opacity: 0.5;
            cursor: not-allowed;
            border-style: dashed;
            background-color: #18181b;
            box-shadow: none;
            transform: none;
        }

        /* --- NOVO: ESTILOS DO GRIM√ìRIO --- */
        .painel-grimorio {
            width: 100%; max-width: 1100px;
            background-color: #1a1025; /* Roxo escuro */
            border: 1px solid #4c1d95;
            border-radius: var(--border-radius);
            padding: 25px; margin-top: 30px;
            display: none; /* JS controla */
            flex-direction: column; gap: 20px;
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.15);
            animation: slideIn 0.6s ease;
        }
        .titulo-grimorio { 
            color: #c4b5fd; font-family: serif; font-size: 1.5rem; 
            text-align: center; text-transform: uppercase; letter-spacing: 2px; margin: 0;
            padding-bottom: 10px; border-bottom: 1px solid #5b21b6;
        }

        /* Nova linha de controle do Grim√≥rio */
        .grimorio-controles {
            display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 10px;
        }

        .grid-magias { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }

        .btn-magia {
            background-color: #2e1065; 
            border: 1px solid #5b21b6; 
            border-radius: 6px; 
            padding: 20px;
            color: #ddd6fe; cursor: pointer; min-height: 70px; 
            /* FLEXIBILIDADE DE TEXTO - CRUCIAL PARA N√ÉO QUEBRAR O LAYOUT */
            align-items: center; justify-content: center; text-align: center; 
            font-size: 0.9rem; 
            transition: all 0.3s; position: relative;
            display: inline-block;      /* n√£o flex, n√£o 'empurra' linhas */
            vertical-align: baseline;
            line-height: 1.2;           /* ajuste conforme sua tipografia */
            white-space: normal;        /* permite quebra natural */
            overflow: visible;
        }
        .btn-magia:not(.info):not(.selecionado) {
            display: flex;
            align-items: center;
        }
        .btn-magia:hover { 
            background-color: #4c1d95; 
            transform: translateY(-3px); 
            box-shadow: 0 8px 15px rgba(76, 29, 149, 0.3); 
            z-index: 10; }
        .btn-magia.info { 
            background-color: #1e1b4b; 
            font-style: italic; 
            font-size: 0.85rem; 
            color: #a5b4fc;
            vertical-align: middle   
            }
        .btn-magia.selecionado { 
            background-color: #5b21b6; 
            border-color: #8b5cf6; 
            color: white; font-weight: bold; 
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.4);
            display: flex;
            align-items: center;}
        .btn-magia.selecionado::after { content: '‚úî'; position: absolute; top: 5px; right: 5px; font-size: 1rem; color: #c4b5fd; opacity: 0; transform: scale(0); transition: all 0.3s; }
        .btn-magia.selecionado:hover::after { opacity: 1; transform: scale(1); top: -8px; right: -5px; }
        .btn-habilidade.bloqueado, 
        .btn-magia.bloqueado { 
            opacity: 0.3; /* Isso que deixa "apagado" (50% transparente) */
            cursor: not-allowed; /* Mostra o cursor de "proibido" */
            border-style: dashed; /* Borda tracejada */
            
            /* Remove efeitos de hover/clique */
            transform: none !important; 
            box-shadow: none !important; 
        }
        /* --- BOTAO DE USO DAS MAGIAS --- */
        .btn-gasto {
            display: inline-block;
            margin-top: 15px;
            padding: 8px 12px;
            background-color: #8b5cf6; /* Cor Padr√£o */
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid rgba(255,255,255,0.2);
            z-index: 20; /* Garante que fique acima */
            position: relative;
        }
        .btn-gasto:hover { transform: scale(1.05); filter: brightness(1.1); }
        .btn-gasto:active { transform: scale(0.95); }

        .btn-gasto.custo-mana { background-color: #3b82f6; }
        .btn-gasto.custo-vida { background-color: #ef4444; }
        .btn-gasto.custo-foco { background-color: #269c2c; }

        /* --- TOOLTIPS (ESTILO DARK RESTAURADO) --- */
        .termo-destaque {
            color: #f472b6; /* Rosa claro para destacar no texto */
            border-bottom: 1px dotted #f472b6; /* Sublinhado pontilhado */
            cursor: help;
            position: relative;
            
            /* Sua corre√ß√£o para o texto fluir (pode ser inline-block com padding ou inline puro) */
            display: inline-block; 
            vertical-align: baseline;
            font-weight: bold;
        }

        /* O Bal√£o de Informa√ß√£o (Estilo Dark / Glassmorphism) */
        .termo-destaque:hover::after {
            content: attr(data-tooltip);
            
            position: absolute;
            bottom: 130%; /* Acima do texto */
            left: 50%;
            transform: translateX(-50%);
            
            /* --- VISUAL RESTAURADO --- */
            background-color: rgba(15, 23, 42, 0.98); /* Fundo quase preto */
            color: #e2e8f0; /* Texto claro */
            border: 1px solid #6366f1; /* Borda √çndigo Neon */
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.8), 0 0 10px rgba(99, 102, 241, 0.3); /* Sombra com brilho */
            
            padding: 12px 16px;
            border-radius: 8px;
            
            /* Dimens√µes */
            width: max-content;
            max-width: 280px; 
            min-width: 160px;
            
            white-space: pre-wrap; /* Respeita quebras de linha */
            text-align: left;
            line-height: 1.5;
            font-size: 0.85rem;
            font-weight: normal;
            font-style: normal;
            
            z-index: 1000;
            pointer-events: none;
        }

        /* Setinha do Bal√£o (Cor ajustada para o fundo escuro) */
        .termo-destaque:hover::before {
            content: '';
            position: absolute;
            bottom: 110%; /* Ajuste fino para encostar na caixa */
            left: 50%;
            transform: translateX(-50%);
            border-width: 6px;
            border-style: solid;
            /* A cor da seta (topo) deve ser a borda neon ou o fundo escuro */
            border-color: #6366f1 transparent transparent transparent; 
            z-index: 1000;
        }

        /* --- PER√çCIAS --- */

        .secao-pericias-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
        }

        .caixa-pericias {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            
            /* Visual de "Caixa Circular/Oval" */
            background-color: rgba(34, 211, 238, 0.05); /* Ciano bem transparente */
            border: 1px solid rgba(34, 211, 238, 0.2);
            padding: 30px;
            border-radius: 100px; /* Borda bem redonda (P√≠lula) */
            box-shadow: 0 0 20px rgba(34, 211, 238, 0.05);
        }

        .pericia-item { display: flex; flex-direction: column; align-items: center; gap: 8px; }

        .circulo-pericia {
            width: 60px; height: 60px; /* Levemente menor que atributos */
            border-radius: 50%;
            background-color: #161618;
            border: 2px solid var(--color-skill);
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 0 10px rgba(34, 211, 238, 0.1);
            transition: all 0.3s;
        }

        .circulo-pericia:focus-within {
            box-shadow: 0 0 15px var(--color-skill);
            background-color: #1c1c1f;
            transform: scale(1.1);
        }
        /* 2. O Input em si (A parte cr√≠tica para n√£o ficar branco) */
        .input-numero { 
            background: transparent; /* Remove o fundo branco */
            border: none;            /* Remove a borda quadrada */
            color: white;            /* Cor do n√∫mero */
            font-size: 1.6rem; 
            font-weight: bold; 
            width: 100%; 
            height: 100%; 
            text-align: center; 
        }

        .input-numero:focus { 
            outline: none; /* Remove a linha azul padr√£o ao clicar */
        }

        /* --- STATUS FOOTER --- */
        .painel-status {
            background-color: #121214; width: 100%; max-width: 1100px;
            border-radius: 16px; border: 1px solid #3f3f46; padding: 25px;
            margin-top: 20px; box-shadow: 0 -10px 40px rgba(0,0,0,0.4);
            display: grid;
            grid-template-columns: 1fr 2fr; /* Coluna Barras (Menor) | Coluna Direita (Maior) */
            gap: 30px;
        }

        /* --- BARRAS INTERATIVAS (Vida/Mana Atuais) --- */
        .status-barras { display: flex; flex-direction: column; gap: 20px; justify-content: center; }
        .barra-container { display: flex; flex-direction: column; gap: 5px; position: relative; }
        .barra-label { display: flex; justify-content: space-between; font-weight: bold; font-size: 0.85rem; z-index: 2; position: relative; padding: 0 5px; }
        .barra-total { height: 20px; background-color: #27272a; border-radius: 10px; overflow: hidden; position: relative; border: 1px solid rgba(255,255,255,0.1); }
        .barra-preenchimento { height: 100%; width: 100%; transition: width 0.5s ease-out; }

        .inputs-barra { display: flex; gap: 5px; align-items: center; }
        .input-atual { 
            background: transparent; border: none; color: white; font-weight: bold; width: 40px; text-align: right; font-size: 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.2); 
        }
        .input-atual:focus { outline: none; border-bottom-color: white; }

        .vida .barra-preenchimento { background-color: var(--color-life); box-shadow: 0 0 10px var(--color-life); }
        .vida .inputs-barra { color: var(--color-life); }
        .mana .barra-preenchimento { background-color: var(--color-mana); box-shadow: 0 0 10px var(--color-mana); }
        .mana .inputs-barra { color: var(--color-mana); }
        .foco .barra-preenchimento { background-color: var(--color-foco); box-shadow: 0 0 10px var(--color-foco); }
        .foco .inputs-barra { color: var(--color-foco); }

        /* CONTAINER DA DIREITA */
        .status-direita { display: flex; flex-direction: column; gap: 20px; }
        .status-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .card-status { background-color: #1c1c1f; border: 1px solid #2e2e31; border-radius: 10px; padding: 15px 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; }
        .card-status .label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; }
        .card-status .valor { font-size: 1.4rem; font-weight: bold; color: white; }
        .card-status.ataque .valor { color: var(--color-gold); }

        .card-status.dano { border-color: rgba(249, 115, 22, 0.3); background: linear-gradient(180deg, rgba(249,115,22,0.05), transparent); }
        .card-status.dano .valor { color: var(--color-damage); }

        /* --- INVENT√ÅRIO (NOVO) --- */
                .equip-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 20px; width: 100%; }
                .equip-slot { background-color: #27272a; border: 2px dashed #3f3f46; border-radius: 8px; height: 100px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; position: relative; text-align: center; padding: 5px; }
                .equip-slot:hover { border-color: var(--text-muted); background-color: #323238; }
                .equip-slot.filled { border-style: solid; border-color: var(--color-gold); background-color: #2a2210; }
                .equip-slot.magic { border-color: var(--color-epic); background-color: #2e1065; box-shadow: 0 0 10px rgba(168, 85, 247, 0.2); }
                .slot-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px; }
                .slot-item { font-size: 0.8rem; font-weight: bold; color: white; word-break: break-word; line-height: 1.1; }
                .slot-icon { font-size: 1.5rem; color: #52525b; margin-bottom: 5px; }
                .filled .slot-icon { color: var(--color-gold); }
                .magic .slot-icon { color: var(--color-epic); }

        /* INVENT√ÅRIO (COM SUPORTE A CONSUM√çVEL) */
        .painel-inventario { background-color: #1c1c1f; border-radius: 12px; padding: 15px; border: 1px solid #3f3f46; display: flex; flex-direction: column; gap: 10px; flex-grow: 1; }
        .inv-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #3f3f46; padding-bottom: 10px; }
        .magic-slots { background-color: rgba(168, 85, 247, 0.1); color: var(--color-epic); padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; border: 1px solid var(--color-epic); }
        .inv-lista { display: flex; flex-direction: column; gap: 5px; overflow-y: auto; flex-grow: 1; max-height: 250px; }
        .inv-item { display: grid; grid-template-columns: 30px 1fr 30px 50px 30px; gap: 10px; align-items: center; background: #27272a; padding: 8px; border-radius: 4px; transition: 0.2s; }
        .inv-item:hover { background-color: #323238; }
        .inv-icon { font-size: 1.2rem; text-align: center; }
        .inv-add-btn { background-color: #3f3f46; border: none; color: white; padding: 10px; border-radius: 6px; cursor: pointer; width: 100%; margin-top: auto; font-weight: bold; }
        .inv-add-btn:hover { background-color: var(--color-secondary); color: #000; }

        .btn-equip-toggle { background: none; border: 1px solid #52525b; color: #aaa; border-radius: 4px; font-size: 0.7rem; cursor: pointer; padding: 2px 4px; }
        .btn-equip-toggle.equipped { background-color: var(--color-gold); color: black; border-color: var(--color-gold); }

        /* BOT√ÉO DE USAR CONSUM√çVEL */
        .btn-usar-item { background: var(--color-primary); color: white; border: none; border-radius: 4px; font-size: 0.7rem; padding: 2px 6px; cursor: pointer; font-weight: bold; }
        .btn-usar-item:hover { filter: brightness(1.2); }

        /* BOT√ÉO RESSON√ÇNCIA GRANDE (AJUSTADO) */
        .btn-ressonancia-big {
            background: linear-gradient(145deg, #7f1d1d, #450a0a);
            border: 2px solid #ef4444;
            color: #fecaca;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            text-transform: uppercase;
            letter-spacing: 2px;
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.2);
            /* Tamanho ajustado para alinhar com o invent√°rio se estivesse lado a lado, mas aqui ele ficar√° na esquerda */
            padding: 15px;
            margin-top: 10px; 
            width: 100%;
        }
        .btn-ressonancia-big span.custo { font-size: 0.8rem; font-weight: normal; opacity: 0.8; letter-spacing: normal; }
        .btn-ressonancia-big:hover { filter: brightness(1.2); transform: translateY(-2px); }
        .btn-ressonancia-big.ativo {
            background: linear-gradient(145deg, #ef4444, #991b1b); color: white; border-color: #fee2e2;
            box-shadow: 0 0 20px #ef4444; animation: pulse-big 1.5s infinite;
        }

        @media (max-width: 900px) { .painel-status { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { .grid-habilidades { grid-template-columns: 1fr; } }

        /* --- BOT√ÉO DE CRIAR FICHA --- */
        .container-submit {
            width: 100%; max-width: 1100px;
            display: flex; justify-content: flex-end;
            margin-top: 30px;
        }
        .btn-criar-ficha {
            background: linear-gradient(135deg, var(--color-secondary), #059669);
            color: white;
            border: none;
            padding: 18px 40px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .btn-criar-ficha:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.6);
        }
        .btn-criar-ficha:active { 
            transform: translateY(1px); }
        .btn-criar-ficha:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            transform: none; }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(5px); }
        .modal-box { background-color: #18181b; border: 1px solid #3f3f46; border-radius: 12px; width: 90%; max-width: 500px; padding: 25px; display: flex; flex-direction: column; gap: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); animation: modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes modalPop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-header h2 { margin: 0; color: white; font-size: 1.2rem; }
        .modal-tabs { display: flex; border-bottom: 1px solid #3f3f46; margin-bottom: 10px; }
        .tab-btn { background: none; border: none; color: #aaa; padding: 10px 20px; cursor: pointer; font-weight: bold; }
        .tab-btn.active { color: var(--color-secondary); border-bottom: 2px solid var(--color-secondary); }
        .tab-content { display: none; flex-direction: column; gap: 15px; }
        .tab-content.active { display: flex; }
        .modal-body input, .modal-body select { width: 100%; padding: 10px; background-color: #27272a; border: 1px solid #3f3f46; color: white; border-radius: 6px; margin-bottom: 10px; }
        .modal-body label { display: block; margin-bottom: 5px; color: #aaa; font-size: 0.9rem; }
        .magic-check { display: flex; align-items: center; gap: 10px; cursor: pointer; margin-top: 10px; }
        .magic-check input { width: auto; margin: 0; }
        .db-lista { max-height: 200px; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; }
        .db-item { display: flex; justify-content: space-between; align-items: center; background: #222; padding: 8px; border-radius: 4px; border: 1px solid #333; }
        .db-item:hover { border-color: var(--color-secondary); }
        .btn-pegar { background: var(--color-primary); border: none; color: white; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
        .btn-cancel { background: transparent; border: 1px solid #ef4444; color: #ef4444; padding: 10px 20px; border-radius: 6px; cursor: pointer; }
        .btn-confirm { background: var(--color-secondary); border: none; color: black; font-weight: bold; padding: 10px 20px; border-radius: 6px; cursor: pointer; }


        /* Melhoria Visual na Lista de Itens */
        .inv-item {
            display: grid; 
            grid-template-columns: 40px 1fr 80px 30px; /* √çcone | Nome | Peso | Delete */
            gap: 10px; align-items: center;
            background: #27272a; padding: 10px; border-radius: 6px;
            transition: 0.2s; border: 1px solid transparent;
        }
        .inv-item:hover { border-color: #52525b; }
        .item-icon { font-size: 1.4rem; text-align: center; }
        .item-name { color: #e4e4e7; font-weight: 500; }
        .item-sub { font-size: 0.75rem; color: #71717a; text-transform: uppercase; }
        .item-magic { color: var(--color-epic); text-shadow: 0 0 5px rgba(168, 85, 247, 0.3); }

        /* Feedback de Auto-Save */
        .saving-indicator { position: fixed; bottom: 20px; right: 20px; background-color: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 20px; font-size: 0.8rem; pointer-events: none; opacity: 0; transition: opacity 0.3s; border: 1px solid #3f3f46; }
        .saving-indicator.visible { opacity: 1; }

        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }   
    </style>  
</head>
<body class="modo-edicao">

    <div class="header-container">
        <div class="header-nome">
            <label class="label-topo">Nome do Personagem</label>
            <input type="text" class="input-nome" placeholder="Digite o nome...">
        </div>

        <!-- SWITCH DE MODO -->
        <div class="switch-container">
            <span class="switch-label">Edi√ß√£o</span>
            <label class="switch">
                <input type="checkbox" id="switch-modo" onclick="toggleModo()" checked>
                <span class="slider"></span>
            </label>
            <span class="switch-label" style="color: var(--color-secondary)">Jogo</span>
        </div>
    </div>

    <div class="painel-principal">
        
        <!-- ORIGEM -->
        <div class="secao-origem">
            <div class="grupo-input">
                <label class="label-topo">Aura</label>
                <select id="aura">
                    <option value="">Escolha uma aura</option>
                    <option value="reforco">Refor√ßo</option>
                    <option value="emissao">Emiss√£o</option>
                    <option value="transformacao">Transforma√ß√£o</option>
                    <option value="materializacao">Materializa√ß√£o</option>
                    <option value="manipulacao">Manipula√ß√£o</option>
                </select>
            </div>
            <div class="grupo-input">
                <label class="label-topo">Classe</label>
                <select id="classe">
                    <option value="">Escolha uma classe</option>
                    <option value="mistico">M√≠stico</option>
                    <option value="mago_elemental">Mago elemental</option>
                    <option value="mago_de_fronte">Mago de fronte</option>
                    <option value="fimbulwinter">Fimbulwinter</option>
                    <option value="feengari">Feengari</option>
                    <option value="ascendente">Ascendente</option>
                    <option value="espadachim">Espadachim</option>
                    <option value="arma_de_corda">Arma de Corda</option>
                    <option value="nordico">N√≥rdico</option>
                    <option value="lanceiro">Lanceiro</option>
                    <option value="atirador_de_elite">Atirador de elite</option>
                    <option value="assassino">Assassino</option>
                    <option value="gladiador">Gladiador</option>
                    <option value="charlatao">Charlat√£o</option>
                    <option value="alquimista">Alquimista</option>
                    <option value="artifice">Art√≠fice</option>
                </select>
            </div>
            <div class="grupo-input">
                <label class="label-topo">Trilha</label>
                <select id="trilha">
                    <option value="">Escolha uma Trilha</option>
                    <option value="envoltura">Envoltura</option>
                    <option value="expansao">Expans√£o</option>
                    <option value="liberacao">Libera√ß√£o</option>
                </select>
            </div>
        </div>

        <div class="separador"></div>

        <!-- N√çVEL CENTRALIZADO -->
        <div class="box-nivel-container">
            <div class="box-nivel">
                <label class="label-topo" style="margin:0; color:white;">N√çVEL ATUAL</label>
                <input type="number" id="nivel" class="input-numero input-nivel" min="1" max="16" value="1">
            </div>
        </div>

        <div class="separador"></div>

        <!-- √ÅREA DE ATRIBUTOS -->
           <div class="cabecalho-secao">
                <div class="titulo-secao">ATRIBUTOS</div>
                <div class="badge-pontos pontos-attr editavel-apenas">
                    PONTOS: <span id="pts-attr-atual">0</span> / <span id="pts-attr-total">0</span>
                </div>
            </div>

            <div class="secao-atributos">
                <div class="atributo-container"><div class="circulo-atributo"><input type="number" class="input-numero input-atributo" id="attr-forca" value="1" min="0"></div><span class="label-atributo">FOR√áA</span></div>
                <div class="atributo-container"><div class="circulo-atributo"><input type="number" class="input-numero input-atributo" id="attr-destreza" value="1" min="0"></div><span class="label-atributo">DESTREZA</span></div>
                <div class="atributo-container"><div class="circulo-atributo"><input type="number" class="input-numero input-atributo" id="attr-vigor" value="1" min="0"></div><span class="label-atributo">VIGOR</span></div>
                <div class="atributo-container"><div class="circulo-atributo"><input type="number" class="input-numero input-atributo" id="attr-intelecto" value="1" min="0"></div><span class="label-atributo">INTELECTO</span></div>
                <div class="atributo-container"><div class="circulo-atributo"><input type="number" class="input-numero input-atributo" id="attr-presenca" value="1" min="0"></div><span class="label-atributo">PRESEN√áA</span></div>
            </div>

            <!-- SE√á√ÉO DE ESCOLHA DE AFINIDADE (Oculta at√© n√≠vel 4) -->
            <div id="container-afinidade" class="secao-afinidade editavel-apenas">
                <div class="titulo-afinidade">
                    <span>‚òÖ Desbloqueio de Afinidade (N√≠vel 4) ‚òÖ</span>
                </div>
                <div style="color: #ccc; font-size: 0.9rem; margin-bottom: 10px;">
                    Escolha 1 especializa√ß√£o. Esta escolha √© √∫nica.
                </div>
                
                <div class="grid-afinidade" id="lista-afinidades">
                    <!-- Os cart√µes ser√£o gerados aqui via JS -->
                </div>
            </div>

    </div>

    <!-- √ÅREA DE HABILIDADES -->
    <div style="width: 100%; max-width: 1200px;">
        <div class="cabecalho-secao">
            <span class="titulo-secao">HABILIDADES</span>
            <!-- Caixa de Pontos Exclusiva para Habilidades -->
            <div class="badge-pontos pontos-skill editavel-apenas">
                DISPON√çVEIS: <span id="pts-skill-atual">0</span> / <span id="pts-skill-total">0</span>
            </div>
        </div>

        <div class="grid-habilidades">
            <div class="coluna" id="col-aura"><h2>Aura</h2><div id="lista-aura"></div></div>
            <div class="coluna" id="col-classe"><h2>Classe</h2><div id="lista-classe"></div></div>
            <div class="coluna" id="col-trilha"><h2>Trilha</h2><div id="lista-trilha"></div></div>
        </div>
    </div>

    <!-- GRIM√ìRIO ARCANO (A NOVA SE√á√ÉO) -->
    <div id="container-grimorio" class="painel-grimorio">
        <!-- T√≠tulo Centralizado -->
        <div class="titulo-grimorio">‚ú¶ Grim√≥rio Arcano ‚ú¶</div>
        
        <!-- Linha de Controle Centralizada -->
        <div class="grimorio-controles">
            <div style="color:#a5b4fc; font-size:0.9rem;">Magias Dispon√≠veis</div>
            <div class="badge-pontos pontos-magia editavel-apenas">
                PONTOS: <span id="pts-magia-atual">0</span> / <span id="pts-magia-total">0</span>
            </div>
        </div>
        
        <div class="grid-magias" id="lista-magias"></div>
    </div>

    <!-- PER√çCIAS -->
    <div class="painel-principal" style="margin-top: 30px;">
        <div class="cabecalho-secao">
            <div class="titulo-secao">PER√çCIAS</div>
            <div class="badge-pontos pontos-pericia editavel-apenas">PONTOS: <span id="pts-pericia-atual">0</span> / <span id="pts-pericia-total">0</span></div>
        </div>
        <div class="secao-pericias-container">
            <div class="caixa-pericias">
                <div class="pericia-item"><div class="circulo-pericia"><input type="number" class="input-numero input-pericia" id="per-medicina" value="0" min="0"></div><span class="label-circulo">Medicina</span></div>
                <div class="pericia-item"><div class="circulo-pericia"><input type="number" class="input-numero input-pericia" id="per-arcano" value="0" min="0"></div><span class="label-circulo">Arcano</span></div>
                <div class="pericia-item"><div class="circulo-pericia"><input type="number" class="input-numero input-pericia" id="per-diplomacia" value="0" min="0"></div><span class="label-circulo">Diplomacia</span></div>
                <div class="pericia-item"><div class="circulo-pericia"><input type="number" class="input-numero input-pericia" id="per-adestrar" value="0" min="0"></div><span class="label-circulo">Adestrar</span></div>
                <div class="pericia-item"><div class="circulo-pericia"><input type="number" class="input-numero input-pericia" id="per-tecnologia" value="0" min="0"></div><span class="label-circulo">Tecnologia</span></div>
            </div>
        </div>
    </div>    

    <!-- STATUS FOOTER -->
    <div class="painel-status">
        <div class="status-barras">
            <!-- Barra VIDA -->
            <div class="barra-container vida">
                <div class="barra-label">
                    <span>VIDA</span>
                    <div class="inputs-barra">
                        <input type="number" id="vida-atual" class="input-atual" oninput="atualizarBarras(); autoSalvarStatus()">
                        <span>/ <span id="stat-vida">100</span></span>
                    </div>
                </div>
                <div class="barra-total"><div class="barra-preenchimento" id="bar-vida-fill"></div></div>
            </div>
            
            <!-- Barra MANA -->
            <div class="barra-container mana">
                <div class="barra-label">
                    <span>MANA</span>
                    <div class="inputs-barra">
                        <input type="number" id="mana-atual" class="input-atual" oninput="atualizarBarras(); autoSalvarStatus()">
                        <span>/ <span id="stat-mana">50</span></span>
                    </div>
                </div>
                <div class="barra-total"><div class="barra-preenchimento" id="bar-mana-fill"></div></div>
            </div>
            
            <!-- Barra FOCO -->
            <div class="barra-container foco">
                <div class="barra-label">
                    <span>FOCO</span>
                    <div class="inputs-barra">
                        <input type="number" id="foco-atual" class="input-atual" oninput="atualizarBarras(); autoSalvarStatus()">
                        <span>/ <span id="stat-foco">0</span></span>
                    </div>
                </div>
                <div class="barra-total"><div class="barra-preenchimento" id="bar-foco-fill"></div></div>
            </div>

            <!-- Bot√£o Resson√¢ncia movido para c√° -->
            <button id="btn-ressonancia-big" class="btn-ressonancia-big jogo-apenas" onclick="toggleRessonancia()">
                ‚ö° RESSON√ÇNCIA
                <span class="custo" id="custo-ressonancia">-1 Mana/turno</span>
            </button>            
        </div>
        <div class="status-direita">
            <div class="status-grid">
                <div class="card-status ataque"><span class="label">Ataque</span><span class="valor" id="stat-ataque">+0</span></div>
                <div class="card-status dano"><span class="label">Dano</span><span class="valor" id="stat-dano">d4</span></div>
                <div class="card-status"><span class="label">Bloqueio</span><span class="valor" id="stat-bloqueio">0</span></div>
                <div class="card-status"><span class="label">Esquiva</span><span class="valor" id="stat-esquiva">0</span></div>
                <div class="card-status"><span class="label">Carga</span><span class="valor"><span id="peso-atual" style="color:var(--text-muted)">0</span> / <span id="stat-carga">0</span></span></div>
                <div class="card-status"><span class="label">Movimento</span><span class="valor" id="stat-movimento">9m</span></div>
            </div>

            <!-- SLOTS DE EQUIPAMENTO -->
            <div class="equip-grid jogo-apenas">
                <div class="equip-slot" id="slot-mainhand" onclick="toggleEquiparSlot('mainhand')"><div class="slot-label">M√£o D.</div><div class="slot-icon"><span id="icone-slot">‚öîÔ∏è</span></div><div class="slot-item">Vazio</div></div>
                <div class="equip-slot" id="slot-offhand" onclick="toggleEquiparSlot('offhand')"><div class="slot-label">M√£o E.</div><div class="slot-icon">üõ°Ô∏è</div><div class="slot-item">Vazio</div></div>
                <div class="equip-slot" id="slot-armor" onclick="toggleEquiparSlot('armor')"><div class="slot-label">Corpo</div><div class="slot-icon">üëï</div><div class="slot-item">Vazio</div></div>
                <div class="equip-slot" id="slot-acc1" onclick="toggleEquiparSlot('acc1')"><div class="slot-label">Acess√≥rio</div><div class="slot-icon">üíç</div><div class="slot-item">Vazio</div></div>
                <div class="equip-slot" id="slot-acc2" onclick="toggleEquiparSlot('acc2')"><div class="slot-label">Acess√≥rio</div><div class="slot-icon">üìø</div><div class="slot-item">Vazio</div></div>
            </div>

            <!-- INVENT√ÅRIO -->
            <div class="painel-inventario jogo-apenas" style="flex-grow:1;">
                <div class="inv-header">
                    <span style="font-weight:bold; color:white;">INVENT√ÅRIO</span>
                    <span class="magic-slots" id="magic-counter">‚ú® 0/3 Sintonizados</span>
                </div>
                <div class="inv-lista" id="lista-inventario"></div>
                <button class="inv-add-btn" onclick="abrirModalItem()">+ ADICIONAR ITEM</button>
            </div>
        </div>
    </div>
    
    <!-- BOT√ÉO FINAL -->
    <div class="container-submit editavel-apenas">
        <button type="submit" class="btn-criar-ficha" onclick="salvarFicha()">CRIAR / ATUALIZAR FICHA</button>
    </div>

    <!-- MODAL -->
    <div class="modal-overlay" id="modal-item">
        <div class="modal-box">
            <div class="modal-header">
                <h2>Biblioteca de Itens</h2>
                <div class="modal-tabs"><button class="tab-btn active" onclick="mudarAba('criar')">Criar Novo</button><button class="tab-btn" onclick="mudarAba('buscar')">Buscar Existente</button></div>
                <button class="tab-btn" style="margin-left: auto; color: #ef4444;" onclick="fecharModalItem()">‚úï</button>
            </div>
            <div id="aba-criar" class="tab-content active modal-body">
                <label>Nome do Item</label><input type="text" id="input-criar-nome" placeholder="Ex: Espada Longa">
                <label>Tipo</label>
                <!-- NOVA OP√á√ÉO CONSUMIVEL -->
                <select id="input-criar-tipo" onchange="toggleCamposConsumivel()">
                    <option value="item">üì¶ Item Comum</option>
                    <option value="equipamento">‚öîÔ∏è Equipamento</option>
                    <option value="armadura">üëï Armadura</option>
                    <option value="acessorio">üíç Acess√≥rio</option>
                    <option value="consumivel">üß™ Consum√≠vel</option>
                </select>
                
                <!-- CONTAINER: CAMPOS ESPECIAIS -->
                <div id="campos-equipamento" style="display:none; background:#222; padding:10px; border-radius:6px; margin-bottom:10px;">
                    <label style="color:var(--color-gold)">Empunhadura:</label>
                    <select id="input-criar-empunhadura">
                        <option value="1mao">1 M√£o</option>
                        <option value="2maos">2 M√£os (Ocupa as duas)</option>
                    </select>

                    <!-- NOVO: SUBTIPO AGORA SER√Å ADICIONADO AQUI NO MODAL -->
                    <label style="color:var(--color-gold); margin-top:5px;">Categoria:</label>
                    <select id="input-criar-subtipo" onchange="toggleCamposConsumivel()">                 
                        <option value="arma">Arma</option>
                        <option value="escudo">Escudo</option>
                        <option value="cajado">Cajado</option>
                        <option value="tomo">Tomo</option>
                    </select>
                    <!-- DIVS ESPEC√çFICAS PARA CADA SUBTIPO -->
                    <div id="campos-arma" style="display:none; margin-top:10px;">
                        <label style="color:var(--color-damage)">Dano (Arma):</label>
                        <input type="text" id="input-dano-arma" placeholder="Ex: 1d8">
                    </div>

                    <div id="campos-escudo" style="display:none; margin-top:10px;">
                        <label style="color:var(--color-secondary)">Bloqueio B√¥nus:</label>
                        <input type="number" id="input-bloqueio-escudo" value="0">
                    </div>

                    <div id="campos-cajado" style="display:none; margin-top:10px;">
                        <label style="color:var(--color-damage)">Dano F√≠sico:</label>
                        <input type="text" id="input-dano-cajado" placeholder="Ex: 1d6 + 2">
                    </div>

                    <!-- NOVO: CAMPO PARA TOMO -->
                    <div id="campos-tomo" style="display:none; margin-top:10px;">
                        <label style="color:var(--color-mana); margin-top:5px;">IDs das Magias (separados por v√≠rgula):</label>
                        <textarea id="input-magias-tomo" placeholder="ex: mag_1, fim_2" style="width:100%; padding:10px; background-color:#27272a; border:1px solid #3f3f46; color:white; border-radius:6px;"></textarea>
                    </div>

                </div>

                <!-- 2. CAMPOS DE ARMADURA (NOVO!) -->
                <div id="campos-armadura" style="display:none; background:#222; padding:10px; border-radius:6px; margin-bottom:10px;">
                    <label style="color:var(--color-primary)">B√¥nus de Bloqueio:</label>
                    <input type="number" id="input-criar-bloqueio" value="0">
                    
                    <label style="color:var(--color-primary); margin-top:5px;">Categoria:</label>
                    <select id="input-criar-tipo-armadura">
                         <option value="leve">Leve</option>
                         <option value="pesada">Pesada</option>
                    </select>
                </div>

                <!-- CAMPOS EXTRAS PARA CONSUM√çVEL -->
                <div id="campos-consumivel" style="display:none; background:#222; padding:10px; border-radius:6px; margin-bottom:10px;">
                    <label style="color:var(--color-primary)">Efeito (Restaura):</label>
                    <select id="input-criar-efeito">
                        <option value="vida">Vida</option>
                        <option value="mana">Mana</option>
                        <option value="foco">Foco</option>
                    </select>
                    <label style="color:var(--color-primary)">Quantidade:</label>
                    <input type="number" id="input-criar-valor" value="10">
                </div>

                <!-- DESCRI√á√ÉO NOVO -->
                <label>Descri√ß√£o</label>
                <textarea id="input-criar-descricao" placeholder="Detalhes do item..." rows="2" style="width: 100%; padding: 10px; background-color: #27272a; border: 1px solid #3f3f46; color: white; border-radius: 6px; margin-bottom: 10px; resize: vertical;"></textarea>

                <input type="number" id="input-criar-peso" value="0.0" step="0.1">
                <label class="magic-check" style="display:flex; align-items:center; gap:10px; margin-top:10px; cursor:pointer;"><input type="checkbox" id="input-criar-magico" style="width:auto;"><span style="color:#a855f7; font-weight:bold;">√â um Item M√°gico? ‚ú®</span></label>

                <div class="modal-actions" style="margin-top:20px; display:flex; justify-content:flex-end; gap:10px;">
                    <button class="btn-confirm" style="background:#10b981; border:none; padding:10px; border-radius:6px; font-weight:bold; cursor:pointer;" onclick="criarItemNoBanco()">Salvar no Banco & Pegar</button>
                </div>
            </div>
            <div id="aba-buscar" class="tab-content modal-body" style="display:none;">
                <input type="text" id="input-buscar-termo" placeholder="Digite para pesquisar..." onkeyup="buscarItensNoBanco()">
                <div class="db-lista" id="lista-banco-itens" style="margin-top:10px; max-height:200px; overflow-y:auto; display:flex; flex-direction:column; gap:5px;"><div style="color:#555; text-align:center;">Resultados aparecer√£o aqui...</div></div>
            </div>
        </div>
    </div>
    <div id="saving-indicator" class="saving-indicator">Salvando altera√ß√µes...</div>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const { createClient } = supabase;
        const supabaseUrl = "https://uoeixaiwyqjtbcqduzid.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVvZWl4YWl3eXFqdGJjcWR1emlkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4ODI2OTgsImV4cCI6MjA3MTQ1ODY5OH0.o_FY6xyjNetUjzsLiqaKrES_-d7_nYUE8vL8vFG8MDA";
        const supabaseClient = createClient(supabaseUrl, supabaseKey);


        // --- DADOS (Mesma estrutura anterior, voc√™ pode expandir) ---
        const dadosHabilidades = {
            classes: {
                mago_elemental: [
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'me_2', nome: 'Atalho do Mago', desc: 'Atalho do Mago √© uma a√ß√£o b√¥nus que custa 1 ponto de Foco. Para cada ponto de Foco gasto dessa forma, o personagem gera imediatamente 4 pontos de Mana, convertendo concentra√ß√£o em energia m√°gica de maneira r√°pida e instintiva.', tier: 1 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'me_3', nome: 'Finta Improvisada', desc: 'Finta Improvisada √© uma a√ß√£o padr√£o que custa 2 pontos de Foco. Ao utiliz√°-la, o personagem substitui sua a√ß√£o de ataque por uma manobra improvisada, podendo tentar derrubar ou desarmar o alvo.', tier: 1 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'me_4', nome: 'Afinidade Elemental', desc: 'Afinidade Elemental √© uma habilidade passiva sem custo. Sempre que o personagem conjura uma magia elemental e, em seguida, lan√ßa outra magia do mesmo elemento, a segunda magia recebe um b√¥nus de +1 dado de dano adicional. Esse b√¥nus aumenta para +2 dados no n√≠vel 8, +3 dados no n√≠vel 12 e +4 dados no n√≠vel 16.', tier: 2 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'me_5', nome: 'Ciclo arcano', desc: 'Ciclo Arcano √© uma habilidade passiva sem custo. Ap√≥s conjurar duas magias consecutivas de tipos diferentes, o personagem recebe um b√¥nus de 50% de dano na pr√≥xima magia lan√ßada.', tier: 2 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'me_6', nome: 'Aniquila√ß√£o', desc: 'Aniquila√ß√£o √© uma habilidade passiva sem custo que se ativa sempre que o personagem obt√©m um acerto cr√≠tico. Caso o ataque cr√≠tico seja de alvo √∫nico, o dano passa a ser aplicado em √°rea de alcance curto. Se o ataque j√° for um ataque em √°rea, ele mant√©m sua √°rea normal, mas passa a ser tratado mecanicamente como um ataque de alvo √∫nico, n√£o sofrendo redu√ß√£o de dano por m√∫ltiplos alvos.', tier: 3 },
                    
                ],

                mistico: [
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'mis_2', nome: 'Atalho do Mago', desc: 'Atalho do Mago √© uma a√ß√£o b√¥nus que custa 1 ponto de Foco. Para cada ponto de Foco gasto dessa forma, o personagem gera imediatamente 4 pontos de Mana, convertendo concentra√ß√£o em energia m√°gica de maneira r√°pida e instintiva.', tier: 1 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'mis_3', nome: 'Finta Improvisada', desc: 'Finta Improvisada √© uma a√ß√£o padr√£o que custa 2 pontos de Foco. Ao utiliz√°-la, o personagem substitui sua a√ß√£o de ataque por uma manobra improvisada, podendo tentar derrubar ou desarmar o alvo.', tier: 1 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'mis_4', nome: 'Espa√ßo Extra', desc: 'Espa√ßo Extra √© uma habilidade passiva sem custo que aumenta a capacidade do personagem de carregar c√≠rculos m√°gicos adicionais. Inicialmente, o personagem pode carregar 1 c√≠rculo extra. No n√≠vel 8, esse n√∫mero aumenta para 2 c√≠rculos adicionais, no n√≠vel 12 para 3 c√≠rculos e no n√≠vel 16 para 4 c√≠rculos adicionais.', tier: 2 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'mis_5', nome: 'Agilizar C√≠rculo', desc: 'Agilizar C√≠rculo √© ativada como uma a√ß√£o b√¥nus ao custo de 2 pontos de Foco. Essa habilidade permite ativar um c√≠rculo m√°gico utilizando uma a√ß√£o b√¥nus, em vez de consumir uma a√ß√£o padr√£o ou turno completo.', tier: 2 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'mis_6', nome: 'Gambiarra do M√≠stico', desc: 'Gambiarra do M√≠stico √© ativada como uma a√ß√£o padr√£o ao custo de 4 pontos de Foco. O personagem pode reutilizar um c√≠rculo m√°gico que j√° tenha sido usado durante o combate. Caso deseje reutilizar novamente o mesmo c√≠rculo mais de uma vez, o custo da habilidade aumenta de forma exponencial a cada reutiliza√ß√£o adicional.', tier: 3 },
                    
                ],

                mago_de_fronte: [
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'mf_2', nome: 'Atalho do Mago', desc: 'Atalho do Mago √© uma a√ß√£o b√¥nus que custa 1 ponto de Foco. Para cada ponto de Foco gasto dessa forma, o personagem gera imediatamente 4 pontos de Mana, convertendo concentra√ß√£o em energia m√°gica de maneira r√°pida e instintiva.', tier: 1 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'mf_3', nome: 'Finta', desc: 'Finta √© uma a√ß√£o padr√£o sem custo. Ao utiliz√°-la, o personagem pode gastar sua a√ß√£o de ataque para tentar derrubar ou desarmar o alvo, representando uma manobra t√©cnica executada sem gasto adicional de recursos.', tier: 1 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'mf_4', nome: 'Initerrupto', desc: 'Ininterrupto √© ativado como uma a√ß√£o b√¥nus ao custo de 6 pontos de Foco. Caso o personagem seja interrompido enquanto canaliza uma magia e j√° tenha completado mais de 50% do tempo de canaliza√ß√£o, ele pode liberar a magia imediatamente com 50% de sua efici√™ncia, sendo essa libera√ß√£o obrigatoriamente direcionada contra o alvo que causou a interrup√ß√£o. Se a interrup√ß√£o ocorrer antes de metade do tempo de canaliza√ß√£o, a magia √© completamente cancelada, sem gerar efeito.', tier: 2 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'mf_5', nome: 'Rota√ß√£o Perfeita', desc: 'Rota√ß√£o Perfeita √© uma habilidade passiva sem custo. Sempre que o personagem acerta um ataque f√≠sico, a pr√≥xima magia conjurada recebe um b√¥nus de +1d10 de dano. Esse b√¥nus aumenta para +2d10 no n√≠vel 8, +3d10 no n√≠vel 12 e +4d10 no n√≠vel 16.', tier: 2 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'mf_6', nome: 'Conjura√ß√£o Livre', desc: 'Conjura√ß√£o Livre √© ativada como uma a√ß√£o b√¥nus ao custo de 3 pontos de Foco. Essa habilidade permite que o personagem canalize uma magia utilizando apenas a√ß√µes de movimento, preservando a a√ß√£o padr√£o para outras a√ß√µes. Esse efeito s√≥ pode ser aplicado a magias cuja canaliza√ß√£o dure mais de um turno.', tier: 3 },
                    
                ],

                fimbulwinter: [
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'fi_2', nome: 'Atalho do Mago', desc: 'Atalho do Mago √© uma a√ß√£o b√¥nus que custa 1 ponto de Foco. Para cada ponto de Foco gasto dessa forma, o personagem gera imediatamente 4 pontos de Mana, convertendo concentra√ß√£o em energia m√°gica de maneira r√°pida e instintiva.', tier: 1 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'fi_3', nome: 'Finta Improvisada', desc: 'Finta Improvisada √© uma a√ß√£o padr√£o que custa 2 pontos de Foco. Ao utiliz√°-la, o personagem substitui sua a√ß√£o de ataque por uma manobra improvisada, podendo tentar derrubar ou desarmar o alvo.', tier: 1 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'fi_4', nome: 'Sangue Congelante', desc: 'Sangue Congelante √© uma habilidade passiva que faz com que a temperatura corporal e a aura do personagem caiam naturalmente para abaixo de zero. A cada magia conjurada, o personagem eleva seu Est√°gio de Frio, representando o aprofundamento dessa condi√ß√£o. No Est√°gio 1, chamado Frio Leve, o personagem se torna imune a danos g√©lidos. No Est√°gio 2, Frio Profundo, o personagem passa a causar +1d10 de dano g√©lido adicional em suas magias, b√¥nus que aumenta para +2d10 no n√≠vel 12 e +4d10 no n√≠vel 16, por√©m sofre ‚Äì1 em testes sociais. No Est√°gio 3, Frio Absoluto, o b√¥nus de dano g√©lido passa a ser +2d10, seguindo o mesmo escalonamento de n√≠veis, o redutor em testes sociais aumenta para ‚Äì2 e o movimento do personagem √© reduzido em 50%.', tier: 2 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'fi_5', nome: 'Esfriar', desc: 'Corpo de Permafrost √© uma habilidade passiva que faz com que a aura do personagem assuma as propriedades do Gelo Verdadeiro. Sempre que o personagem receber dano f√≠sico direto, o dano √© reduzido em um valor igual a 2 vezes seu Est√°gio de Frio. Esse valor de redu√ß√£o aumenta para 4 vezes o Est√°gio de Frio no n√≠vel 12 e para 8 vezes no n√≠vel 16. Al√©m disso, enquanto estiver no Est√°gio 3 de Frio, qualquer atacante que causar dano f√≠sico direto ao personagem sofre 1d10 de dano g√©lido de retorno, valor que aumenta para 2d10 no n√≠vel 12 e 4d10 no n√≠vel 16.', tier: 2 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'fi_6', nome: 'Fimbulwinter', desc: 'Cora√ß√£o de Inverno Eterno √© um gatilho autom√°tico que se ativa sempre que o personagem obt√©m um acerto cr√≠tico. Nesse momento, sua temperatura cai instantaneamente para um est√°gio extremo e, por 1 turno, o personagem entra em um estado de Inani√ß√£o. Durante esse turno, todas as criaturas em alcance curto sofrem ‚Äì5 em jogadas de ataque e t√™m seu movimento reduzido pela metade. Criaturas adjacentes ao personagem sofrem 3d10 de dano g√©lido imediato e perdem completamente o movimento naquela rodada.', tier: 3 },
                    
                ],

                feengari: [
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'fe_2', nome: 'Atalho do Mago', desc: 'Atalho do Mago √© uma a√ß√£o b√¥nus que custa 1 ponto de Foco. Para cada ponto de Foco gasto dessa forma, o personagem gera imediatamente 4 pontos de Mana, convertendo concentra√ß√£o em energia m√°gica de maneira r√°pida e instintiva.', tier: 1 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'fe_3', nome: 'Finta improvisada', desc: 'Finta Improvisada √© uma a√ß√£o padr√£o que custa 2 pontos de Foco. Ao utiliz√°-la, o personagem substitui sua a√ß√£o de ataque por uma manobra improvisada, podendo tentar derrubar ou desarmar o alvo.', tier: 1 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'fe_4', nome: 'Lua artificial', desc: 'Lua Artificial √© ativada como uma a√ß√£o b√¥nus ao custo de 2 pontos de Foco por rodada. Enquanto estiver sob luz do dia, o Fengari √© obrigado a manter essa habilidade ativa para poder conjurar magias normalmente. Caso o personagem crie um ambiente escuro ou se desloque para uma √°rea sem luz natural, Lua Artificial se torna desnecess√°ria e pode ser desativada sem custo adicional.', tier: 2 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'fe_5', nome: 'Olhos do Vazio', desc: 'Olhos do Vazio √© uma habilidade passiva em que o Feengari abdica da sensibilidade humana tradicional para enxergar a aus√™ncia, o ‚Äúru√≠do negativo‚Äù e distor√ß√µes da realidade. Sempre que o personagem gastar Mana, o Olhar do Vazio √© ativado, permitindo enxergar atrav√©s de escurid√£o normal e m√°gica, al√©m de conceder +1d10 em testes de Percep√ß√£o e Investiga√ß√£o. A partir do n√≠vel 12, o personagem passa a identificar auras, inten√ß√µes hostis e criaturas ocultas como sombras vibrantes, por√©m perde completamente a capacidade de enxergar sob luz do dia. Ap√≥s o n√≠vel 12, mesmo sem gastar Mana, sua vis√£o durante o dia se torna constantemente desconfort√°vel e inst√°vel.', tier: 2 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'fe_6', nome: 'Transmuta√ß√£o Lunar', desc: 'Lua Sangrenta do Abismo √© uma habilidade passiva que desbloqueia a Carga Lunar, permitindo que o personagem utilize suas magias em suas vers√µes Abissais sempre que dispon√≠veis.', tier: 3 },
                    
                ],

                ascendente: [
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'as_2', nome: 'Atalho do Mago', desc: 'Atalho do Mago √© uma a√ß√£o b√¥nus que custa 1 ponto de Foco. Para cada ponto de Foco gasto dessa forma, o personagem gera imediatamente 4 pontos de Mana, convertendo concentra√ß√£o em energia m√°gica de maneira r√°pida e instintiva.', tier: 1 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'as_3', nome: 'Finta', desc: 'Finta √© uma a√ß√£o padr√£o sem custo. Ao utiliz√°-la, o personagem pode gastar sua a√ß√£o de ataque para tentar derrubar ou desarmar o alvo, representando uma manobra t√©cnica executada sem gasto adicional de recursos.', tier: 1 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'as_4', nome: 'Acalmar', desc: 'Acalmar √© utilizada como uma a√ß√£o padr√£o ao custo de 4 pontos de Foco. Ao ativ√°-la, o personagem inicia um processo de compreens√£o da entidade interior, reduzindo gradualmente sua influ√™ncia. Isso permite que o usu√°rio acalme a entidade e remova a m√°scara, retornando temporariamente ao controle pleno de si mesmo.', tier: 2 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'as_5', nome: 'Consci√™ncia', desc: 'Consci√™ncia √© ativada como uma a√ß√£o b√¥nus ao custo de 4 pontos de Foco. Ao utiliz√°-la, o personagem e a entidade interior entram em sintonia parcial, passando a compartilhar sentidos. Enquanto o efeito estiver ativo, o personagem pode escolher livremente seus alvos em combate, ignorando interfer√™ncias, impulsos ou distor√ß√µes causadas pela entidade.', tier: 2 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'as_6', nome: 'Harmonia', desc: 'Harmonia √© uma habilidade passiva que possui como pr√©-requisitos Acalmar e Consci√™ncia. Ao alcan√ß√°-la, o personagem finalmente compreende completamente a entidade, e a entidade passa a compreend√™-lo da mesma forma. A partir desse ponto, ambos dividem pensamentos, sentidos e vontades, tornando-se efetivamente um s√≥. O personagem obt√©m controle total sobre seus poderes e a√ß√µes, mesmo enquanto utiliza a m√°scara.', tier: 3 },
                    
                ],

                espadachim: [
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'esp_1', nome: 'Precis√£o', desc: 'Precis√£o √© uma a√ß√£o b√¥nus que custa 3 pontos de Foco. Ela pode ser ativada antes de um ataque do personagem ou antes do ataque de um inimigo. Ao utiliz√°-la, o personagem recebe +3 de b√¥nus em testes de ataque ou +3 de b√¥nus em testes de defesa, conforme a escolha no momento da ativa√ß√£o.', tier: 1 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'esp_2', nome: 'Finta', desc: 'Finta √© uma a√ß√£o padr√£o sem custo. Ao utiliz√°-la, o personagem pode gastar sua a√ß√£o de ataque para tentar derrubar ou desarmar o alvo, representando uma manobra t√©cnica executada sem gasto adicional de recursos.', tier: 1 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'esp_3', nome: 'Ataque do trapaceiro', desc: 'Ataque do Trapaceiro √© ativado como uma a√ß√£o padr√£o ao custo de 3 pontos de Foco. O personagem realiza um ataque que causa apenas 50% do dano normal, mas simultaneamente executa uma Finta contra o alvo. Caso o alvo falhe no teste de resist√™ncia √† Finta, o usu√°rio recebe um b√¥nus de +1d10 no pr√≥ximo ataque contra esse mesmo alvo, b√¥nus que evolui para +2d10 a partir do n√≠vel 12.', tier: 2 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'esp_4', nome: 'Finta de guerra', desc: 'Finta de Guerra √© ativada como uma a√ß√£o b√¥nus ao custo de 2 pontos de Foco. O personagem pode realizar um ataque extra contra qualquer alvo que tenha sofrido uma Finta sua nesse mesmo turno. Esse ataque causa 100% do dano normal. Se o ataque acertar, o alvo fica Exposto, e enquanto n√£o se recompor, qualquer ataque contra ele causa +1d10 de dano adicional.', tier: 2 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'esp_5', nome: 'Ataque do trapaceiro II', desc: 'Ataque do Trapaceiro II √© uma habilidade passiva sem custo. Sempre que o personagem acerta dois ataques consecutivos no mesmo alvo durante um combate, ele ativa o efeito Leitura de Estilo. Enquanto esse efeito estiver ativo, seus ataques contra esse alvo passam a incluir automaticamente uma Finta embutida, e o Ataque do Trapaceiro passa a causar 100% do dano normal. Esse efeito s√≥ pode estar ativo contra um inimigo por vez; ao trocar de alvo, √© necess√°rio acertar dois ataques consecutivos novamente para reativar a Leitura de Estilo.', tier: 3 },
                ],

                arma_de_corda: [
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'adc_1', nome: 'Precis√£o', desc: 'Precis√£o √© uma a√ß√£o b√¥nus que custa 3 pontos de Foco. Ela pode ser ativada antes de um ataque do personagem ou antes do ataque de um inimigo. Ao utiliz√°-la, o personagem recebe +3 de b√¥nus em testes de ataque ou +3 de b√¥nus em testes de defesa, conforme a escolha no momento da ativa√ß√£o.', tier: 1 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'adc_2', nome: 'Finta', desc: 'Finta √© uma a√ß√£o padr√£o sem custo. Ao utiliz√°-la, o personagem pode gastar sua a√ß√£o de ataque para tentar derrubar ou desarmar o alvo, representando uma manobra t√©cnica executada sem gasto adicional de recursos.', tier: 1 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'adc_3', nome: 'Enla√ßar', desc: 'Enla√ßar √© ativado como uma a√ß√£o padr√£o ao custo de 2 pontos de Foco. O ataque prende o inimigo, deixando-o Enraizado. Para escapar, o alvo deve vencer um teste de For√ßa contra o personagem; em caso de falha, o alvo perde o turno. Enquanto o inimigo estiver enla√ßado, o usu√°rio n√£o pode realizar ataques. A cada rodada em que o efeito se mant√©m, o personagem recebe um b√¥nus cumulativo de +5 no teste de For√ßa para manter o enla√ßamento.', tier: 2 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'adc_4', nome: 'Pux√£o Brutal', desc: 'Pux√£o Brutal √© ativado como uma a√ß√£o de movimento e n√£o possui custo. Caso um inimigo esteja Enla√ßado, o personagem pode pux√°-lo para qualquer ponto dentro de seu alcance, incluindo jog√°-lo atr√°s de aliados ou contra armadilhas. Se o inimigo colidir com outro inimigo ou com um obst√°culo s√≥lido, ambos sofrem 2d10 de dano, valor que aumenta para 4d10 a partir do n√≠vel 12. Al√©m disso, ambos devem realizar um teste de For√ßa; em caso de falha, ficam Atordoados por 1 turno.', tier: 2 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'adc_5', nome: 'Zona segura', desc: 'Zona Segura √© ativada como uma a√ß√£o padr√£o ao custo de 6 pontos de Foco. O personagem gira sua arma em c√≠rculos, criando uma barreira cin√©tica ao seu redor. Aliados dentro da zona recebem +2 de Defesa. Inimigos que tentarem entrar na √°rea sofrem um ataque autom√°tico; caso esse ataque resulte em um acerto cr√≠tico, o inimigo √© empurrado para fora da zona. O efeito dura 1 turno, podendo ser mantido por rodadas adicionais ao custo de Foco ou Mana.', tier: 3 },
                ],

                nordico: [
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'no_1', nome: 'Precis√£o', desc: 'Precis√£o √© uma a√ß√£o b√¥nus que custa 3 pontos de Foco. Ela pode ser ativada antes de um ataque do personagem ou antes do ataque de um inimigo. Ao utiliz√°-la, o personagem recebe +3 de b√¥nus em testes de ataque ou +3 de b√¥nus em testes de defesa, conforme a escolha no momento da ativa√ß√£o.', tier: 1 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'no_2', nome: 'Finta', desc: 'Finta √© uma a√ß√£o padr√£o sem custo. Ao utiliz√°-la, o personagem pode gastar sua a√ß√£o de ataque para tentar derrubar ou desarmar o alvo, representando uma manobra t√©cnica executada sem gasto adicional de recursos.', tier: 1 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'no_3', nome: 'Iniciador', desc: 'Iniciador √© uma habilidade passiva e n√£o possui custo. Sempre que o N√≥rdico ataca um inimigo que ainda n√£o sofreu dano naquela rodada, ele causa 50% a mais de dano. Caso o ataque acerte, o alvo deve realizar um teste de For√ßa; em caso de falha, o N√≥rdico pode escolher entre empurrar o inimigo 1 metro ou derrub√°-lo no ch√£o.', tier: 2 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'no_4', nome: 'Tormenta N√≥rdica', desc: 'Tormenta N√≥rdica √© ativada como uma a√ß√£o padr√£o ao custo de 6 pontos de Foco e pode ser utilizada de duas formas. Na primeira, o N√≥rdico gira seu machado, criando uma tempestade de a√ßo que causa dano a todos os inimigos em alcance curto; cada inimigo atingido deve realizar um teste de For√ßa e, em caso de falha, √© arremessado para longe. Na segunda forma, o N√≥rdico desfere um golpe devastador contra o solo, rachando o ch√£o; o ataque causa dano total em linha reta, atingindo todos os inimigos em alcance m√©dio alinhados, e ignora armaduras leves.', tier: 2 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'no_5', nome: 'Sangue de Gigante', desc: 'Sangue do Gigante √© uma habilidade passiva e n√£o possui custo. Para cada inimigo adjacente ao N√≥rdico, ele recebe um b√¥nus de +50% no dano causado e +2 de Armadura tempor√°ria.', tier: 3 },
                ],

                lanceiro: [
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'lan_1', nome: 'Precis√£o', desc: 'Precis√£o √© uma a√ß√£o b√¥nus que custa 3 pontos de Foco. Ela pode ser ativada antes de um ataque do personagem ou antes do ataque de um inimigo. Ao utiliz√°-la, o personagem recebe +3 de b√¥nus em testes de ataque ou +3 de b√¥nus em testes de defesa, conforme a escolha no momento da ativa√ß√£o.', tier: 1 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'lan_2', nome: 'Finta', desc: 'Finta √© uma a√ß√£o padr√£o sem custo. Ao utiliz√°-la, o personagem pode gastar sua a√ß√£o de ataque para tentar derrubar ou desarmar o alvo, representando uma manobra t√©cnica executada sem gasto adicional de recursos.', tier: 1 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'lan_3', nome: 'Arremesso', desc: 'Arremesso √© ativado como uma a√ß√£o padr√£o ao custo de 1 ponto de Foco. O personagem arremessa sua lan√ßa a uma dist√¢ncia m√°xima igual ao n√≠vel do personagem multiplicado por 3 metros. Caso o ataque seja um acerto cr√≠tico, o alvo √© automaticamente empalado, ficando preso no local at√© o pr√≥ximo turno.', tier: 2 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'lan_4', nome: 'Calibrado', desc: 'Calibrado √© uma habilidade passiva e n√£o possui custo. Ela aumenta a margem de amea√ßa dos ataques do personagem em +2. A partir do n√≠vel 8, esse b√¥nus aumenta para +4, e no n√≠vel 12 passa a ser +6.', tier: 2 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'lan_5', nome: 'Estocada', desc: 'Estocada √© ativada como uma a√ß√£o padr√£o ao custo de 5 pontos de Foco. O personagem realiza um ataque extremamente preciso; caso o ataque seja um acerto cr√≠tico, ele ignora bloqueios e esquivas. Se Estocada for utilizada em conjunto com Arremesso, o dano total do ataque √© multiplicado por 3.', tier: 3 },
                ],

                atirador_de_elite: [
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'ae_1', nome: 'C√°lculo Exato', desc: 'C√°lculo Exato √© uma a√ß√£o b√¥nus que custa 5 pontos de Foco e deve ser ativada antes da realiza√ß√£o de um ataque. Ao utilizar essa habilidade, o personagem escolhe um dos dois efeitos a seguir. No Golpe Inevit√°vel, o ataque realizado acerta automaticamente o alvo, ignorando testes de ataque, embora ainda esteja sujeito a efeitos que neguem dano ou anulem o impacto. No Golpe Friamente Calculado, o personagem executa o ataque com precis√£o extrema, rolando dados adicionais de dano equivalentes a +1d10 para cada metade inteira do atributo associado √† arma utilizada (arredondando para baixo). O b√¥nus de dano √© aplicado apenas a esse ataque.', tier: 1 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'ae_2', nome: 'Finta Improvisada', desc: 'Finta Improvisada √© uma a√ß√£o padr√£o que custa 2 pontos de Foco. Ao utiliz√°-la, o personagem substitui sua a√ß√£o de ataque por uma manobra improvisada, podendo tentar derrubar ou desarmar o alvo.', tier: 1 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'ae_3', nome: 'Disparo r√°pido', desc: 'Ao ativar Disparo R√°pido, gastando 3 pontos de Foco, um ataque √† dist√¢ncia passa a consumir apenas a a√ß√£o padr√£o, em vez de exigir o uso do turno completo. Essa habilidade permite executar disparos com maior agilidade dentro da mesma rodada.', tier: 2 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'ae_4', nome: 'Concentra√ß√£o', desc: 'Concentra√ß√£o √© uma habilidade passiva e n√£o possui custo. A cada rodada em que o personagem n√£o sofre ataques, seu dano aumenta em 100%, podendo acumular progressivamente at√© um m√°ximo de 400%. Caso o personagem seja alvo de um ataque, mesmo que o ataque erre, o efeito de Concentra√ß√£o √© imediatamente reiniciado.', tier: 2 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'ae_5', nome: 'Chuva de projeteis', desc: 'Chuva de Proj√©teis consome o turno completo e possui um custo base de 4 pontos de Foco, multiplicado para cada proj√©til adicional disparado. A habilidade permite disparar mais de um proj√©til em um √∫nico ataque; a cada proj√©til adicional adicionado, o custo da habilidade dobra em rela√ß√£o ao anterior.', tier: 3 },
                ],

                assassino: [
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'ass_1', nome: 'C√°lculo exato I', desc: 'C√°lculo Exato √© uma a√ß√£o b√¥nus que custa 5 pontos de Foco e deve ser ativada antes da realiza√ß√£o de um ataque. Ao utilizar essa habilidade, o personagem escolhe um dos dois efeitos a seguir. No Golpe Inevit√°vel, o ataque realizado acerta automaticamente o alvo, ignorando testes de ataque, embora ainda esteja sujeito a efeitos que neguem dano ou anulem o impacto. No Golpe Friamente Calculado, o personagem executa o ataque com precis√£o extrema, rolando dados adicionais de dano equivalentes a +1d10 para cada metade inteira do atributo associado √† arma utilizada (arredondando para baixo). O b√¥nus de dano √© aplicado apenas a esse ataque.', tier: 1 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'ass_2', nome: 'Finta', desc: 'Finta √© uma a√ß√£o padr√£o sem custo. Ao utiliz√°-la, o personagem pode gastar sua a√ß√£o de ataque para tentar derrubar ou desarmar o alvo, representando uma manobra t√©cnica executada sem gasto adicional de recursos.', tier: 1 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'ass_3', nome: 'Apunhalar', desc: 'Apunhalar consome 3 pontos de Foco e exige que o usu√°rio esteja em furtividade no momento da ativa√ß√£o. O ataque realizado multiplica o dano causado por 2 vezes e ignora completamente todas as resist√™ncias do alvo. A partir do n√≠vel 8, caso o alvo esteja com 50% ou menos da Vida m√°xima, o multiplicador de dano aumenta para 3 vezes.', tier: 2 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'ass_4', nome: 'Furtividade real', desc: 'Furtividade Real √© uma habilidade passiva sem custo. Enquanto estiver furtivo, o personagem n√£o tem mais sua movimenta√ß√£o reduzida pela metade. A partir do n√≠vel 16, o personagem passa a poder realizar ataques sem perder o estado de furtividade.', tier: 2 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'ass_5', nome: 'Finalizador Sombrio', desc: 'Finalizador Sombrio √© ativado como uma a√ß√£o padr√£o ao custo de 20 pontos de Foco e exige que o personagem tenha causado dano ao alvo na mesma rodada. Caso o dano m√°ximo poss√≠vel da arma utilizada, somado aos b√¥nus aplic√°veis, seja suficiente para reduzir o alvo a zero de Vida, o alvo √© executado instantaneamente, sem necessidade de rolagem adicional. Ap√≥s a execu√ß√£o, o personagem ativa Extin√ß√£o Furtiva, recebendo um b√¥nus de 3 metros de movimento. A partir do n√≠vel 16, executar um alvo com Finalizador Sombrio concede uma a√ß√£o padr√£o extra.', tier: 3 },
                ],

                gladiador: [
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'gla_1', nome: 'C√°lculo exato I', desc: 'C√°lculo Exato √© uma a√ß√£o b√¥nus que custa 5 pontos de Foco e deve ser ativada antes da realiza√ß√£o de um ataque. Ao utilizar essa habilidade, o personagem escolhe um dos dois efeitos a seguir. No Golpe Inevit√°vel, o ataque realizado acerta automaticamente o alvo, ignorando testes de ataque, embora ainda esteja sujeito a efeitos que neguem dano ou anulem o impacto. No Golpe Friamente Calculado, o personagem executa o ataque com precis√£o extrema, rolando dados adicionais de dano equivalentes a +1d10 para cada metade inteira do atributo associado √† arma utilizada (arredondando para baixo). O b√¥nus de dano √© aplicado apenas a esse ataque.', tier: 1 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'gla_2', nome: 'Finta', desc: 'Finta √© uma a√ß√£o padr√£o sem custo. Ao utiliz√°-la, o personagem pode gastar sua a√ß√£o de ataque para tentar derrubar ou desarmar o alvo, representando uma manobra t√©cnica executada sem gasto adicional de recursos.', tier: 1 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'gla_3', nome: 'Berzerk', desc: 'Berzerk √© ativado como uma a√ß√£o b√¥nus ao custo de 4 pontos de Foco, devendo ser usado imediatamente ap√≥s um ataque. Ao entrar em modo Berzerk, o personagem passa a realizar ataques adicionais conforme o est√°gio alcan√ßado. No primeiro est√°gio, √© realizado um ataque causando 50% do dano normal. No segundo est√°gio, s√£o realizados dois ataques, cada um causando 50% do dano. No terceiro est√°gio, o personagem realiza um ataque com 50% do dano e outro com 100% do dano. No quarto est√°gio, s√£o realizados dois ataques com 100% do dano cada. Para manter o quarto est√°gio ativo, √© necess√°rio gastar 1 ponto de Foco por rodada.', tier: 2 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'gla_4', nome: 'Quebracascos', desc: 'Quebracascos pode ser ativada como uma a√ß√£o padr√£o ao custo de 15 pontos de Foco. Essa habilidade s√≥ pode ser utilizada enquanto o personagem estiver no est√°gio final do Berzerk e permite realizar um ataque qu√°druplo em uma √∫nica a√ß√£o.', tier: 2 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'gla_5', nome: 'At√© a morte', desc: 'At√© a Morte √© uma habilidade passiva e n√£o possui custo. Sempre que o personagem sofrer um ataque n√£o massivo que normalmente reduziria sua Vida a 0, deixando-o inconsciente, sua Vida √© reduzida para 1 em vez disso, permitindo que continue lutando normalmente. Caso o personagem receba outro ataque enquanto estiver com 1 ponto de Vida, ele cai inconsciente normalmente.', tier: 3 },
                ],

                charlatao: [
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'cha_1', nome: 'Especialista', desc: 'Especialista √© uma a√ß√£o b√¥nus que custa 4 pontos de Foco. Ao ativar essa habilidade, o personagem recebe +1d10 em qualquer teste √† sua escolha, seja ele ofensivo, defensivo ou utilit√°rio. O b√¥nus √© aplicado a um √∫nico teste e deve ser declarado antes da rolagem.', tier: 1 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'cha_2', nome: 'Finta improvisada', desc: 'Finta Improvisada √© uma a√ß√£o padr√£o que custa 2 pontos de Foco. Ao utiliz√°-la, o personagem substitui sua a√ß√£o de ataque por uma manobra improvisada, podendo tentar derrubar ou desarmar o alvo.', tier: 1 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'cha_3', nome: 'Lingua de prata', desc: 'L√≠ngua de Prata √© ativada como uma a√ß√£o padr√£o ao custo de 4 pontos de Foco por alvo. Ao usar essa habilidade, o alvo torna-se altamente suscet√≠vel ao que est√° sendo dito, interpretando as palavras do usu√°rio de forma favor√°vel. Caso o alvo seja hostil, ambos realizam um teste de Presen√ßa contra Presen√ßa; se o alvo vencer o teste, ele resiste √† t√©cnica e o efeito n√£o √© aplicado.', tier: 2 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'cha_4', nome: 'Marca', desc: 'Marca √© ativada como uma a√ß√£o padr√£o ao custo de 4 pontos de Foco e s√≥ pode ser usada em alvos que estejam sob o efeito de L√≠ngua de Prata. Quando utilizada em um inimigo, todos os ataques direcionados a esse alvo causam 50% a mais de dano enquanto o efeito durar. Quando utilizada em um aliado, todos os inimigos pr√≥ximos s√£o for√ßados a atac√°-lo por at√© 2 rodadas, podendo resistir ao efeito com um teste de Presen√ßa.', tier: 2 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'cha_5', nome: 'Lider t√°tico', desc: 'L√≠der T√°tico √© ativada como uma a√ß√£o padr√£o ao custo de 8 pontos de Foco e s√≥ pode ser usada em alvos afetados por L√≠ngua de Prata, encerrando esse efeito ap√≥s a ativa√ß√£o. Quando utilizada em um inimigo, o usu√°rio pode negar uma a√ß√£o padr√£o do alvo; ao gastar o dobro do custo, √© poss√≠vel negar um turno inteiro. Quando utilizada em um aliado, o usu√°rio pode gastar sua a√ß√£o para ordenar uma a√ß√£o espec√≠fica, concedendo ao aliado uma a√ß√£o extra de sua escolha.', tier: 3 },
                ],

                alquimista: [
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'alq_1', nome: 'Especialista', desc: 'Especialista √© uma a√ß√£o b√¥nus que custa 4 pontos de Foco. Ao ativar essa habilidade, o personagem recebe +1d10 em qualquer teste √† sua escolha, seja ele ofensivo, defensivo ou utilit√°rio. O b√¥nus √© aplicado a um √∫nico teste e deve ser declarado antes da rolagem.', tier: 1 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'alq_2', nome: 'Finta improvisada', desc: 'Finta Improvisada √© uma a√ß√£o padr√£o que custa 2 pontos de Foco. Ao utiliz√°-la, o personagem substitui sua a√ß√£o de ataque por uma manobra improvisada, podendo tentar derrubar ou desarmar o alvo.', tier: 1 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'alq_3', nome: 'M√©dico', desc: 'M√©dico √© ativada como uma a√ß√£o padr√£o ao custo base de 3 pontos de Foco e permite curar um aliado adjacente. A quantidade de cura depende do custo adicional investido: com o custo padr√£o, o alvo recupera 1d4 de Vida; ao dobrar o custo, a cura passa a ser 1d6; com custo triplo, 1d8; e com custo qu√°druplo, 1d10. Al√©m disso, o usu√°rio adiciona um dado extra de cura para cada n√≠vel de personagem, utilizando sempre o tipo de dado correspondente ao custo escolhido (por exemplo, no n√≠vel 9, uma cura padr√£o resultaria em 9d4).', tier: 2 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'alq_4', nome: 'M√£os r√°pidas', desc: 'M√£os R√°pidas √© ativada como uma a√ß√£o b√¥nus ao custo de 1 ponto de Foco. Ao us√°-la, o personagem recebe uma a√ß√£o padr√£o adicional na rodada, por√©m essa a√ß√£o extra deve obrigatoriamente ser utilizada para uma atividade diferente daquela realizada na primeira a√ß√£o padr√£o.', tier: 2 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'alq_5', nome: 'Reanima√ß√£o', desc: 'Reanima√ß√£o √© ativada como uma a√ß√£o padr√£o ao custo de 14 pontos de Foco e permite trazer de volta √† vida um aliado morto em campo de batalha. Para isso, o usu√°rio deve realizar um teste de Medicina com DT 50. Em caso de sucesso, o aliado retorna inconsciente com 1 ponto de Vida, podendo ser acordado com uma a√ß√£o padr√£o. Caso esse aliado volte a ter sua Vida reduzida a 0 novamente, ele morre de forma definitiva, e novas tentativas de Reanima√ß√£o passam a exigir um teste de Medicina com DT 60.', tier: 3 },
                ],

                artifice: [
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'art_1', nome: 'Especialista', desc: 'Especialista √© uma a√ß√£o b√¥nus que custa 4 pontos de Foco. Ao ativar essa habilidade, o personagem recebe +1d10 em qualquer teste √† sua escolha, seja ele ofensivo, defensivo ou utilit√°rio. O b√¥nus √© aplicado a um √∫nico teste e deve ser declarado antes da rolagem.', tier: 1 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'art_2', nome: 'Finta improvisada', desc: 'Finta Improvisada √© uma a√ß√£o padr√£o que custa 2 pontos de Foco. Ao utiliz√°-la, o personagem substitui sua a√ß√£o de ataque por uma manobra improvisada, podendo tentar derrubar ou desarmar o alvo.', tier: 1 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'art_3', nome: 'Aprimorador treinado', desc: 'Torreta de Combate consome o turno completo e custa 8 pontos de Foco. Ao ser ativada, o usu√°rio cria uma torreta aut√¥noma que ataca automaticamente uma vez por rodada o inimigo designado. A Vida da torreta e seu dano s√£o definidos com base no n√≠vel do Art√≠fice. A torreta permanece ativa at√© ser destru√≠da ou desativada voluntariamente.', tier: 2 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'art_4', nome: 'Arpimorador Treinado', desc: 'Aprimorador Treinado √© uma habilidade de interl√∫dio e n√£o possui custo. Durante um interl√∫dio, o personagem pode gastar tempo refinando uma arma ou armadura. A arma aprimorada recebe um b√¥nus de 50% no dano causado, enquanto uma armadura aprimorada concede 50% a mais de resist√™ncia. O efeito dura por uma cena completa de combate.', tier: 2 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'art_5', nome: 'Carga Sublime', desc: 'Carga Sublime √© ativada como uma a√ß√£o padr√£o ao custo de 6 pontos de Foco. O usu√°rio insere um cartucho especial que, ao ser disparado, cria um campo com raio de at√© 8 metros que permanece ativo por 2 rodadas. O campo pode assumir um dos seguintes efeitos: Suporte, concedendo +6 de Defesa aos aliados dentro da √°rea; Conten√ß√£o, impedindo o movimento dos inimigos afetados; ou Sobrecarga, que libera uma onda de choque, podendo ser aplicada em √°rea ou direcionada para um ponto espec√≠fico.', tier: 3 },
                ],

                },
            auras: {
                reforco: [
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'ref_1', nome: 'Parrudo', desc: 'Parrudo √© uma rea√ß√£o que custa 9 pontos de Mana e 3 pontos de Foco. Ao ser ativada, o personagem absorve metade do dano recebido, desde que o ataque n√£o seja capaz de retirar mais da metade de sua Vida m√°xima em um √∫nico golpe. A habilidade evolui conforme o n√≠vel: no n√≠vel 4 o custo passa a 15 Mana e 3 Foco; no n√≠vel 8, 21 Mana e 3 Foco; no n√≠vel 12, 30 Mana e 4 Foco; no n√≠vel 16, 45 Mana e 5 Foco. A partir do n√≠vel 16, Parrudo pode absorver metade do dano de qualquer ataque, independentemente de sua magnitude.', tier: 1 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'ref_2', nome: 'For√ßa M√°xima', desc: 'DFor√ßa M√°xima √© uma a√ß√£o b√¥nus que custa 20 pontos de Mana. Ao ativ√°-la, o personagem converte o dano sofrido na rodada atual em poder ofensivo, adicionando +1d6 de dano ao ataque para cada 10 pontos de dano recebidos na mesma rodada. A habilidade escala com o n√≠vel: no n√≠vel 8 o custo passa a 30 Mana; no n√≠vel 12, 40 Mana; e no n√≠vel 16, 50 Mana.', tier: 2 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'ref_3', nome: 'Coagular', desc: 'Coagular √© uma a√ß√£o padr√£o que custa 30 pontos de Mana e 5 pontos de Foco. Ao utiliz√°-la, o personagem restaura metade da Vida perdida. Para cada ferida recuperada, o custo da habilidade aumenta progressivamente. Caso Coagular seja usada novamente, feridas que j√° tenham sido recuperadas anteriormente n√£o entram no c√°lculo.', tier: 3 },
                ],

                emissao: [
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'emi_1', nome: 'Explos√£o M√°gica', desc: 'Explos√£o M√°gica √© uma a√ß√£o padr√£o que custa 12 pontos de Mana e 1 ponto de Foco. O personagem libera uma explos√£o de energia et√©rea que afeta todas as criaturas em um raio de 3 metros, causando 1d10 de dano et√©reo para cada ponto de Intelecto. A habilidade progride com o n√≠vel: no n√≠vel 4 o raio aumenta para 6 metros; no n√≠vel 8 o dano passa a ser 1d12 por Intelecto; no n√≠vel 12 o raio aumenta para 12 metros; e no n√≠vel 16 o dano passa a ser 1d20 por Intelecto.', tier: 1 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'emi_2', nome: 'Devastar', desc: 'Devastar √© uma a√ß√£o b√¥nus que custa 12 pontos de Mana fixos e 3 pontos de Foco por alvo adicional. Ao ativ√°-la, o personagem pode expandir um ataque corpo a corpo para atingir inimigos adicionais, desde que possua movimento suficiente para alcan√ß√°-los. O ataque progride de alvo em alvo, e o personagem termina a a√ß√£o adjacente ao √∫ltimo inimigo atingido. A progress√£o de custo ocorre no n√≠vel 8 (20 Mana), n√≠vel 12 (28 Mana) e n√≠vel 16 (36 Mana).', tier: 2 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'emi_3', nome: 'Raio m√°gico', desc: 'Raio M√°gico √© uma a√ß√£o padr√£o que custa 30 pontos de Mana e 2 pontos de Foco. O personagem dispara ou invoca um raio inevit√°vel contra um alvo em alcance longo que esteja em sua linha de vis√£o. O raio causa (Intelecto + N√≠vel) / 2 d10 de dano et√©reo e drena Vida, Mana e Foco do alvo atingido.', tier: 3 },
                ],

                transformacao: [
                    {custoMana: 0, custoFoco: 0, custoVida: 0, id: 'tra_1', nome: 'Agilizar Tempo', desc: 'Agilizar Tempo √© usada como uma a√ß√£o b√¥nus ao custo de 12 pontos de Mana. Ao ativ√°-la, o personagem recebe imediatamente uma a√ß√£o de movimento adicional na rodada.', tier: 1 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'tra_2', nome: 'Adrenalina', desc: 'Adrenalina √© uma rea√ß√£o que custa 6 pontos de Mana. Ao utiliz√°-la, o personagem recebe imediatamente uma a√ß√£o de movimento adicional, podendo agir mesmo fora do pr√≥prio turno.', tier: 2 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'tra_3', nome: 'Agilizar Tempo II', desc: 'Agilizar Tempo II √© uma a√ß√£o b√¥nus que custa 15 pontos de Mana. Ao utiliz√°-la, o personagem recebe imediatamente uma a√ß√£o padr√£o adicional na rodada.', tier: 3 },
                ],

                materializacao: [
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'mat_1', nome: 'Arma M√°gica', desc: 'Arma M√°gica √© uma a√ß√£o b√¥nus que custa 14 pontos de Mana. Ao utiliz√°-la, o personagem conjura uma arma que causa dano et√©reo adicional equivalente a 1d8 por ponto de Intelecto. A habilidade evolui conforme o n√≠vel: no n√≠vel 4 o custo passa a 24 Mana e o dano para 1d10 por Intelecto; no n√≠vel 12 o custo passa a 36 Mana e o dano para 1d12 por Intelecto; no n√≠vel 16 o custo passa a 48 Mana e o dano para 1d20 por Intelecto.', tier: 1},
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'mat_2', nome: 'Sutura', desc: 'Sutura √© uma a√ß√£o b√¥nus que custa 8 pontos de Mana e 2 pontos de Foco por ferimento ativo. Ao utiliz√°-la, o personagem causa (Intelecto + N√≠vel) / 2 d10 de dano adicional por ferimento existente no alvo. Ap√≥s a aplica√ß√£o da habilidade, todos os ferimentos s√£o imediatamente fechados. A progress√£o de custo ocorre no n√≠vel 8 (14 Mana), n√≠vel 12 (20 Mana) e n√≠vel 16 (26 Mana).', tier: 2 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'mat_3', nome: 'Familiar', desc: 'Familiar √© conjurado com tempo de um turno e custo de Mana vari√°vel √† escolha do personagem. Ao utiliz√°-la, o personagem invoca um familiar com os mesmos atributos que ele. O dano do familiar √© equivalente ao dano base do conjurador, e sua Vida √© igual √† quantidade de Mana gasta na invoca√ß√£o, podendo o personagem investir quantos pontos desejar.', tier: 3 },
                ],

                manipulacao: [
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'man_1', nome: '√Ås na manga', desc: 'Calmo e Preciso √© ativada como uma a√ß√£o de movimento ao custo de 3 pontos de Foco e deve ser usada antes de um ataque. Ao utiliz√°-la, o personagem sacrifica sua a√ß√£o de movimento para realizar um ataque extremamente preciso; caso o ataque acerte, ele causa automaticamente o dano m√°ximo poss√≠vel. Se o ataque j√° consumir naturalmente a a√ß√£o de movimento, Calmo e Preciso passa a consumir a a√ß√£o da pr√≥xima rodada.', tier: 1 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'man_2', nome: 'Segunda chance', desc: 'Segunda Chance √© uma a√ß√£o b√¥nus que custa 8 pontos de Mana e 2 pontos de Foco. Ao ativ√°-la, o personagem ou um aliado pode rerrolar um teste que tenha falhado, sendo obrigado a aceitar o novo resultado. A habilidade pode ser utilizada mais de uma vez, desde que os custos sejam pagos. O custo de Mana aumenta no n√≠vel 8 (14 Mana), n√≠vel 12 (18 Mana) e n√≠vel 16 (22 Mana).', tier: 2 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'man_3', nome: 'Especializado', desc: 'Especializado √© uma a√ß√£o b√¥nus que custa 25 pontos de Mana e 5 pontos de Foco. Ao ativ√°-la, o personagem pode substituir o atributo normalmente utilizado em um teste por outro de sua prefer√™ncia. A habilidade possui um limite de 2 usos por dia, que aumenta para 4 usos di√°rios no n√≠vel 16, quando o custo passa a ser 40 pontos de Mana.', tier: 3 },
                ],
                    },
            trilhas: {
                envoltura: [
                { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'env_1', nome: 'Troca', desc: 'Troca √© uma a√ß√£o b√¥nus que custa 4 pontos de Mana. Ao utiliz√°-la, o personagem converte energia m√°gica em concentra√ß√£o, gerando 1 ponto de Foco para cada 4 pontos de Mana gastos dessa forma. A convers√£o ocorre imediatamente como parte da a√ß√£o b√¥nus.', tier: 1 },
                { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'env_2', nome: 'Absors√£o Vital', desc: 'Absor√ß√£o Vital √© uma a√ß√£o b√¥nus que custa 20 pontos de Mana e 4 pontos de Foco e deve ser ativada antes de um ataque. Ao utiliz√°-la, o personagem passa a recuperar Vida equivalente a 50% do dano causado pelo ataque. A habilidade evolui conforme o n√≠vel: no n√≠vel 8, o custo passa a 30 Mana e 6 Foco; no n√≠vel 12, o custo passa a 40 Mana e 8 Foco e a recupera√ß√£o aumenta para 75% do dano causado; no n√≠vel 16, o custo passa a 50 Mana e 10 Foco, e o personagem recupera 100% do dano causado como Vida.', tier: 2 },
                { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'env_3', nome: 'Barganha Insana', desc: 'Barganha Insana √© uma a√ß√£o b√¥nus que custa 10% da Mana m√°xima do personagem e 50% de sua Vida atual. Ao utiliz√°-la, o personagem recupera toda a Mana imediatamente, ficando com 90% de sua Mana m√°xima. At√© o fim da cena, sua Mana m√°xima √© reduzida para 90% do valor normal.', tier: 3 },
                ],

                expansao: [
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'exp_1', nome: 'Ripostar', desc: 'Ripostar √© uma rea√ß√£o que inicialmente custa 10 pontos de Mana. Sempre que o personagem consegue evitar completamente um golpe inimigo, ele pode realizar imediatamente um contra-ataque contra o agressor. A habilidade evolui com o n√≠vel: no n√≠vel 4, o custo passa a 15 Mana e o contra-ataque pode ser realizado caso o personagem evite ao menos 75% do dano do ataque; no n√≠vel 8, o custo passa a 20 Mana e o requisito cai para 50% do dano evitado; no n√≠vel 12, o custo passa a 25 Mana e basta evitar 25% do dano; no n√≠vel 16, o custo passa a 30 Mana e o personagem pode sempre contra-atacar ao ser atingido, independentemente da quantidade de dano evitada.', tier: 1 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'exp_2', nome: 'Corre√ß√£o', desc: 'Corre√ß√£o √© uma a√ß√£o b√¥nus que custa 12 pontos de Mana. Ela pode ser usada imediatamente ap√≥s um ataque ou uma defesa para aumentar em +2 o resultado obtido. A habilidade pode ser utilizada m√∫ltiplas vezes, desde que o personagem tenha Mana suficiente para pagar o custo a cada ativa√ß√£o.', tier: 2 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'exp_3', nome: 'Dash', desc: 'Dash √© uma a√ß√£o b√¥nus cujo custo √© de 2 pontos de Mana por metro percorrido. Ao utiliz√°-la, o personagem se teleporta instantaneamente para um ponto vis√≠vel em at√© 8 metros de dist√¢ncia. Essa habilidade tamb√©m pode ser usada como rea√ß√£o ap√≥s qualquer ataque e pode ser combinada com a√ß√µes de furtividade. No n√≠vel 16, a dist√¢ncia m√°xima do teleporte aumenta para 32 metros.', tier: 3 },
                ],

                liberacao: [
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'lib_1', nome: 'Come√ßar com Tudo', desc: 'Come√ßar com Tudo √© uma a√ß√£o b√¥nus que custa 6 pontos de Mana. Ao ativ√°-la, o primeiro ataque bem-sucedido do personagem contra um inimigo causa dano cr√≠tico automaticamente. Caso o ataque j√° resulte em um acerto cr√≠tico natural no dado, o efeito √© transferido para o pr√≥ximo ataque realizado pelo personagem.', tier: 1 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'lib_2', nome: '√Ås na Manga', desc: '√Ås na Manga √© uma a√ß√£o padr√£o com custo cont√≠nuo de 2 pontos de Mana por rodada. Enquanto a habilidade estiver ativa, o personagem passa a gerar 1 ponto de Foco sempre que utiliza uma a√ß√£o padr√£o. Ao gastar 1 ponto adicional de Mana na mesma rodada, esse ganho aumenta para 2 pontos de Foco. Enquanto √Ås na Manga estiver ativa, o personagem ignora os efeitos de Exaust√£o. A habilidade escala com o n√≠vel: no n√≠vel 8, tanto o custo quanto os b√¥nus s√£o dobrados; no n√≠vel 12, s√£o triplicados; e no n√≠vel 16, s√£o quadruplicados.', tier: 2 },
                    { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'lib_3', nome: 'Respiro', desc: 'Respiro √© uma a√ß√£o b√¥nus que custa 25 pontos de Mana e deve ser utilizada antes de um ataque. Ao ativ√°-la, o personagem entra no estado de Transcendido por at√© 3 rodadas. Caso deseje encerrar esse estado antes do tempo, o personagem pode gastar 10 pontos adicionais de Mana como a√ß√£o b√¥nus para retornar ao normal.', tier: 3 },
                ],
            }
        };

        const gruposDeClasse = {
            arcanista: ["mago_elemental", "mistico", "mago_de_fronte", "fimbulwinter", "feengari", "ascendente"],
            combatente: ["espadachim", "arma_de_corda", "nordico", "lanceiro"],
            especialista: ["atirador_de_elite", "assassino", "gladiador", "charlatao", "alquimista", "artifice"]
        };

        const dadosAfinidade = {
            auras: {
                reforco: {id:"afin-ref", nome: "Mestre da Fortitude", desc: "Aumenta o multiplicador de vida por n√≠vel." },
                emissao: {id:"afin-emi", nome: "Canalizador Puro", desc: "Aumenta o multiplicador de Mana por n√≠vel." },
                transformacao: {id:"afin-tra", nome: "Passo Flu√≠do", desc: "Aumenta o multiplicador de Movimento por n√≠vel." },
                materializacao: {id:"afin-mat", nome: "Centro Mental", desc: "Aumenta o multiplicador de Foco por n√≠vel." },
                manipulacao: {id:"afin-man", nome: "Harmonia Elementar", desc: "Aumenta levemente todos os multiplicadores principais." },
            },
        grupos_classes: {
                arcanista: {id:"afin-arc", nome: "Despertar Arcano", desc: "Ganha magias extras e reduz o tempo da primeira conjura√ß√£o." },
                combatente: {id:"afin-com", nome: "Veterano de Batalha", desc: "Sua defesa decai menos a cada ataque recebido." },
                especialista: {id:"afin-esp", nome: "Perito Especial", desc: "Concede dados de vantagem em testes n√£o ofensivos." }
            },
            trilhas: {
                envoltura: {id:"afin-env", nome: "Fluxo Eficiente", desc: "Reduz o gasto de Mana passiva." },
                expansao: {id:"afin-exp", nome: "Juggernaut", desc: "Aumenta a Classe de Armadura." },
                liberacao: {id:"afin-lib", nome: "Arsenal Expandido", desc: "Permite carregar mais utilit√°rios na bolsa." }
            }
        };

        // --- NOVOS DADOS: MAGIAS ---
        // Para colocar uma informacao do tipo TOOLTIPS basta seguir esse padrao: (...)<span class="termo-destaque" data-tooltip="Lorem\n->esse sinal serve para pular linha\ndigite o que quiser">Valor que aparece na caixa e que possui a interacao</span>(...)
        const dadosMagias = {
            genericas: [
                { custoMana: (n, a) => 4 + Math.floor((n+a.intelecto)*2), custoFoco: 0, custoVida: 0, id: 'mag_ar_1', tier: 1, nome: 'Manipula√ß√£o Cin√©tica', desc: 'Permite controlar o movimento por energia cin√©tica, empurrando, puxando ou levitando objetos e criaturas leves ou m√©dias dentro de alcance m√©dio, al√©m de possibilitar a autolevita√ß√£o. Alvos resistentes podem resistir com for√ßa. Gasta pouca mana.<span class="termo-destaque" data-tooltip="Custo: 4 + (2 √ó MP) mana\nCanaliza√ß√£o: a√ß√£o padr√£o\nAlcance: (10 + MP) m\nAlvos: objetos ou criaturas leves ou m√©dias; pode afetar o pr√≥prio conjurador\n√Årea: alvo √∫nico\nEfeito: empurra, puxa ou levita o alvo\nDeslocamento: at√© (5 + MP) m em qualquer dire√ß√£o v√°lida\nResist√™ncia: criaturas podem fazer Teste de For√ßa contra DT (5 + MP) para evitar o deslocamento\nObserva√ß√µes: n√£o causa dano direto; objetos n√£o realizam teste; n√£o permite esmagamento para causar dano\n">Informa√ß√µes Detalhadas</span>' },

                { custoMana: (n, a) => 4 + Math.floor((n+a.intelecto)*2), custoFoco: 0, custoVida: 0,  id: 'mag_terra_1', tier: 1, nome: 'Bala de Pedra', desc: 'Comprime e dispara uma pedra em alta velocidade contra um √∫nico alvo, causando dano contundente e perfurante ao impacto. Gasta uma quantidade pequena de mana e funciona a longo alcance.<span class="termo-destaque" data-tooltip="Custo: 4 + (2 √ó MP) mana\nCanaliza√ß√£o: a√ß√£o padr√£o\nAlcance: longo (35 m)\nAlvos: √∫nico\n√Årea: nenhuma\nTipo de dano: f√≠sico\nDano: (MP / 2,5) d10\nObserva√ß√µes: requer linha de vis√£o; conta como ataque m√°gico √† dist√¢ncia\n">Informa√ß√µes Detalhadas</span>' },

                { custoMana: (n, a) => 4 + Math.floor((n+a.intelecto)*2), custoFoco: 0, custoVida: 0,  id: 'mag_fogo_1', tier: 1, nome: 'Bola de Fogo', desc: 'Dispara uma esfera √≠gnea que causa dano de fogo ao atingir o alvo e o deixa Incendiado. Requer uma quantidade moderada de mana e tem alcance m√©dio.<span class="termo-destaque" data-tooltip="Custo: 4 + (2 √ó MP) mana\nCanaliza√ß√£o: a√ß√£o padr√£o\nAlcance: m√©dio (15 m)\nAlvo: √∫nico\nDano: fogo\nEfeito: [MP/2,8 d10] de dano\nAplica Incendiado">Informa√ß√µes Detalhadas</span>' },

                { custoMana: (n, a) => 4 + Math.floor((n+a.intelecto)*2), custoFoco: 0, custoVida: 0,  id: 'mag_agua_1', tier: 1, nome: `Cria√ß√£o d'√°gua`, desc: 'Gera um bols√£o de √°gua que pode ser manipulado √† dist√¢ncia. As magias subsequentes de √°gua consomem o conte√∫do do bols√£o. Gasta uma quantidade pequena de mana e o alcance √© m√©dio.<span class="termo-destaque" data-tooltip="Custo: 4 + (2 √ó MP) mana\nCanaliza√ß√£o: a√ß√£o padr√£o\nAlcance: [12 + (MP √ó 2)] m\nEfeito: gera 6 Unidades de √Ågua\nBols√£o √© origem de magias de √°gua">Informa√ß√µes Detalhadas</span>' },
                


                { custoMana: (n, a) => 20 + Math.floor((n+a.intelecto)*1.3), custoFoco: 0, custoVida: 0,  id: 'mag_ar_2', tier: 2, nome: 'Corte de Ar', desc: 'Lan√ßa uma l√¢mina invis√≠vel de ar comprimido em linha reta, atingindo alvos em alcance m√©dio. Causa dano cortante √† dist√¢ncia e pode impedir a rea√ß√£o imediata do alvo. Gasta mana moderada.<span class="termo-destaque" data-tooltip="Custo: 20 + (MP √ó 1,3) mana\nCanaliza√ß√£o: 1 turno\nAlcance: m√©dio (15 m)\n√Årea: linha reta at√© o limite do alcance\nTipo de dano: f√≠sico\nDano: (MP / 2) d10\nEfeito adicional: alvo deve realizar Teste de Presen√ßa (DT 15)\nFalha no teste: alvo n√£o pode reagir ao primeiro ataque recebido at√© o in√≠cio do pr√≥ximo turno\nObserva√ß√µes: atinge o primeiro alvo na linha; n√£o atravessa obst√°culos s√≥lidos\n">Informa√ß√µes Detalhadas</span>' },

                { custoMana: (n, a) => 20 + Math.floor((n+a.intelecto)*1.3), custoFoco: 0, custoVida: 0, id: 'mag_terra_2', tier: 2, nome: 'Estalagmite', desc: 'Faz surgir uma lan√ßa de pedra do solo, causando dano em √°rea ao emergir. Gasta uma quantidade moderada de mana e tem alcance m√©dio.<span class="termo-destaque" data-tooltip="Custo: 20 + (MP √ó 1,3) mana\nCanaliza√ß√£o: 1 turno\nAlcance: m√©dio (15 m)\n√Årea: raio de 2 m a partir do ponto escolhido\nTipo de dano: f√≠sico\nDano: (MP / 1,8) d10\nObserva√ß√µes: requer solo ou superf√≠cie compat√≠vel; criaturas a√©reas n√£o s√£o afetadas\n">Informa√ß√µes Detalhadas</span>' },

                { custoMana: (n, a) => 20 + Math.floor((n+a.intelecto)*1.3), custoFoco: 0, custoVida: 0, id: 'mag_fogo_2', tier: 2, nome: 'Labareda', desc: 'Uma coluna de fogo irrompe do solo, causando dano de fogo e deixando os alvos incendiados. Gasta uma quantidade moderada de mana e tem alcance m√©dio.<span class="termo-destaque" data-tooltip="A√ß√£o: turno\nCusto: 20 + (MP √ó 1,3) mana\nCanaliza√ß√£o: 1 turno\nAlcance: m√©dio (15 m)\n√Årea: raio de 3 m\nDano: fogo\nEfeito: [MP/2 d10] de dano\nAplica Incendiado">Informa√ß√µes Detalhadas</span>' },

                { custoMana: (n, a) => 20 + Math.floor((n+a.intelecto)*1.3), custoFoco: 0, custoVida: 0, id: 'mag_agua_2', tier: 2, nome: `Chicote d'√°gua`, desc: 'Dispara um golpe r√°pido de √°gua que causa dano em um alvo em alcance curto. Gasta uma quantidade moderada de mana e consome unidades de √°gua do bols√£o.<span class="termo-destaque" data-tooltip="A√ß√£o: turno\nCusto: 20 + (MP √ó 1,3) mana\nCusto adicional: 2 Unidades de √Ågua\nCanaliza√ß√£o: 1 turno\nAlcance: curto (5 m)\nAlvo: √∫nico\nDano: f√≠sico\nEfeito: [MP/1,8 d10] de dano">Informa√ß√µes Detalhadas</span>' },
                


                { custoMana: (n, a) => 35 + Math.floor((n+a.intelecto)*1.11), custoFoco: 0, custoVida: 0, id: 'mag_ar_3', tier: 3, nome: 'Vento Dual', desc: 'Cria v√≥rtices de ar opostos que puxam ou empurram criaturas dentro de uma √°rea. O conjurador define a dire√ß√£o do deslocamento, e alvos mais fortes podem resistir. Gasta muita mana.<span class="termo-destaque" data-tooltip="Custo: 35 + (MP √ó 1,11) mana\nCanaliza√ß√£o: 1 turno + a√ß√£o padr√£o\nAlcance: (12 + MP √ó 3) m\n√Årea: √°rea circular definida pelo conjurador\nEfeito: deslocamento for√ßado (puxar ou empurrar)\nDeslocamento: entre (4 + MP) e (6 + MP √ó 1,5) m\nResist√™ncia: Teste de For√ßa contra DT (5 + MP √ó 1,3)\nObserva√ß√µes: n√£o causa dano; conjurador escolhe a dire√ß√£o do deslocamento\n">Informa√ß√µes Detalhadas</span>' },

                { custoMana: (n, a) => 35 + Math.floor((n+a.intelecto)*1.11), custoFoco: 0, custoVida: 0, id: 'mag_terra_3', tier: 3, nome: 'Imobiliza√ß√£o', desc: 'Faz o solo agarrar um alvo, imobilizando-o por v√°rios turnos. O alvo pode tentar se libertar, sofrendo dano se falhar. Gasta uma quantidade significativa de mana e tem alcance m√©dio.<span class="termo-destaque" data-tooltip="Custo: 35 + (MP √ó 1,11) mana\nCanaliza√ß√£o: 1 turno + a√ß√£o padr√£o\nAlcance: m√©dio (15 m)\nAlvos: √∫nico\nDura√ß√£o m√°xima: at√© 3 turnos\nTipo de dano: f√≠sico (esmagamento)\nResist√™ncia: Teste de For√ßa contra DT (10 + MP √ó 1,5)\nFalha no teste: alvo permanece imobilizado e sofre (MP / 3,5) d10 de dano\nTentativas subsequentes: DT reduzida em 10 a cada tentativa\nIntera√ß√£o: aliados podem ajudar na libera√ß√£o\nObserva√ß√µes: requer contato com o solo; criaturas a√©reas ou incorp√≥reas s√£o imunes\n">Informa√ß√µes Detalhadas</span>' },

                { custoMana: (n, a) => 35 + Math.floor((n+a.intelecto)*1.11), custoFoco: 0, custoVida: 0, id: 'mag_fogo_3', tier: 3, nome: 'Parede de Fogo', desc: 'Ergue uma parede de fogo que bloqueia proj√©teis e causa dano de fogo a quem atravessar ou permanecer pr√≥xima. Gasta uma quantidade significativa de mana e tem alcance m√©dio.<span class="termo-destaque" data-tooltip="Custo: 35 + (MP √ó 1,11) mana\nCanaliza√ß√£o: 1 turno + a√ß√£o padr√£o\nAlcance: m√©dio (15 m)\n√Årea: [5 + MP] m √ó 3 m\nDura√ß√£o: at√© 4 turnos\nDano: fogo\nEfeito: atravessar causa [MP/2 d12]\nAdjacente causa [MP/1,4 d12]\nAplica Incendiado\nBloqueia vis√£o">Informa√ß√µes Detalhadas</span>' },

                { custoMana: (n, a) => 35 + Math.floor((n+a.intelecto)*1.11), custoFoco: 0, custoVida: 0, id: 'mag_agua_3', tier: 3, nome: 'Nuvem de Vapor', desc: 'Cria uma √°rea de vapor denso, permitindo lan√ßar magias de √°gua de qualquer ponto dentro da √°rea. Gasta uma quantidade significativa de mana e consome unidades de √°gua do bols√£o.<span class="termo-destaque" data-tooltip="Custo: 35 + (MP √ó 1,11) mana\nCusto adicional: 6 Unidades de √Ågua\nCanaliza√ß√£o: 1 turno + a√ß√£o padr√£o\n√Årea: raio de 6 m\nDura√ß√£o: enquanto houver vapor\nEfeito: magias podem partir da √°rea\nConsome vapor ao conjurar">Informa√ß√µes Detalhadas</span>' },


                
                { custoMana: (n, a) => 60 + Math.floor((n+a.intelecto)/2), custoFoco: 0, custoVida: 0, id: 'mag_ar_4', tier: 4, nome: 'Velocidade M√°xima', desc: 'Concede a si mesmo ou a um aliado em alcance curto um grande aumento de velocidade e esquiva por alguns turnos. Gasta muita mana.<span class="termo-destaque" data-tooltip="Custo: 60 + (MP / 2) mana\nCanaliza√ß√£o: 2 turnos\nAlcance: curto (5 m)\nAlvos: si mesmo ou um aliado\nDura√ß√£o: (MP / 4) turnos\nEfeito: +50% em velocidade de movimento e esquiva\nObserva√ß√µes: n√£o acumula com outros efeitos de velocidade; termina se o alvo ficar inconsciente\n">Informa√ß√µes Detalhadas</span>' },

                { custoMana: (n, a) => 60 + Math.floor((n+a.intelecto)/2), custoFoco: 0, custoVida: 0, id: 'mag_terra_4', tier: 4, nome: 'Nuvem de Fuma√ßa', desc: 'Cria uma nuvem de fuma√ßa que reduz a vis√£o e torna os ataques √† dist√¢ncia mais dif√≠ceis. Gasta uma grande quantidade de mana e tem alcance m√©dio.<span class="termo-destaque" data-tooltip="Custo: 60 + (MP / 2) mana\nCanaliza√ß√£o: 2 turnos\nAlcance: (MP) m\n√Årea: raio de (MP / 3) m\nDura√ß√£o: 3 turnos\nEfeito: vis√£o severamente reduzida dentro da √°rea\nPenalidades: desvantagem em Percep√ß√£o visual\nAtaques √† dist√¢ncia: falham automaticamente se atravessarem a fuma√ßa\nB√¥nus: testes de Furtividade dentro da √°rea t√™m vantagem\nObserva√ß√µes: n√£o impede movimento; pode ser dispersada por ventos fortes\n">Informa√ß√µes Detalhadas</span>' },

                { custoMana: (n, a) => 60 + Math.floor((n+a.intelecto)/2), custoFoco: 0, custoVida: 0, id: 'mag_fogo_4', tier: 4, nome: 'Imbuir', desc: 'Encanta uma arma corpo a corpo, fazendo com que cause dano adicional de fogo em cada golpe. Gasta uma grande quantidade de mana e tem alcance curto.<span class="termo-destaque" data-tooltip="Custo: 60 + (MP / 2) mana\nCanaliza√ß√£o: 2 turnos\nAlcance: toque\nDura√ß√£o: [MP/3] turnos\nDano adicional: fogo\nEfeito: +[MP/4 d12] por ataque\nN√£o acumula">Informa√ß√µes Detalhadas</span>' },

                { custoMana: (n, a) => 60 + Math.floor((n+a.intelecto)/2), custoFoco: 0, custoVida: 0, id: 'mag_agua_4', tier: 4, nome: 'Corte de √Ågua', desc: 'Projeta uma l√¢mina de √°gua de alta press√£o que causa dano em um √∫nico alvo ou em uma √°rea em cone. Gasta uma quantidade grande de mana e consome unidades de √°gua do bols√£o.<span class="termo-destaque" data-tooltip="Custo: 60 + (MP / 2) mana\nCusto adicional: 4 Unidades de √Ågua\nCanaliza√ß√£o: 2 turnos\nAlcance: m√©dio (15 m)\nForma: alvo √∫nico ou cone\nDano: f√≠sico\nEfeito: [MP/1,3 d12] de dano">Informa√ß√µes Detalhadas</span>' },
            


                { custoMana: (n, a) => 120 + Math.floor((n+a.intelecto)/5), custoFoco: 0, custoVida: 0, id: 'mag_ar_5', tier: 5, nome: 'Barreira de Ar', desc: 'Ergue uma parede de vento que bloqueia proj√©teis vindos de fora, permitindo ataques de dentro para fora. Permanece por v√°rias rodadas e tem grande extens√£o. Gasta uma quantidade extrema de mana.<span class="termo-destaque" data-tooltip="Custo: 120 + (MP / 5) mana\nCanaliza√ß√£o: 3 turnos\nAlcance: m√©dio (15 m)\nDura√ß√£o: (MP / 2) rodadas\nDimens√µes: comprimento m√°ximo de (5 + MP) m\nEfeito: bloqueia proj√©teis vindos de fora\nIntera√ß√£o: ataques disparados de dentro atravessam livremente\nObserva√ß√µes: n√£o bloqueia vis√£o; criaturas podem atravessar a barreira\n">Informa√ß√µes Detalhadas</span>' },  

                { custoMana: (n, a) => 120 + Math.floor((n+a.intelecto)/5), custoFoco: 0, custoVida: 0, id: 'mag_terra_5', tier: 5, nome: 'Terremoto', desc: 'Faz o solo tremer, derrubando criaturas e afetando estruturas pr√≥ximas. Gasta uma quantidade massiva de mana e tem alcance grande, afetando uma vasta √°rea.<span class="termo-destaque" data-tooltip="Custo: 120 + (MP / 5) mana\nCanaliza√ß√£o: 3 turnos\n√Årea: raio de at√© (MP √ó 5) m\nResist√™ncia: Teste de For√ßa contra DT (4 √ó MP)\nFalha no teste: criatura fica derrubada e desarmada\nEfeito adicional: estruturas pr√≥ximas sofrem dano de soterramento conforme o porte\nObserva√ß√µes: n√£o afeta criaturas voadoras; pode causar colapso estrutural\n">Informa√ß√µes Detalhadas</span>' },

                { custoMana: (n, a) => 120 + Math.floor((n+a.intelecto)/5), custoFoco: 0, custoVida: 0, id: 'mag_fogo_5', tier: 5, nome: 'Chama Incans√°vel', desc: 'Reativa queimaduras causadas anteriormente, causando dano adicional e renovando o efeito de queimadura. Gasta uma quantidade massiva de mana e tem alcance m√©dio.<span class="termo-destaque" data-tooltip="Custo: 120 + (MP / 5) mana\nCanaliza√ß√£o: 3 turnos\nAlvo: inimigo incendiado por voc√™\nDano: fogo\nEfeito: [MP/2 d20] imediato\nRenova Incendiado (2 turnos)">Informa√ß√µes Detalhadas</span>' },

                { custoMana: (n, a) => 120 + Math.floor((n+a.intelecto)/5), custoFoco: 0, custoVida: 0, id: 'mag_agua_5', tier: 5, nome: 'Pris√£o Aqu√°tica', desc: 'Cria um domo de √°gua que bloqueia a vis√£o e proj√©teis. Gasta uma quantidade massiva de mana e consome unidades de √°gua do bols√£o.<span class="termo-destaque" data-tooltip="Custo: 120 + (MP / 5) mana\nCusto adicional: 6 Unidades de √Ågua\nCanaliza√ß√£o: 3 turnos\nAlcance: m√©dio (15 m)\n√Årea: domo (3 m raio)\nDura√ß√£o: [MP/2] turnos\nEfeito: bloqueia proj√©teis e vis√£o\nTeste Vigor [DT 15 + MP √ó 1,5] para escapar\nFalha aplica Afogando">Informa√ß√µes Detalhadas</span>' },
            ],
            fimbulwinter: [
                { custoMana: (n, a) => 4 + Math.floor((n+a.intelecto)*2), custoFoco: 0, custoVida: 0, id: 'fim_1', tier: 1, nome: 'Globo de Neve', desc: 'Congela uma grande √°rea do terreno, transformando o local em um campo permanentemente gelado enquanto o efeito durar. Dentro do Globo de Neve, todas as magias do Fimbulwinter exigem significativamente menos mana para serem conjuradas. Gasta uma quantidade moderada de mana.<span class="termo-destaque" data-tooltip="Custo: 4 + (2 √ó MP) mana\nCanaliza√ß√£o: a√ß√£o padr√£o\n√Årea: raio de [5 + MP] m\nDura√ß√£o: enquanto o Fimbulwinter permanecer\nEfeito: terreno congelado\nMagias Fimbulwinter custam metade">Informa√ß√µes Detalhadas</span>' },
                { custoMana: (n, a) => 4 + Math.floor((n+a.intelecto)*2), custoFoco: 0, custoVida: 0, id: 'fim_2', tier: 1, nome: 'L√¢mina de Gelo', desc: 'Cria v√°rias l√¢minas afiadas de gelo que podem ser atiradas rapidamente. As l√¢minas podem atingir um √∫nico alvo ou serem distribu√≠das entre v√°rios inimigos, causando dano cortante a cada impacto. Gasta uma quantidade pequena de mana e funciona a curto ou m√©dio alcance.<span class="termo-destaque" data-tooltip="Custo: 4 + (2 √ó MP) mana\nCanaliza√ß√£o: a√ß√£o padr√£o\nAlcance: m√©dio (15 m)\nAlvos: at√© 5\nDano: gelo\nEfeito: [MP/3,5 d10] por l√¢mina">Informa√ß√µes Detalhadas</span>' },
                { custoMana: (n, a) => 20 + Math.floor((n+a.intelecto)*1.3), custoFoco: 0, custoVida: 0, id: 'fim_3', tier: 2, nome: 'Resfriar', desc: 'Imbu√≠ um item adjacente com frio extremo. Criaturas que n√£o dominam o poder do Fimbulwinter sofrem dano cont√≠nuo ao utilizar o item e t√™m grande dificuldade em executar a√ß√µes enquanto o efeito persistir. Gasta uma quantidade moderada de mana e exige contato pr√≥ximo.<span class="termo-destaque" data-tooltip="Custo: 20 + (MP √ó 1,3) mana\nCanaliza√ß√£o: 1 turno\nAlcance: curto (5 m)\nAlvo: item equipado\nDano: gelo\nEfeito: usu√°rio n√£o-Fimbulwinter sofre [MP/3 d10]/rodada (m√°x. 3)\n‚Äì2 dados em a√ß√µes">Informa√ß√µes Detalhadas</span>' },
                { custoMana: (n, a) => 35 + Math.floor((n+a.intelecto)*1.11), custoFoco: 0, custoVida: 0, id: 'fim_4', tier: 3, nome: 'Prender no Gelo', desc: 'Ap√≥s um inimigo ser afetado por uma magia de Fimbulwinter, voc√™ tenta congel√°-lo parcialmente. O frio reduz progressivamente sua capacidade de agir, podendo lev√°-lo √† completa imobiliza√ß√£o caso permane√ßa preso por tempo prolongado. O alvo pode tentar resistir ou receber ajuda de aliados para se libertar. Gasta uma quantidade significativa de mana e funciona a m√©dio alcance.<span class="termo-destaque" data-tooltip="Custo: 35 + (MP √ó 1,11) mana\nCanaliza√ß√£o: 1 turno + a√ß√£o padr√£o\nAlcance: m√©dio (15 m)\nPr√©-requisito: alvo atingido por magia Fimbulwinter\nResist√™ncia: For√ßa [DT 10 + MP √ó 1,5]\nEfeito: falha 1 perde Movimento\nFalha 2 perde Turno\nDT ‚Äì10 por tentativa">Informa√ß√µes Detalhadas</span>' },
                { custoMana: (n, a) => 35 + Math.floor((n+a.intelecto)*1.11), custoFoco: 0, custoVida: 0, id: 'fim_5', tier: 3, nome: 'Restaura√ß√£o G√©lida', desc: 'Utiliza o frio para selar ferimentos, interromper sangramentos e reduzir inflama√ß√µes, restaurando parte da vitalidade do usu√°rio. N√£o pode ser utilizada se o conjurador estiver inconsciente ou √† beira da morte. Gasta uma quantidade significativa de mana e afeta apenas o pr√≥prio usu√°rio.<span class="termo-destaque" data-tooltip="A√ß√£o: turno + a√ß√£o padr√£o\nCusto: 35 + (MP √ó 1,11) mana\nCanaliza√ß√£o: 1 turno\nAlvo: si mesmo\nCura: [MP/3 d12]\nRestri√ß√£o: n√£o funciona a 0 de Vida">Informa√ß√µes Detalhadas</span>' },
                { custoMana: (n, a) => 60 + Math.floor((n+a.intelecto)/2), custoFoco: 0, custoVida: 0, id: 'fim_6', tier: 4, nome: 'Raio de Gelo', desc: 'Dispara um feixe concentrado de energia g√©lida em alcance longo, causando dano elevado e congelamento interno. Se o alvo estiver dentro de um Globo de Neve, o efeito √© intensificado, causando mais dano e prejudicando temporariamente suas a√ß√µes. Gasta uma quantidade grande de mana.<span class="termo-destaque" data-tooltip="Custo: 60 + (MP / 2) mana\nCanaliza√ß√£o: 2 turnos\nAlcance: longo (35 m)\nDano: gelo\nEfeito: [MP/1,4 d12]\nNo Globo: [MP/1,1 d12]\n‚Äì1 dado por 2 rodadas">Informa√ß√µes Detalhadas</span>' },
                { custoMana: (n, a) => 60 + Math.floor((n+a.intelecto)/2), custoFoco: 0, custoVida: 0, id: 'fim_7', tier: 4, nome: 'Veneno Glacial', desc: 'Cria uma n√©voa quase invis√≠vel de frio extremo em uma grande √°rea. Criaturas que inalarem o vapor sofrem congelamento interno e dano cont√≠nuo. Exposi√ß√£o repetida reduz drasticamente a capacidade de movimento dos alvos. Gasta uma quantidade grande de mana e permanece ativa por v√°rios turnos.<span class="termo-destaque" data-tooltip="Custo: 60 + (MP / 2) mana\nCanaliza√ß√£o: 2 turnos\n√Årea: at√© √°rea do Globo de Neve\nResist√™ncia: Vigor [DT 15 + MP]\nDano: gelo\nEfeito: [MP/1,4 d10]\n2 rodadas reduzem Movimento pela metade">Informa√ß√µes Detalhadas</span>' },
                { custoMana: (n, a) => 120 + Math.floor((n+a.intelecto)/5), custoFoco: 0, custoVida: 0, id: 'fim_8', tier: 5, nome: 'Clone de Gelo', desc: 'Dano perfurante.Cria um clone id√™ntico ao conjurador feito de gelo s√≥lido. O clone possui suas pr√≥prias a√ß√µes e pode usar as mesmas habilidades do original, mas se desfaz ap√≥s sofrer alguns golpes. Ele s√≥ pode existir dentro de um Globo de Neve. Gasta uma quantidade massiva de mana e dura alguns turnos.<span class="termo-destaque" data-tooltip="Custo: 120 + (MP / 5) mana\nCanaliza√ß√£o: 3 turnos\nDura√ß√£o: [MP/3] rodadas\nPV do clone: 3 golpes\nRestri√ß√£o: n√£o sai do Globo\nEfeito: age em rodada pr√≥pria">Informa√ß√µes Detalhadas</span>' },
            ],
            feengari: [
                { custoMana: (n, a) => 4 + Math.floor((n+a.intelecto)*2), custoFoco: 0, custoVida: 0, id: 'fee_1', tier: 1, nome: 'Alma Sombria', desc: 'Dispara um proj√©til et√©reo em linha reta que atravessa o ar como uma sombra condensada, atingindo um alvo em alcance m√©dio e causando dano et√©reo direto. Gasta uma quantidade pequena de mana e √© uma magia ofensiva simples e confi√°vel. Nos n√≠veis altos possui uma vers√£o especial.<span class="termo-destaque" data-tooltip="Custo: 4 + (2 √ó MP) mana\nCanaliza√ß√£o: a√ß√£o padr√£o\nAlcance: m√©dio (15 m)\nForma: linha reta\nDano: et√©reo\nEfeito: [MP/2,5 d10]">Informa√ß√µes Detalhadas</span>' },
                { custoMana: (n, a) => 20 + Math.floor((n+a.intelecto)*1.3), custoFoco: 0, custoVida: 0, id: 'fee_2', tier: 2, nome: 'Escurid√£o Descendente', desc: 'O conjurador se projeta rapidamente atrav√©s das sombras em um deslocamento curto, surgindo em outro ponto e liberando uma onda de energia sombria no local de chegada. O impacto causa dano sombrio em uma pequena √°rea ao redor. Gasta uma quantidade moderada de mana e combina mobilidade com dano.<span class="termo-destaque" data-tooltip="Custo: 20 + (MP √ó 1,3) mana\nCanaliza√ß√£o: 1 turno\nMovimento: dash curto (5 m)\n√Årea: pequena ao redor do impacto\nDano: sombrio\nEfeito: [MP/2 d10]">Informa√ß√µes Detalhadas</span>' },
                { custoMana: (n, a) => 20 + Math.floor((n+a.intelecto)*1.3), custoFoco: 0, custoVida: 0, id: 'fee_3', tier: 2, nome: 'Caminhar das Sombras', desc: 'Permite ao conjurador se teleportar instantaneamente para qualquer regi√£o sem luz dentro de um grande alcance. O deslocamento √© silencioso e n√£o quebra furtividade. Gasta mana moderada e exige que o destino esteja envolto em sombras ou escurid√£o total.<span class="termo-destaque" data-tooltip="Custo: 20 + (MP √ó 1,3) mana\nCanaliza√ß√£o: 1 turno\nAlcance: [10 + (MP √ó 2)] m\nRestri√ß√£o: √°rea sem luz\nEfeito: teleporte sem quebrar furtividade">Informa√ß√µes Detalhadas</span>' },
                { custoMana: (n, a) => 35 + Math.floor((n+a.intelecto)*1.11), custoFoco: 0, custoVida: 0, id: 'fee_4', tier: 3, nome: 'Dan√ßa da Penumbra', desc: 'O corpo do conjurador se dissolve parcialmente nas sombras, tornando-se invis√≠vel por alguns turnos. A invisibilidade pode ser quebrada caso algu√©m perceba sua presen√ßa com aten√ß√£o extrema. Qualquer ataque realizado encerra o efeito imediatamente. Gasta uma quantidade significativa de mana e √© ideal para infiltra√ß√£o ou reposicionamento.<span class="termo-destaque" data-tooltip="Custo: 35 + (MP √ó 1,11) mana\nCanaliza√ß√£o: 1 turno + a√ß√£o padr√£o\nDura√ß√£o: ~[MP/4] rodadas\nEfeito: invisibilidade\nRevela√ß√£o: Presen√ßa [DT 12 + Mod. Aura]\nAtacar encerra">Informa√ß√µes Detalhadas</span>' },
                { custoMana: (n, a) => 35 + Math.floor((n+a.intelecto)*1.11), custoFoco: 0, custoVida: 0, id: 'fee_5', tier: 3, nome: 'Sombra Viva', desc: 'Cria uma sombra aut√¥noma ligada √† vontade do conjurador. Ela se move livremente em curto alcance, mas n√£o ataca nem interage fisicamente com o ambiente. A sombra se dissipa ao ser atingida. Pode servir como ponto de origem para Caminhar das Sombras, permitindo conjurar ambas as magias em uma √∫nica a√ß√£o prolongada. Gasta uma quantidade significativa de mana. Nos n√≠veis altos possui uma vers√£o especial.<span class="termo-destaque" data-tooltip="Custo: 35 + (MP √ó 1,11) mana\nCanaliza√ß√£o: 1 turno + a√ß√£o padr√£o\nAlcance: curto (5 m)\nPV: 1\nEfeito: ponto v√°lido para Caminhar das Sombras">Informa√ß√µes Detalhadas</span>' },
                { custoMana: 0, custoFoco: 0, custoVida: 0, id: 'fee_6', tier: 4, nome: 'Murm√∫rios do Vazio', desc: 'Sussurros et√©reos invadem a mente de um alvo em alcance m√©dio, distorcendo percep√ß√µes, emo√ß√µes ou implantando mem√≥rias falsas. O efeito pode durar v√°rios turnos dependendo da resist√™ncia mental do alvo. Aliados podem ajudar a v√≠tima a romper a influ√™ncia sombria. Gasta muita mana e exige concentra√ß√£o.<span class="termo-destaque" data-tooltip="Custo: 60 + (MP / 2) mana\nCanaliza√ß√£o: 2 turnos + a√ß√£o padr√£o\nAlcance: m√©dio (15 m)\nResist√™ncia: Presen√ßa [DT 15 + MP]\nDura√ß√£o: 2 a 4 rodadas conforme falha">Informa√ß√µes Detalhadas</span>' },
                { custoMana: (n, a) => 60 + Math.floor((n+a.intelecto)/2), custoFoco: 0, custoVida: 0, id: 'fee_7', tier: 4, nome: 'Sil√™ncio Sombrio', desc: 'Cria uma zona de escurid√£o densa que abafa sons e reduz drasticamente a vis√£o dentro da √°rea. Criaturas no interior t√™m dificuldade em perceber amea√ßas e se comunicar. O efeito pode ser mantido por v√°rios turnos ao custo cont√≠nuo de mana. Gasta uma quantidade grande de mana e controla fortemente o campo de batalha.<span class="termo-destaque" data-tooltip="Custo: 60 + (MP / 2) mana\n+6 por rodada mantida\nCanaliza√ß√£o: 2 turnos + a√ß√£o padr√£o\n√Årea: raio de [6 + MP] m\nDura√ß√£o: at√© 4 rodadas\nEfeito: vis√£o adjacente apenas\n‚Äì2 dados em Presen√ßa">Informa√ß√µes Detalhadas</span>' },
                { custoMana: (n, a) => 120 + Math.floor((n+a.intelecto)/5), custoFoco: 0, custoVida: 0, id: 'fee_8', tier: 5, nome: 'Grito do Abismo', desc: 'O conjurador libera um grito distorcido e antinatural que se propaga em cone, causando dano massivo e desorienta√ß√£o mental. Alvos afetados t√™m seus movimentos prejudicados temporariamente caso n√£o resistam √† press√£o psicol√≥gica do som. Gasta uma quantidade massiva de mana. Nos n√≠veis altos possui uma vers√£o especial.<span class="termo-destaque" data-tooltip="Custo: 120 + (MP / 5) mana\nCanaliza√ß√£o: 3 turnos\n√Årea: cone m√©dio (15 m)\nDano: et√©reo\nEfeito: [MP/1,5 d20]\nResist√™ncia: Presen√ßa [DT 15 + MP]\n‚Äì1 movimento por 1 rodada">Informa√ß√µes Detalhadas</span>' },
            ],
            ascendente: [
                { custoMana: (n, a) => 4 + Math.floor((n+a.intelecto)*2), custoFoco: 0, custoVida: 0, id: 'asc_1', tier: 1,nome: 'Eco da Raiva', desc: 'O conjurador canaliza sua f√∫ria acumulada e a libera em uma explos√£o violenta ao seu redor. A onda de impacto causa dano f√≠sico amplificado por energia primal em alcance curto e empurra os inimigos atingidos para longe. Gasta uma quantidade pequena de mana e √© eficaz para abrir espa√ßo em combate pr√≥ximo.<span class="termo-destaque" data-tooltip="Custo: 4 + (2 √ó MP) mana\nCanaliza√ß√£o: a√ß√£o padr√£o\nAlcance: curto (5 m)\n√Årea: explos√£o ao redor do conjurador\nDano: f√≠sico\nEfeito: [MP/2,5 d10]\nEmpurra inimigos">Informa√ß√µes Detalhadas</span>' },
                { custoMana: (n, a) => 20 + Math.floor((n+a.intelecto)*1.3), custoFoco: 0, custoVida: 0, id: 'asc_2', tier: 2,nome: 'Rugido Bestial', desc: 'A fera interior do conjurador se manifesta atrav√©s de um rugido primal que ecoa em uma ampla √°rea ao redor. Inimigos afetados devem resistir mentalmente ou sofrem penalidades graduais, que variam desde dificuldade em atacar at√© a perda total de a√ß√µes no pr√≥ximo turno, dependendo da intensidade da falha. Gasta uma quantidade moderada de mana e √© focada em controle psicol√≥gico agressivo.<span class="termo-destaque" data-tooltip="Custo: 20 + (MP √ó 1,3) mana\nCanaliza√ß√£o: 1 turno\n√Årea: raio de [MP + 5] m\nResist√™ncia: Presen√ßa [DT 10 + (MP √ó 2)]\nEfeito: penalidades graduais conforme falha">Informa√ß√µes Detalhadas</span>' },
                { custoMana: (n, a) => 20 + Math.floor((n+a.intelecto)*1.3), custoFoco: 0, custoVida: 0, id: 'asc_3', tier: 2,nome: 'Chama Ancestral', desc: 'O conjurador desperta um poder antigo adormecido em seu sangue. Durante alguns turnos, todos os seus ataques corpo a corpo passam a causar dano m√°gico adicional, manifestado como energia ancestral incandescente que envolve seus golpes. Gasta uma quantidade moderada de mana e fortalece o combate direto.<span class="termo-destaque" data-tooltip="Custo: 20 + (MP √ó 1,3) mana\nCanaliza√ß√£o: 1 turno\nDura√ß√£o: 4 turnos\nTipo de dano: et√©reo\nEfeito: +[MP/4 d10] em ataques corpo a corpo">Informa√ß√µes Detalhadas</span>' },
                { custoMana: (n, a) => 35 + Math.floor((n+a.intelecto)*1.11), custoFoco: 0, custoVida: 0, id: 'asc_4', tier: 3,nome: 'Abra√ßar a Dor', desc: 'O conjurador aceita a pr√≥pria dor como combust√≠vel para o poder. Enquanto o efeito durar, quanto mais ferido estiver, maior ser√° o dano que causa. Em estados cr√≠ticos de vida, o poder alcan√ßa n√≠veis extremos. Gasta uma quantidade significativa de mana e recompensa estilos de combate arriscados.<span class="termo-destaque" data-tooltip="Custo: 35 + (MP √ó 1,11) mana\nCanaliza√ß√£o: 1 turno + a√ß√£o padr√£o\nDura√ß√£o: [MP/3] rodadas\nEfeito: b√¥nus de dano escalando com Vida">Informa√ß√µes Detalhadas</span>' },
                { custoMana: (n, a) => 35 + Math.floor((n+a.intelecto)*1.11), custoFoco: 0, custoVida: 0, id: 'asc_5', tier: 3,nome: 'F√≠sico Monstruoso', desc: 'O corpo do conjurador se distorce de forma brutal, m√∫sculos se expandem e a carne se torna mais resistente. Durante a dura√ß√£o do efeito, ele ganha aumento significativo de mobilidade e uma grande quantidade de prote√ß√£o f√≠sica. Gasta uma quantidade significativa de mana e transforma o conjurador em uma amea√ßa frontal dominante.<span class="termo-destaque" data-tooltip="Custo: 35 + (MP √ó 1,11) mana\nCanaliza√ß√£o: 1 turno + a√ß√£o padr√£o\nDura√ß√£o: [MP/3] turnos\nEfeito: +[MP/5] m movimento\n+[MP] armadura">Informa√ß√µes Detalhadas</span>' },
                { custoMana: (n, a) => 60 + Math.floor((n+a.intelecto)/2), custoFoco: 0, custoVida: 0, id: 'asc_6', tier: 4,nome: 'F√∫ria Incontrol√°vel', desc: 'O conjurador marca um inimigo vis√≠vel como foco absoluto de sua raiva. Enquanto o alvo estiver marcado, o conjurador ignora efeitos de controle e impedimentos, avan√ßando implacavelmente em sua dire√ß√£o com maior mobilidade. Se o alvo cair, o efeito se encerra imediatamente. Gasta uma quantidade grande de mana e for√ßa confrontos diretos.<span class="termo-destaque" data-tooltip="Custo: 60 + (MP / 2) mana\nCanaliza√ß√£o: 2 turnos\nAlvo: 1 inimigo vis√≠vel\nDura√ß√£o: [1 + MP/4] turnos\nEfeito: ignora controle\n+3 m ao avan√ßar">Informa√ß√µes Detalhadas</span>' },
                { custoMana: (n, a) => 60 + Math.floor((n+a.intelecto)/2), custoFoco: 0, custoVida: 0, id: 'asc_7', tier: 4,nome: 'Roubo Primordial', desc: 'Os ataques f√≠sicos do conjurador passam a drenar vitalidade dos inimigos, convertendo parte do dano causado em cura. Quanto mais ferido o conjurador estiver, mais potente se torna o efeito de drenagem. Derrotar um inimigo sob esse efeito resulta em uma recupera√ß√£o massiva de vida. Gasta uma quantidade grande de mana e sustenta combates prolongados.<span class="termo-destaque" data-tooltip="Custo: 60 + (MP / 2) mana\nCanaliza√ß√£o: 2 turnos\nDura√ß√£o: [1 + MP/4] turnos\nEfeito: roubo de vida\ncura escalonada por Vida">Informa√ß√µes Detalhadas</span>' },
                { custoMana: (n, a) => 120 + Math.floor((n+a.intelecto)/5), custoFoco: 0, custoVida: 0, id: 'asc_8', tier: 5,nome: 'Ignorar Dor', desc: 'O conjurador suprime completamente os sinais de colapso f√≠sico. Enquanto o efeito durar, ele continua lutando mesmo ap√≥s sofrer ferimentos fatais, ignorando a queda por exaust√£o ou morte iminente. Quando a magia termina, caso ainda esteja gravemente ferido, o corpo finalmente cede. Gasta uma quantidade massiva de mana.<span class="termo-destaque" data-tooltip="Custo: 120 + (MP / 5) mana\nCanaliza√ß√£o: 3 turnos\nDura√ß√£o: [MP/4] turnos\nEfeito: n√£o cai a 0 de Vida\nqueda ao fim do efeito">Informa√ß√µes Detalhadas</span>' },
            ]
        };

        function getDadosAfinidadeClasse(idClasse) {
            // 1. Verifica se √© Arcanista
            if (gruposDeClasse.arcanista.includes(idClasse)) {
                return dadosAfinidade.grupos_classes.arcanista;
            }
            // 2. Verifica se √© Combatente
            if (gruposDeClasse.combatente.includes(idClasse)) {
                return dadosAfinidade.grupos_classes.combatente;
            }
            // 3. Verifica se √© Especialista
            if (gruposDeClasse.especialista.includes(idClasse)) {
                return dadosAfinidade.grupos_classes.especialista;
            }
            
            // Fallback de seguran√ßa (caso a classe n√£o esteja em nenhum grupo)
            return { nome: "Classe Desconhecida", desc: "Sem afinidade definida." };
        }

        // --- HELPER PARA CALCULAR CUSTO ---
        function resolverCusto(custoRaw, nivel, atributos) {
            if (typeof custoRaw === 'function') {
                return custoRaw(nivel, atributos);
            }
            return custoRaw || 0;
        }
        // --- FUN√á√ÉO DE GASTO ---
        function executarGasto(id, custoMana, custoFoco, custoVida) {
            let atualMana = parseInt(document.getElementById('mana-atual').value) || 0;
            let atualFoco = parseInt(document.getElementById('foco-atual').value) || 0;
            let atualVida = parseInt(document.getElementById('vida-atual').value) || 0;

            if (atualMana < custoMana) { alert(`Mana insuficiente! Precisa de ${custoMana}`); return false; }
            if (atualFoco < custoFoco) { alert(`Foco insuficiente! Precisa de ${custoFoco}`); return false; }
            if (atualVida <= custoVida) { alert(`Vida insuficiente!`); return false; }

            document.getElementById('mana-atual').value = atualMana - custoMana;
            document.getElementById('foco-atual').value = atualFoco - custoFoco;
            document.getElementById('vida-atual').value = atualVida - custoVida;

            atualizarBarras();
            autoSalvarStatus();
            return true;
        }


        // --- ESTADO ---
        let pontosGastosHabilidades = 0;
        let habilidadesSelecionadas = new Set();
        let afinidadeEscolhida = null
        let magiasSelecionadas = new Set();
        let pontosGastosMagia = 0; // NOVO ESTADO
        let idFichaAtual = null;
        let inventario = []; // [{nome: "Espada", peso: 2}]
        let ressonanciaAtiva = false;
        const magiasAprendidas = new Set();

        // --- REALTIME & AUTO-SAVE ---
        let timerAutoSave;

        async function toggleRessonancia() {
            if (!idFichaAtual) {
                alert("Ficha ainda n√£o carregada.");
                return;
            }

            ressonanciaAtiva = !ressonanciaAtiva;

            const btn = document.getElementById('btn-ressonancia-big');

            // Toggle visual
            document.body.classList.toggle('ressonancia-ativa');

            if (ressonanciaAtiva) {
                btn.classList.add('ativo');
                btn.innerHTML = `‚ö° ATIVA <span class="custo" id="custo-ressonancia">Drenando...</span>`;
                atualizarVisualRessonancia(parseInt(elNivel.value)||1);
            } else {
                btn.classList.remove('ativo');
                btn.innerHTML = `‚ö° RESSON√ÇNCIA <span class="custo" id="custo-ressonancia">Inativa</span>`;
                document.body.style.removeProperty('--ressonancia-color');
                document.body.style.background = '';
            }

            atualizarTextoRessonancia(parseInt(elNivel.value)||1);

            // üî• SALVA NO SUPABASE
            try {
                const { error } = await supabaseClient
                    .from('Personagens')
                    .update({ ressonancia: ressonanciaAtiva })
                    .eq('id', idFichaAtual);

                if (error) throw error;

            } catch (err) {
                console.error("Erro ao salvar resson√¢ncia:", err);
            }
        }


        function atualizarTextoRessonancia(nivel) {
            const custo = nivel; 
            const label = document.getElementById('custo-ressonancia'); 
            if(label) label.textContent = `-${custo} Mana/turno`; 
        }
        // --- FUN√á√ÉO DE VISUAL DIN√ÇMICO (AZUL -> VINHO) ---
        function atualizarVisualRessonancia(nivel) {
            if (!ressonanciaAtiva) return;

            // 1. Calcula a porcentagem do poder (0.0 no n√≠vel 1 at√© 1.0 no n√≠vel 16)
            // Usamos Math.max(0, ...) para garantir que n√£o fique negativo
            const ratio = Math.min(1, Math.max(0, (nivel - 1) / 15));
            
            // 2. Interpola√ß√£o de Cor (Hue)
            // Come√ßa em 220 (Azul) e vai at√© 350 (Vinho avermelhado)
            const hueInicio = 220;
            const hueFim = 350;
            const currentHue = hueInicio + (hueFim - hueInicio) * ratio;

            // 3. Interpola√ß√£o de Satura√ß√£o e Brilho
            // N√≠vel 1: Mais "lavado" e escuro (Satura√ß√£o 50%, Brilho 15%)
            // N√≠vel 16: Muito vivo e brilhante (Satura√ß√£o 90%, Brilho 45%)
            const saturation = 50 + (ratio * 40); 
            const lightness = 15 + (ratio * 20); 
            
            const color = `hsl(${currentHue}, ${saturation}%, ${lightness}%)`;
            
            // Aplica a cor na vari√°vel CSS
            document.body.style.setProperty('--ressonancia-color', color);
        }

        function autoSalvarStatus() {
            // Se n√£o tem ID (ficha nova), n√£o salva ainda
            if (!idFichaAtual) return;

            // Feedback visual (opcional)
            const btn = document.querySelector('.btn-criar-ficha');
            const textoOriginal = "SALVAR / ATUALIZAR FICHA";

            // Limpa o timer anterior (Isso se chama Debounce - espera voc√™ parar de digitar)
            clearTimeout(timerAutoSave);

            timerAutoSave = setTimeout(() => {
                // Chama sua fun√ß√£o de salvar, mas passando 'true' para n√£o mostrar alerta
                salvarFicha(true); 
                const indicator = document.getElementById('saving-indicator');
                indicator.classList.add('visible');
                btn.textContent = textoOriginal;
                setTimeout(() => indicator.classList.remove('visible'), 1000);  
                if(btn) btn.textContent = textoOriginal;
            }, 1000); // Espera 1 segundo ap√≥s a √∫ltima digita√ß√£o
        }

        function setupRealtime(id) {
            supabaseClient
                .channel('mudancas-ficha')
                .on(
                    'postgres_changes',
                    {
                        event: 'UPDATE',
                        schema: 'public',
                        table: 'Personagens',
                        filter: `id=eq.${id}`
                    },
                    payload => {
                        const d = payload.new.dados;

                        // ---------- RESSON√ÇNCIA (REALTIME) ----------
                        if (typeof payload.new.ressonancia === 'boolean') {
                            if (payload.new.ressonancia !== ressonanciaAtiva) {
                                ressonanciaAtiva = payload.new.ressonancia;

                                const btn = document.getElementById('btn-ressonancia-big');
                                document.body.classList.toggle('ressonancia-ativa', ressonanciaAtiva);

                            if (ressonanciaAtiva) {
                                btn.classList.add('ativo');
                                btn.innerHTML = `‚ö° ATIVA <span class="custo" id="custo-ressonancia">Drenando...</span>`;
                                atualizarVisualRessonancia(parseInt(elNivel.value) || 1);
                            } else {
                                btn.classList.remove('ativo');
                                btn.innerHTML = `‚ö° RESSON√ÇNCIA <span class="custo" id="custo-ressonancia">Inativa</span>`;
                                document.body.style.removeProperty('--ressonancia-color');
                                document.body.style.background = '';
                            }

                                atualizarTextoRessonancia(parseInt(elNivel.value) || 1);
                            }
                        }

                        // ---------- STATUS ----------
                        if (d.statusAtuais) {
                            if (document.activeElement.id !== 'vida-atual')
                                document.getElementById('vida-atual').value = d.statusAtuais.vida;
                            if (document.activeElement.id !== 'mana-atual')
                                document.getElementById('mana-atual').value = d.statusAtuais.mana;
                            if (document.activeElement.id !== 'foco-atual')
                                document.getElementById('foco-atual').value = d.statusAtuais.foco;
                        }

                        // ---------- INVENT√ÅRIO ----------
                        if (d.inventario && JSON.stringify(d.inventario) !== JSON.stringify(inventario)) {
                            inventario = d.inventario;
                            renderizarInventario();
                            atualizarSlotsVisuais();

                            const nivel = parseInt(document.getElementById('nivel').value) || 1;
                            calcularStatus(nivel);
                        }

                        atualizarBarras();
                    }
                )
                .subscribe();
        }

        // --- FUN√á√ïES DE MODO DE JOGO ---
        function toggleModo() {
            const isJogo = document.getElementById('switch-modo').checked;
            if (isJogo) {
                document.body.classList.add('modo-jogo');
                document.body.classList.remove('modo-edicao');
            } else {
                document.body.classList.add('modo-edicao');
                document.body.classList.remove('modo-jogo');
            }
            atualizarTudo(); // Re-renderiza para limpar estados visuais
        }

        function encontrarMagiaPorId(id) {
            // Varre todas as listas de magias
            for (const categoria in dadosMagias) {
                const encontrada = dadosMagias[categoria].find(m => m.id === id.trim());
                if (encontrada) return encontrada;
            }
            return null; // N√£o achou
        }

        // 1. CONTROLE VISUAL DO MODAL
        function toggleCamposConsumivel() {
            const tipo = document.getElementById('input-criar-tipo').value;
            const subtipoEl = document.getElementById('input-criar-subtipo');
            const subtipo = subtipoEl ? subtipoEl.value : null;
            console.log(subtipo)

            // Esconde tudo primeiro
            document.getElementById('campos-consumivel').style.display = 'none';
            document.getElementById('campos-equipamento').style.display = 'none';
            document.getElementById('campos-armadura').style.display = 'none';

            document.getElementById('campos-arma').style.display = 'none';
            document.getElementById('campos-escudo').style.display = 'none';
            document.getElementById('campos-cajado').style.display = 'none';
            document.getElementById('campos-tomo').style.display = 'none';

            // Mostra o espec√≠fico
            if (tipo === 'consumivel') {
                document.getElementById('campos-consumivel').style.display = 'block';
            } 
            else if (tipo === 'equipamento') {
                document.getElementById('campos-equipamento').style.display = 'block';

                if (subtipo === 'arma') {
                    document.getElementById('campos-arma').style.display = 'block';
                }
                else if (subtipo === 'escudo') {
                    document.getElementById('campos-escudo').style.display = 'block';
                }
                else if (subtipo === 'cajado') {
                    document.getElementById('campos-cajado').style.display = 'block';
                }
                else if (subtipo === 'tomo') {
                    document.getElementById('campos-tomo').style.display = 'block';
                }
            }
            else if (tipo === 'armadura') {
                document.getElementById('campos-armadura').style.display = 'block';
            }
        }

        // --- L√ìGICA DE INVENT√ÅRIO (ATUALIZADA V36) ---
        function abrirModalItem() { document.getElementById('modal-item').style.display = 'flex'; mudarAba('criar'); toggleCamposConsumivel(); 
            console.log(toggleCamposConsumivel())
        }
        function fecharModalItem() { 
            document.getElementById('modal-item').style.display = 'none';
            // Limpa campos
            document.getElementById('input-criar-nome').value = '';
            document.getElementById('input-criar-peso').value = '0.0';
            document.getElementById('input-criar-magico').checked = false;
            document.getElementById('input-criar-tipo').value = 'item';
            document.getElementById('input-criar-descricao').value = ''; // Limpa descri√ß√£o
            document.getElementById('input-magias-tomo').value = ''; // Limpa magias
            document.getElementById('input-dano-cajado').value = '';
            document.getElementById('input-bloqueio-escudo').value = '';
            document.getElementById('input-dano-arma').value = '';
            document.getElementById('input-criar-bloqueio').value = '0';


            document.getElementById('campos-consumivel').style.display = 'none';
            document.getElementById('campos-equipamento').style.display = 'none';
            document.getElementById('campos-armadura').style.display = 'none';

            document.getElementById('campos-arma').style.display = 'none';
            document.getElementById('campos-escudo').style.display = 'none';
            document.getElementById('campos-cajado').style.display = 'none';
            document.getElementById('campos-tomo').style.display = 'none';

        }

        function mudarAba(aba) {
            document.querySelectorAll('.tab-content').forEach(el=>el.style.display='none');
            document.querySelectorAll('.tab-btn').forEach(el=>el.classList.remove('active'));
            document.getElementById(`aba-${aba}`).style.display='flex';
            if(aba==='buscar') buscarItensNoBanco();
        }

        // 2. CRIA√á√ÉO DO ITEM (SALVANDO BLOQUEIO)
        async function criarItemNoBanco() {
            const nome = document.getElementById('input-criar-nome').value;
            const tipo = document.getElementById('input-criar-tipo').value;
            const peso = parseFloat(document.getElementById('input-criar-peso').value) || 0;
            const magico = document.getElementById('input-criar-magico').checked;
            const descricao = document.getElementById('input-criar-descricao').value; // Captura Descri√ß√£o

            
            let efeito = null; 
            let valor = 0; 
            let empunhadura = null; 
            let subtipo = null;
            let dano = null

            // L√≥gica para Consum√≠vel
            if (tipo === 'consumivel') {
                efeito = document.getElementById('input-criar-efeito').value; // 'vida', 'mana', etc.
                valor = parseInt(document.getElementById('input-criar-valor').value) || 0;
            }
            
            // L√≥gica para Equipamento (Arma)
            else if (tipo === 'equipamento') {
                empunhadura = document.getElementById('input-criar-empunhadura').value;
                subtipo = document.getElementById('input-criar-subtipo').value;
                    // Captura espec√≠fica baseada no subtipo
                    if (subtipo === 'arma') {
                        dano = document.getElementById('input-dano-arma').value;
                        efeito = 'ataque';
                    } else if (subtipo === 'escudo') {
                        valor = parseInt(document.getElementById('input-bloqueio-escudo').value) || 0;
                        efeito = 'bloqueio';
                    } else if (subtipo === 'cajado') {
                        dano = document.getElementById('input-dano-cajado').value;
                        // Pode adicionar l√≥gica extra aqui
                    } else if (subtipo === 'tomo') {
                        dano = document.getElementById('input-magias-tomo').value; 
                        efeito = 'tomo';
                    }
            }
            
            // L√ìGICA PARA ARMADURA (NOVO)
            else if (tipo === 'armadura') {
                // Salvamos o B√¥nus de Bloqueio na coluna 'valor'
                valor = parseInt(document.getElementById('input-criar-bloqueio').value) || 0;
                // Salvamos Leve/Pesada na coluna 'empunhadura' (reaproveitamento) ou 'subtipo'
                empunhadura = document.getElementById('input-criar-tipo-armadura').value; 
                efeito = 'bloqueio'; // Define que afeta bloqueio
            }

            if(!nome) return alert("D√™ um nome ao item!");

            try {
                const { data, error } = await supabaseClient
                    .from('itens')
                    .insert([{ nome, tipo, peso, magico, efeito, valor, empunhadura, subtipo, dano, descricao }])
                    .select();
                
                if (error) {
                    console.warn("Aviso Banco:", error.message);
                    // Fallback Local
                    adicionarAoInventario({ id: 'local_'+Date.now(), nome, tipo, peso, magico, efeito, valor, empunhadura, subtipo, dano, descricao });
                } else if (data && data.length > 0) {
                    adicionarAoInventario(data[0]);
                }
                
                alert("Item Criado!");
                fecharModalItem();
                
                // Reset dos campos espec√≠ficos
                document.getElementById('input-criar-bloqueio').value = '0';
                
            } catch(e) { console.error(e); }
        }

        async function buscarItensNoBanco() {
            const termo = document.getElementById('input-buscar-termo').value;
            const listaDiv = document.getElementById('lista-banco-itens');
            let query = supabaseClient.from('itens').select('*').limit(10);
            if(termo) query = query.ilike('nome', `%${termo}%`);
            const {data} = await query;
            listaDiv.innerHTML = '';
            if(data) {
                data.forEach(item => {
                    const div = document.createElement('div'); div.className = 'db-item';
                    div.innerHTML = `<div><div style="font-weight:bold; color:${item.magico?'#a855f7':'white'}">${item.nome}</div><div style="font-size:0.8rem; color:#888;">${item.tipo.toUpperCase()} | ${item.peso}kg</div></div><button class="btn-pegar" onclick='adicionarAoInventario(${JSON.stringify(item)})'>Pegar</button>`;
                    listaDiv.appendChild(div);
                });
            }
        }

        function adicionarAoInventario(itemDados) {
            const itemLocal = {
                id_origem: itemDados.id,
                instancia_id: crypto.randomUUID(),

                nome: itemDados.nome,
                tipo: itemDados.tipo,
                peso: itemDados.peso,
                isMagico: itemDados.magico,
                dano: itemDados.dano,
                empunhadura: itemDados.empunhadura,
                subtipo: itemDados.subtipo,
                descricao: itemDados.descricao,

                // üîΩ ESTAVA FALTANDO
                efeito: itemDados.efeito ?? null,
                valor: itemDados.valor ?? 0,

                equipado: false,
                slotId: null
            };

            inventario.push(itemLocal);
            renderizarInventario();
            atualizarBarras();
            atualizarSlotsVisuais();
            autoSalvarStatus();
            calcularStatus(parseInt(elNivel.value)||1);
            
            // SOMENTE se o item for tomo:
            if (itemDados.subtipo === 'tomo') {
            }

        }

        // --- CONSUMIR ITEM (NOVO) ---
        function consumirItem(index) {
            const item = inventario[index];
            
            // Diagn√≥stico
            console.log("Tentando usar:", item); 

            if (!confirm(`Deseja usar ${item.nome}?`)) return;

            // Verifica se os dados existem
            if (!item.efeito) {
                alert(`ERRO: O item '${item.nome}' n√£o tem um Efeito configurado. (efeito: ${item.efeito})`);
                return;
            }
            if (!item.valor) {
                alert(`ERRO: O item '${item.nome}' n√£o tem um Valor de recupera√ß√£o. (valor: ${item.valor})`);
                return;
            }

            const val = parseInt(item.valor);

            // L√≥gica de Aplica√ß√£o
            if (item.efeito === 'vida') {
                const max = parseInt(document.getElementById('stat-vida').textContent) || 100;
                let atual = parseInt(document.getElementById('vida-atual').value) || 0;
                document.getElementById('vida-atual').value = Math.min(max, atual + val);
                alert(`Recuperou ${val} de Vida!`);
            } else if (item.efeito === 'mana') {
                const max = parseInt(document.getElementById('stat-mana').textContent) || 50;
                let atual = parseInt(document.getElementById('mana-atual').value) || 0;
                document.getElementById('mana-atual').value = Math.min(max, atual + val);
                alert(`Recuperou ${val} de Mana!`);
            } else if (item.efeito === 'foco') {
                const max = parseInt(document.getElementById('stat-foco').textContent) || 0;
                let atual = parseInt(document.getElementById('foco-atual').value) || 0;
                document.getElementById('foco-atual').value = Math.min(max, atual + val);
                alert(`Recuperou ${val} de Foco!`);
            } else {
                alert(`Efeito desconhecido: ${item.efeito}`);
                return;
            }

            // Sucesso: Remove e Salva
            inventario.splice(index, 1);
            renderizarInventario();
            atualizarBarras();
            autoSalvarStatus();
        }
        function removerItem(index) {
            if(confirm("Remover?")) { inventario.splice(index, 1); renderizarInventario(); atualizarBarras(); atualizarSlotsVisuais(); autoSalvarStatus(); }
        }

        function renderizarInventario() {
            const lista = document.getElementById('lista-inventario');
            lista.innerHTML = '';

            const icones = {
                item: 'üì¶',
                equipamento: '‚öîÔ∏è',
                armadura: 'üëï',
                acessorio: 'üíç',
                consumivel: 'üß™'
            };

            let pesoTotal = 0;

            inventario.forEach((item, index) => {
                pesoTotal += (item.peso || 0);

                const div = document.createElement('div');
                div.className = 'inv-item';

                const tipoSeguro = item.tipo || 'item';

                // üîπ Define √≠cone do item (SEM alterar o objeto base)
                let iconeItem = icones[tipoSeguro] || 'üì¶';

                if (tipoSeguro === 'equipamento') {
                    if (item.subtipo === 'escudo') iconeItem = 'üõ°Ô∏è';
                    else if (item.subtipo === 'tomo') iconeItem = 'üìñ';
                    else if (item.subtipo === 'cajado') iconeItem = 'üí•‚Äã';
                }

                // Texto do tipo
                let textoTipo = tipoSeguro.toUpperCase();
                if (item.subtipo) textoTipo += ` | ${item.subtipo.toUpperCase()}`;
                if (item.empunhadura && item.subtipo)
                    textoTipo += ` ${item.empunhadura === '2maos' ? '| 2H' : '| 1H'}`;

                let btnAcao = '';
                if (item.descricao != null) { textoTipo += ` | ${item.descricao.toUpperCase()}`}
                

                // Bot√£o EQUIPAR
                if (['equipamento', 'armadura', 'acessorio'].includes(tipoSeguro)) {
                    const estilo = item.equipado
                        ? 'background:#eab308; color:black; font-weight:bold;'
                        : 'background:none; border:1px solid #555; color:#aaa;';
                    const texto = item.equipado ? 'ON' : 'EQ';

                    btnAcao = `<button style="cursor:pointer; border-radius:4px; padding:2px 6px; ${estilo}"
                        onclick="toggleEquiparItem(${index})">${texto}</button>`;
                }
                // Bot√£o USAR
                else if (tipoSeguro === 'consumivel') {
                    btnAcao = `<button class="btn-usar-item" onclick="consumirItem(${index})">USAR</button>`;
                }

                div.innerHTML = `
                    <div class="inv-icon" style="font-size:1.2rem; text-align:center;">${iconeItem}</div>
                    <div style="display:flex; flex-direction:column; justify-content:center;">
                        <span style="color:${item.isMagico ? '#a855f7' : '#ddd'}; font-weight:500;">
                            ${item.nome || 'Item'}
                        </span>
                        <span style="font-size:0.7rem; color:#666;">
                            ${textoTipo}
                        </span>
                    </div>
                    <div style="display:flex; align-items:center; justify-content:center;">
                        ${btnAcao}
                    </div>
                    <span style="color:#aaa; text-align:right; font-size:0.8rem;">
                        ${(item.peso || 0)}kg
                    </span>
                    <button style="color:#ef4444; background:none; border:none; cursor:pointer; font-weight:bold;"
                        onclick="removerItem(${index})">‚úï</button>
                `;

                lista.appendChild(div);
            });

            const elPeso = document.getElementById('peso-atual');
            const maxCarga = parseInt(document.getElementById('stat-carga').textContent) || 0;

            if (elPeso) {
                elPeso.textContent = pesoTotal.toFixed(1);
                elPeso.style.color = pesoTotal > maxCarga ? 'red' : '#aaa';
            }

            atualizarSlotsVisuais();
        }

        function toggleEquiparItem(index) {
            const item = inventario[index];
            if(item.equipado) { item.equipado = false; item.slotId = null; }
            else {
                if(item.isMagico) {
                    const magicos = inventario.filter(i=>i.equipado && i.isMagico).length;
                    if(magicos >= 3) return alert("Limite de sintoniza√ß√£o atingido!");
                }
                if(item.tipo === 'equipamento') { 
                    // SE FOR 2 M√ÉOS (L√≥gica Antiga: Ocupa Principal, Limpa Secund√°ria)
                    if (item.empunhadura === '2maos') {
                        // Limpa Main Hand
                        inventario.forEach(i => { if(i.slotId==='mainhand') { i.equipado=false; i.slotId=null; }});
                        // Limpa Off Hand (Porque ocupa as duas)
                        inventario.forEach(i => { if(i.slotId==='offhand') { i.equipado=false; i.slotId=null; }});
                        
                        item.slotId = 'mainhand'; // Fica visualmente na principal
                    } 
                    // SE FOR 1 M√ÉO (L√≥gica Nova: Tenta Main, depois Off)
                    else {
                        const mainOcupado = inventario.find(i => i.slotId === 'mainhand');
                        // Mas cuidado: Se o que est√° na Main for 2 m√£os, n√£o posso equipar na Off
                        if (mainOcupado && mainOcupado.empunhadura === '2maos') {
                                // Desequipa a de 2 m√£os para liberar
                                mainOcupado.equipado = false; mainOcupado.slotId = null;
                                item.slotId = 'mainhand';
                        }
                        else if (!mainOcupado) {
                            item.slotId = 'mainhand';
                        } else {
                            const offOcupado = inventario.find(i => i.slotId === 'offhand');
                            if (!offOcupado) {
                                item.slotId = 'offhand';
                            } else {
                                // Substitui Offhand
                                offOcupado.equipado = false; offOcupado.slotId = null;
                                item.slotId = 'offhand';
                            }
                        }
                    }
                }
                else if(item.tipo === 'armadura') { inventario.forEach(i=>{if(i.slotId==='armor'){i.equipado=false;i.slotId=null}}); item.slotId='armor'; }
                else if(item.tipo === 'acessorio') {
                    const s1 = inventario.find(i=>i.slotId==='acc1');
                    if(!s1) item.slotId='acc1';
                    else { const s2=inventario.find(i=>i.slotId==='acc2'); if(s2){s2.equipado=false;s2.slotId=null} item.slotId='acc2'; }
                } else return alert("N√£o equip√°vel.");
                item.equipado = true;
            }
            renderizarInventario(); atualizarSlotsVisuais(); autoSalvarStatus(); atualizarTudo()
            // --- A CORRE√á√ÉO M√ÅGICA EST√Å AQUI ---
            // Recalcula os status (Bloqueio, Ataque) imediatamente ap√≥s equipar/desequipar
            const nivelAtual = parseInt(document.getElementById('nivel').value) || 1;
            calcularStatus(nivelAtual); 
        }

        function atualizarSlotsVisuais() {
            // Mapeamento de √çcones Padr√£o
            const defaultIcons = { mainhand: '‚úã', offhand: 'ü§ö', armor: 'üëï', acc1: 'üíç', acc2: 'üìø' };

            ['mainhand','offhand','armor','acc1','acc2'].forEach(sid => {
                const el = document.getElementById(`slot-${sid}`);
                if(el) { 
                    el.className = 'equip-slot'; 
                    el.querySelector('.slot-item').textContent = 'Vazio';
                    // Reseta √≠cone
                    el.querySelector('.slot-icon').textContent = defaultIcons[sid];
                }
            });
            let countMagicos = 0;
            inventario.forEach(item => {
                if(item.equipado && item.slotId) {
                    const el = document.getElementById(`slot-${item.slotId}`);
                    if(el) {
                        el.classList.add('filled');
                        if(item.isMagico) { el.classList.add('magic'); countMagicos++; }
                        el.querySelector('.slot-item').textContent = item.nome;
                        
                        // √çcone Din√¢mico no Slot
                        if(item.subtipo === 'escudo') el.querySelector('.slot-icon').textContent = 'üõ°Ô∏è';
                        else if(item.subtipo === 'tomo') el.querySelector('.slot-icon').textContent = 'üìñ';
                        else if(item.subtipo === 'cajado') el.querySelector('.slot-icon').textContent = 'üí•‚Äã';
                        else if(item.subtipo === 'arma') el.querySelector('.slot-icon').textContent = '‚öîÔ∏è';
                    }
                }
            });
            const counter = document.getElementById('magic-counter');
            if(counter) { counter.textContent = `‚ú® ${countMagicos}/3 Sintonizados`; counter.style.color = countMagicos > 3 ? 'red' : '#a855f7'; }
        }

        // --- ATUALIZA AS BARRAS VISUAIS ---
        function atualizarBarras() {
            // Vida
            const maxVida = parseInt(document.getElementById('stat-vida').textContent) || 100;
            let curVida = parseInt(document.getElementById('vida-atual').value);
            if (isNaN(curVida)) curVida = maxVida; // Se vazio, assume cheio
            const pctVida = Math.max(0, Math.min(100, (curVida / maxVida) * 100));
            document.getElementById('bar-vida-fill').style.width = `${pctVida}%`;

            // Mana
            const maxMana = parseInt(document.getElementById('stat-mana').textContent) || 50;
            let curMana = parseInt(document.getElementById('mana-atual').value);
            if (isNaN(curMana)) curMana = maxMana;
            const pctMana = Math.max(0, Math.min(100, (curMana / maxMana) * 100));
            document.getElementById('bar-mana-fill').style.width = `${pctMana}%`;

            // Foco
            const maxFoco = parseInt(document.getElementById('stat-foco').textContent) || 100;
            let curFoco = parseInt(document.getElementById('foco-atual').value);
            if (isNaN(curFoco)) curFoco = maxFoco; // Se vazio, assume cheio
            const pctFoco = Math.max(0, Math.min(100, (curFoco / maxFoco) * 100));
            document.getElementById('bar-foco-fill').style.width = `${pctFoco}%`;

            // Carga (Invent√°rio)
            let pesoTotal = 0;
            inventario.forEach(i => pesoTotal += i.peso);
            const maxCarga = parseInt(document.getElementById('stat-carga').textContent) || 0;
            document.getElementById('peso-atual').textContent = pesoTotal.toFixed(1);
            
            // Alerta de Sobrecarga
            if (pesoTotal > maxCarga) {
                document.getElementById('peso-atual').style.color = 'red';
            } else {
                document.getElementById('peso-atual').style.color = 'var(--text-muted)';
            }
        }

        // --- ELEMENTOS ---
        const elNivel = document.getElementById('nivel');
        const inputsAtributos = document.querySelectorAll('.input-atributo');
        const inputsPericias = document.querySelectorAll('.input-pericia');
        const inputsGerais = document.querySelectorAll('select, #nivel');

        function getAtributo(id) {
            return parseInt(document.getElementById(id).value) || 0;
        }

        function calcularStatus(nivel) {
            const forca = getAtributo('attr-forca');
            const destreza = getAtributo('attr-destreza');
            const vigor = getAtributo('attr-vigor');
            const intelecto = getAtributo('attr-intelecto');
            const presenca = getAtributo('attr-presenca');
            const classe = document.getElementById('classe').value;
            const combat_points = (nivel < 3 ? 0 
            : nivel < 6 ? 1 
            : nivel < 8 ? 2
            : nivel < 11 ? 3 
            : nivel < 15 ? 4
            : 5);
            const mod_generico = (nivel < 3 ? 0 : 1);
            const mod_afinidade = (nivel < 4 ? 0
                : nivel < 8 ? 1
                : nivel < 12 ? 2
                : nivel < 16 ? 3
                : 4
            )


            // F√ìRMULAS
            let vida = 20 + (vigor * 16) + nivel * 4;
            let mana = 15 + (intelecto * 16) + nivel * 4;
            let foco = 6 + (presenca * 4) + nivel;
            let carga = 4 + forca * 2;
            let movimento = 2 + destreza + Math.floor(nivel * 0.2);


            let bloqueio = 0;
            if (gruposDeClasse.combatente.includes(classe)) bloqueio = forca * 3 + combat_points * 3 + 2 * mod_generico;
            else if (gruposDeClasse.arcanista.includes(classe)) bloqueio = forca * 3 + combat_points * 2 + 2 * mod_generico;
            else bloqueio = forca * 3 + combat_points + 2 * mod_generico;

            let esquiva = 0;
            if (gruposDeClasse.combatente.includes(classe)) esquiva = destreza * 3 + combat_points * 3 + 2 * mod_generico;
            else if (gruposDeClasse.arcanista.includes(classe)) esquiva = destreza * 3 + combat_points * 2 + 2 * mod_generico;
            else esquiva = destreza * 3 + combat_points + 2 * mod_generico;

            // C√°lculo B√¥nus de Ataque (Simplificado por grupo)
            let ataqueBonus = 0;
            if (gruposDeClasse.combatente.includes(classe)) ataqueBonus = combat_points * 3;
            else if (gruposDeClasse.arcanista.includes(classe)) ataqueBonus = combat_points * 3;
            else ataqueBonus = combat_points * 3;

            if (afinidadeEscolhida) {
                if (afinidadeEscolhida.id === 'afin-ref') {
                    vida = parseInt((20 + (vigor * 16) + nivel * 4) * (1 + (mod_afinidade * 2.5) /10))
                } else if (afinidadeEscolhida.id === 'afin-emi') {
                    mana = parseInt((15 + (intelecto * 16) + nivel * 4) * (1 + (mod_afinidade * 2.5) /10))
                } else if (afinidadeEscolhida.id === 'afin-tra') {
                    movimento = parseInt((2 + destreza + (nivel * 0.2)) * (1 + (mod_afinidade * 2.5) /10))
                } else if (afinidadeEscolhida.id === 'afin-mat') {
                    foco = parseInt((6 + (presenca * 4) + nivel) * (1 + (mod_afinidade * 2.5) /10))
                } else if (afinidadeEscolhida.id === 'afin-man') {
                    vida = parseInt((20 + (vigor * 16) + nivel * 4) * (1 + mod_afinidade /10))
                    mana = parseInt((15 + (intelecto * 16) + nivel * 4) * (1 + mod_afinidade /10))
                    movimento = parseInt((2 + destreza + (nivel * 0.2)) * (1 + mod_afinidade /10))
                    foco = parseInt((6 + (presenca * 4) + nivel) * (1 + mod_afinidade /10))
                } else if (afinidadeEscolhida.id === 'afin_lib') {
                    carga = parseInt((4 + forca * 2) * (1+(mod_afinidade/4)))
                }
            }

            let bonusBloqueioItens = 0;
            
            inventario.forEach(item => {
                if (item.equipado) {
                    // Se for Armadura, pega o valor do bloqueio
                    if (item.tipo === 'armadura') {
                        bonusBloqueioItens += (parseInt(item.valor) || 0);
                    }
                    // Se for Escudo (que √© um subtipo de equipamento), pode ter l√≥gica futura aqui
                    if (item.subtipo === 'escudo') {
                        // Se escudo tiver valor de bloqueio salvo, soma aqui tamb√©m
                        bonusBloqueioItens += (parseInt(item.valor) || 0);
                    }
                }
            });

            bloqueio += bonusBloqueioItens;

            // --- L√ìGICA DE DANO DA ARMA ---
            let danoDisplay = "d4"; // Padr√£o
            
            const mainWeapon = inventario.find(i => i.equipado && i.slotId === 'mainhand' && i.tipo === 'equipamento');
            const offWeapon = inventario.find(i => i.equipado && i.slotId === 'offhand' && i.tipo === 'equipamento');
            
            // Verifica se √© Tomo ou Escudo para IGNORAR o campo dano no status visual
            const ignoraDano = ['tomo', 'escudo'];

            if (mainWeapon && mainWeapon.dano && !ignoraDano.includes(mainWeapon.subtipo)) {
                danoDisplay = mainWeapon.dano;
                if (offWeapon && offWeapon.dano && !ignoraDano.includes(offWeapon.subtipo)) {
                    danoDisplay += ` / ${offWeapon.dano}`;
                }
            } else if (offWeapon && offWeapon.dano && !ignoraDano.includes(offWeapon.subtipo)) {
                    danoDisplay = offWeapon.dano;
            }

            // Atualiza na tela
            document.getElementById('stat-bloqueio').textContent = bloqueio;

            // Atualiza HTML
            document.getElementById('stat-vida').textContent = vida;
            document.getElementById('stat-mana').textContent = mana;
            document.getElementById('stat-foco').textContent = foco;
            document.getElementById('stat-carga').textContent = carga;
            document.getElementById('stat-movimento').textContent = movimento + 'm';
            document.getElementById('stat-bloqueio').textContent = bloqueio;
            document.getElementById('stat-esquiva').textContent = esquiva;
            document.getElementById('stat-ataque').textContent = '+' + ataqueBonus;

            document.getElementById('stat-dano').textContent = danoDisplay;

            atualizarBarras();
        }

        // --- RENDERIZA O GRIM√ìRIO (NOVA FUN√á√ÉO) ---
        function renderizarGrimorio(classe, saldoMagia) {
            const container = document.getElementById('lista-magias');
            container.innerHTML = '';

            // Ler Per√≠cia Arcano (Prote√ß√£o contra erro se o input n√£o existir)
            const elArcano = document.getElementById('per-arcano');
            const per_Arcano = elArcano ? (parseInt(elArcano.value) || 0) : 0;

            // L√≥gica de Tiers baseada na Per√≠cia
            let maxTierMagia = 0;
            if (per_Arcano >= 25) maxTierMagia = 5;
            else if (per_Arcano >= 20) maxTierMagia = 4;
            else if (per_Arcano >= 15) maxTierMagia = 3;
            else if (per_Arcano >= 10) maxTierMagia = 2;
            else if (per_Arcano >= 5) maxTierMagia = 1;

            let lista = [];
            if (classe === 'fimbulwinter') lista = dadosMagias.fimbulwinter;
            else if (classe === 'feengari') lista = dadosMagias.feengari;
            else if (classe === 'ascendente') lista = dadosMagias.ascendente;
            else lista = dadosMagias.genericas;

            if (!lista) return;
            // --- LIMPA MAGIAS DE TOMOS ANTIGOS ---
            lista = lista.filter(m => !m.fromTome);

            // Remove tamb√©m do set de selecionadas
            magiasSelecionadas.forEach(id => {
                const magia = encontrarMagiaPorId(id);
                if (magia && magia.fromTome) {
                    magiasSelecionadas.delete(id);
                    magiasAprendidas.delete(magia.id);
                }
            });

            // 2. Procura Tomos Equipados e Adiciona Magias Extras
            inventario.forEach(item => {
                if (item.equipado && item.tipo === 'equipamento' && item.subtipo === 'tomo' && item.dano) {
                    // O campo 'dano' guarda os IDs separados por v√≠rgula (ex: "mag_1, fim_2")
                    const idsExtras = item.dano.split(',').map(s => s.trim());
                    
                    idsExtras.forEach(id => {
                        const magiaExtra = encontrarMagiaPorId(id);
                        if (magiaExtra) {
                            // Cria uma c√≥pia para n√£o alterar o original e adiciona flag
                            const magiaClone = { ...magiaExtra, fromTome: true, tomeName: item.nome };
                            // Evita duplicatas se j√° tiver na lista (opcional)
                            if (!lista.find(m => m.id === magiaClone.id)) {
                                lista.push(magiaClone);
                            }
                        }
                    });
                }
            });

            // Contexto para c√°lculo de custo
            const nivel = parseInt(elNivel.value) || 1;
            const atributos = { 
                intelecto: getAtributo('attr-intelecto'), 
                forca: getAtributo('attr-forca'),
                destreza: getAtributo('attr-destreza'),
                vigor: getAtributo('attr-vigor'),
                presenca: getAtributo('attr-presenca')
            };

            lista.forEach(magia => {
                const btn = document.createElement('div');
                btn.className = 'btn-magia';

                // Estilo especial para magias de Tomo
                if (magia.fromTome) {
                    btn.style.borderColor = 'var(--color-gold)';
                    btn.innerHTML = `<span style="font-size:0.7rem; color:var(--color-gold); position:absolute; top:2px; left:5px;">üìñ ${magia.tomeName}</span>`;
                }

                if (magia.tier > maxTierMagia) {
                    btn.classList.add('bloqueado');
                    btn.textContent = `üîí ${magia.nome} (Req. Arcano ${magia.tier * 5})`;
                } else {
                    if (magia.fromTome) {
                        // Magias de Tomo j√° come√ßam selecionadas
                        btn.classList.add('selecionado');
                        btn.dataset.state = 2;
                        magiasSelecionadas.add(magia.id);

                        btn.innerHTML =
                            `<span style="font-size:0.7rem; color:var(--color-gold); position:absolute; top:2px; left:5px;">
                                üìñ ${magia.tomeName}
                            </span>` + magia.nome;

                    } else if (magiasSelecionadas.has(magia.id)) {
                        btn.classList.add('selecionado');
                        btn.textContent = magia.nome;
                        btn.dataset.state = 2;
                    } else {
                        btn.textContent = magia.nome;
                        btn.dataset.state = 0;
                    }

                    // CORRE√á√ÉO: Adicionado 'e' (evento) como par√¢metro
                    btn.onclick = (e) => {
                        // Se clicou no bot√£o "USAR", para aqui (n√£o abre/fecha info)
                        if (e.target.classList.contains('btn-gasto')) return;

                        const isModoJogo = document.body.classList.contains('modo-jogo');

                        if (isModoJogo) {
                            const isInfo = btn.classList.contains('info');
                            btn.classList.remove('info', 'selecionado');

                            if (isInfo) {
                                // Volta para estado Nome
                                btn.textContent = magia.nome;
                                btn.classList.add('selecionado');
                            } else {
                                // MODO JOGO: MOSTRAR DESCRI√á√ÉO + BOT√ÉO DE GASTO
                                
                                // 1. Calcula custos din√¢micos
                                const cMana = resolverCusto(magia.custoMana, nivel, atributos);
                                const cFoco = resolverCusto(magia.custoFoco, nivel, atributos);
                                const cVida = resolverCusto(magia.custoVida, nivel, atributos);

                                // 2. Reseta o conte√∫do e p√µe a descri√ß√£o (permite HTML)
                                btn.innerHTML = magia.desc;
                                
                                // 3. Se tiver custo, cria o bot√£o "USAR" via DOM (Mais seguro)
                                if (cMana > 0 || cFoco > 0 || cVida > 0) {
                                    const quebra = document.createElement('br');
                                    btn.appendChild(quebra);

                                    const btnUsar = document.createElement('button');
                                    
                                    // Define classes e texto
                                    let textoCusto = [];
                                    if(cMana) textoCusto.push(`${cMana} Mana`);
                                    if(cFoco) textoCusto.push(`${cFoco} Foco`);
                                    if(cVida) textoCusto.push(`${cVida} Vida`);
                                    
                                    btnUsar.textContent = `CONJURAR (${textoCusto.join(', ')})`;
                                    btnUsar.className = `btn-gasto ${cMana ? 'custo-mana' : (cFoco ? 'custo-foco' : 'custo-vida')}`;

                                    // L√≥gica do Clique "USAR"
                                    btnUsar.onclick = (ev) => {
                                        ev.stopPropagation(); // Impede propaga√ß√£o
                                        if (executarGasto(magia.id, cMana, cFoco, cVida)) {
                                            // Feedback Visual Sucesso
                                            btn.style.backgroundColor = '#064e3b'; // Verde escuro tempor√°rio
                                            setTimeout(() => btn.style.backgroundColor = '', 300);
                                        } else {
                                            // Feedback Visual Erro
                                            btn.style.backgroundColor = '#7f1d1d'; // Vermelho escuro tempor√°rio
                                            setTimeout(() => btn.style.backgroundColor = '', 300);
                                        }
                                    };
                                    
                                    btn.appendChild(btnUsar);
                                }

                                btn.classList.add('info');
                            }
                            return;
                        }

                        // MODO EDI√á√ÉO (L√≥gica padr√£o de selecionar/deselecionar)
                        const st = parseInt(btn.dataset.state);
                        btn.classList.remove('selecionado', 'info');
                        if (st === 0) {
                            btn.dataset.state = 1;
                            btn.innerHTML = magia.desc; // Permite HTML
                            btn.classList.add('info');
                        } else if (st === 1) {
                            if (magia.fromTome) {
                                btn.dataset.state = 2; btn.innerHTML = (magia.fromTome ? `<span style="font-size:0.7rem; color:var(--color-gold); position:absolute; top:2px; left:5px;">üìñ ${magia.tomeName}</span>` : '') + magia.nome; btn.classList.add('selecionado'); magiasSelecionadas.add(magia.id); return;
                            } else {
                                if (saldoMagia > 0) {
                                    btn.dataset.state = 2;
                                    btn.textContent = magia.nome;
                                    btn.classList.add('selecionado');
                                    magiasSelecionadas.add(magia.id);
                                    magiasAprendidas.add(magia.id);
                                    atualizarTudo();
                                } else {
                                    alert("Sem pontos de magia suficientes!");
                                    btn.dataset.state = 0;
                                    btn.textContent = magia.nome;
                                }
                            }       
                        } else {
                            btn.dataset.state = 0;
                            btn.textContent = magia.nome;
                            magiasSelecionadas.delete(magia.id);
                            magiasAprendidas.delete(magia.id);
                            atualizarTudo();
                        }
                    };
                }
                container.appendChild(btn);
            });
        }

        function recalcularPontosGastosMagia() {
            return magiasAprendidas.size;
        }
        function sincronizarMagiasAprendidas() {
            magiasAprendidas.clear();

            magiasSelecionadas.forEach(id => {
                const magia = encontrarMagiaPorId(id);
                if (magia && !magia.fromTome) {
                    magiasAprendidas.add(id);
                }
            });
        }

        // --- ATUALIZA√á√ÉO GERAL ---
        function atualizarTudo() {
            const nivel = parseInt(elNivel.value) || 1;
            const classeAtual = document.getElementById('classe').value;
            const intelecto = getAtributo('attr-intelecto');
            // 1. PONTOS
            const pontosTotaisAttr = Math.floor(nivel/2) + 6;
            const pontosTotaisSkill = Math.ceil(nivel * 3/4 - 1)-
            (nivel < 3 ? 0 
            : nivel < 6 ? 1 
            : nivel < 11 ? 2 
            : 3);
            
            let gastosAttr = 0;
            inputsAtributos.forEach(i => gastosAttr += (parseInt(i.value)||0));
            
            const saldoAttr = pontosTotaisAttr - gastosAttr;
            const saldoSkill = pontosTotaisSkill - pontosHabilidadesGastos;

            document.getElementById('pts-attr-atual').textContent = saldoAttr;
            document.getElementById('pts-attr-total').textContent = pontosTotaisAttr;
            document.getElementById('pts-skill-atual').textContent = saldoSkill;
            document.getElementById('pts-skill-total').textContent = pontosTotaisSkill;

            // Cor de erro se negativo
            document.getElementById('pts-attr-atual').style.color = saldoAttr < 0 ? 'var(--color-danger)' : 'var(--color-attr)';
            document.getElementById('pts-skill-atual').style.color = saldoSkill < 0 ? 'var(--color-danger)' : 'var(--color-primary)';

            // 2. AFINIDADE
            const containerAfinidade = document.getElementById('container-afinidade');
            if (nivel >= 4) {
                containerAfinidade.style.display = 'flex';
                renderizarAfinidades();
            } else {
                containerAfinidade.style.display = 'none';
                afinidadeEscolhida = null;
            }

            let pontosTotaisMagia = Math.round(nivel / 3);

            if (afinidadeEscolhida && afinidadeEscolhida.id === 'afin-arc') {
                pontosTotaisMagia = Math.round(nivel / 3) + intelecto;
            }
            pontosGastosMagia = recalcularPontosGastosMagia();
            const saldoMagia = pontosTotaisMagia - pontosGastosMagia;
            


            const elPtsMagiaAtual = document.getElementById('pts-magia-atual');
            const elPtsMagiaTotal = document.getElementById('pts-magia-total');
            if(elPtsMagiaAtual && elPtsMagiaTotal) {
                elPtsMagiaAtual.textContent = saldoMagia;
                elPtsMagiaTotal.textContent = pontosTotaisMagia;
                elPtsMagiaAtual.style.color = saldoMagia < 0 ? 'var(--color-life)' : 'var(--color-magic)';
            }

            // GRIM√ìRIO - L√ìGICA DE EXIBI√á√ÉO
            const containerGrimorio = document.getElementById('container-grimorio');
            if (gruposDeClasse.arcanista.includes(classeAtual)) {
                containerGrimorio.style.display = 'flex';
                renderizarGrimorio(classeAtual, saldoMagia);
            } else {
                containerGrimorio.style.display = 'none';
                magiasSelecionadas.clear();
                pontosGastosMagia = 0;
            }

            // 3. HABILIDADES
            const maxTier = nivel >= 12 ? 3 : (nivel >= 4 ? 2 : 1);
            renderizarColuna('lista-aura', dadosHabilidades.auras[document.getElementById('aura').value], maxTier, saldoSkill);
            renderizarColuna('lista-classe', dadosHabilidades.classes[document.getElementById('classe').value], maxTier, saldoSkill);
            renderizarColuna('lista-trilha', dadosHabilidades.trilhas[document.getElementById('trilha').value], maxTier, saldoSkill);

            // --- PER√çCIAS ---
            
            const pontosTotaisPericia = intelecto * 5;
            let gastosPericia = 0;
            inputsPericias.forEach(i => gastosPericia += (parseInt(i.value) || 0));
            const saldoPericia = pontosTotaisPericia - gastosPericia;

            document.getElementById('pts-pericia-atual').textContent = saldoPericia;
            document.getElementById('pts-pericia-total').textContent = pontosTotaisPericia;
            document.getElementById('pts-pericia-atual').style.color = saldoPericia < 0 ? 'var(--color-life)' : 'var(--color-skill)';


            // 4. STATUS (Chama a nova fun√ß√£o)
            calcularStatus(nivel);
            atualizarTextoRessonancia(nivel); 
        }

        // --- NOVA FUN√á√ÉO DE RENDERIZAR AFINIDADES ---
        function renderizarAfinidades() {
            const container = document.getElementById('lista-afinidades');
            container.innerHTML = '';
            
            // Pega os valores atuais da tela
            const aura = document.getElementById('aura').value;
            const classe = document.getElementById('classe').value;
            const trilha = document.getElementById('trilha').value;

            // Gera as 3 op√ß√µes poss√≠veis para a configura√ß√£o atual
            const opcoes = [
                { origem: 'AURA', ...dadosAfinidade.auras[aura] },
                { origem: 'CLASSE', ...getDadosAfinidadeClasse(classe) },
                { origem: 'TRILHA', ...dadosAfinidade.trilhas[trilha] }
            ];

            opcoes.forEach(opt => {
                const card = document.createElement('div');
                card.className = 'card-afinidade';
                
                // COMPARA√á√ÉO POR ID (MAIS SEGURO)
                if (afinidadeEscolhida && afinidadeEscolhida.id === opt.id) {
                    card.classList.add('selecionado');
                    // Garante que o objeto em mem√≥ria √© o mais recente
                    afinidadeEscolhida = opt; 
                }
                
                card.innerHTML = `<div style="font-size:0.7rem; opacity:0.7; margin-bottom:5px;">${opt.origem}</div><h3 style="margin:0 0 5px 0; font-size:1rem;">${opt.nome}</h3><div style="font-size:0.85rem; opacity:0.9;">${opt.desc}</div>`;
                card.onclick = () => {
                    // Toggle ID
                    if (afinidadeEscolhida && afinidadeEscolhida.id === opt.id) {
                        afinidadeEscolhida = null;
                    } else {
                        afinidadeEscolhida = opt;
                    }
                    renderizarAfinidades();
                    calcularStatus(parseInt(elNivel.value)||1);
                    atualizarTudo();
                };

                container.appendChild(card);
            });
        }

        // --- RENDERIZADOR ---
        function renderizarColuna(id, lista, maxTier, saldo) {
            const el = document.getElementById(id); el.innerHTML = ''; if(!lista) return;

            const nivel = parseInt(elNivel.value) || 1;
            const atributos = { 
                intelecto: getAtributo('attr-intelecto'), 
                forca: getAtributo('attr-forca'),
                destreza: getAtributo('attr-destreza'),
                vigor: getAtributo('attr-vigor'),
                presenca: getAtributo('attr-presenca')
            };

            lista.forEach(h => {
                const btn = document.createElement('div'); btn.className = 'btn-habilidade';
                const sel = habilidadesSelecionadas.has(h.id);
                
                if(h.tier > maxTier) {
                    btn.classList.add('bloqueado');
                    btn.textContent = `üîí ${h.nome} (T${h.tier})`;
                } else {
                    if(sel) { btn.classList.add('selecionado'); btn.textContent = h.nome; btn.dataset.state = 2; }
                    else { btn.textContent = `${h.nome}`; btn.dataset.state = 0; }
                    
                    btn.onclick = (e) => {
                        if(e.target.classList.contains('btn-gasto')) return;
                        const isModoJogo = document.body.classList.contains('modo-jogo');
                        
                        if (isModoJogo) {
                            const isInfo = btn.classList.contains('info');
                            btn.classList.remove('info', 'selecionado');
                            if (isInfo) { btn.textContent = h.nome; btn.classList.add('selecionado'); }
                            else {
                                const cMana = resolverCusto(h.custoMana, nivel, atributos);
                                const cFoco = resolverCusto(h.custoFoco, nivel, atributos);
                                const cVida = resolverCusto(h.custoVida, nivel, atributos);

                                let htmlUso = h.desc;
                                if (cMana > 0 || cFoco > 0 || cVida > 0) {
                                    let textoCusto = [];
                                    if(cMana) textoCusto.push(`${cMana} Mana`);
                                    if(cFoco) textoCusto.push(`${cFoco} Foco`);
                                    if(cVida) textoCusto.push(`${cVida} Vida`);
                                    
                                    const button = document.createElement('button');
                                    button.className = `btn-gasto ${cMana?'custo-mana':(cFoco?'custo-foco':'custo-vida')}`;
                                    button.textContent = `USAR (${textoCusto.join(', ')})`;
                                    
                                    button.onclick = (ev) => {
                                        ev.stopPropagation();
                                        if(executarGasto(h.id, cMana, cFoco, cVida)) {
                                            btn.classList.add('flash-sucesso');
                                        } else {
                                            btn.classList.add('flash-erro');
                                        }
                                        setTimeout(()=> btn.classList.remove('flash-sucesso','flash-erro'), 500);
                                    };
                                    
                                    btn.innerHTML = htmlUso;
                                    btn.appendChild(document.createElement('br'));
                                    btn.appendChild(button);
                                } else {
                                    btn.innerHTML = htmlUso;
                                }
                                btn.classList.add('info');
                            }
                            return;
                        }
                        
                        const st = parseInt(btn.dataset.state);
                        btn.classList.remove('selecionado', 'info');
                        if(st === 0) { btn.dataset.state = 1; btn.innerHTML = h.desc; btn.classList.add('info'); }
                        else if(st === 1) { if(saldo > 0) { btn.dataset.state = 2; btn.textContent = h.nome; btn.classList.add('selecionado'); pontosHabilidadesGastos++; habilidadesSelecionadas.add(h.id); atualizarTudo(); } else { alert("Sem pontos!"); btn.dataset.state = 0; btn.textContent = h.nome; } }
                        else { btn.dataset.state = 0; btn.textContent = h.nome; pontosHabilidadesGastos--; habilidadesSelecionadas.delete(h.id); atualizarTudo(); }
                    }
                }
                el.appendChild(btn);
            });
        }

        // --- NOVA FUN√á√ÉO DE SALVAR ---
        async function salvarFicha(silencioso = false) {
            const btn = document.querySelector('.btn-criar-ficha');
            // S√≥ muda texto do bot√£o se n√£o for silencioso
            if (!silencioso) {
                btn.textContent = "SALVANDO...";
                btn.disabled = true;
            }


            const nomePersonagem = document.querySelector('.input-nome').value || "Sem Nome";
            const nivel = parseInt(document.getElementById('nivel').value);
            const aura =  document.getElementById('aura').value;
            const trilha =  document.getElementById('trilha').value;
            const classe =  document.getElementById('classe').value;
            
            // 1. Coleta Inputs B√°sicos
            const ficha = {
                // 2. Coleta Atributos
                atributos: {
                    forca: getAtributo('attr-forca'),
                    destreza: getAtributo('attr-destreza'),
                    vigor: getAtributo('attr-vigor'),
                    intelecto: getAtributo('attr-intelecto'),
                    presenca: getAtributo('attr-presenca')
                },

                pericias: {
                    medicina: getAtributo('per-medicina'),
                    arcano: getAtributo('per-arcano'),
                    diplomacia: getAtributo('per-diplomacia'),
                    adestrar: getAtributo('per-adestrar'),
                    tecnologia: getAtributo('per-tecnologia')
                },
                // 4. Coleta Habilidades e Magias (Converte Set para Array)
                habilidades: Array.from(habilidadesSelecionadas),
                magias: Array.from(magiasSelecionadas),

                // 5. Coleta Afinidade
                afinidade: afinidadeEscolhida ? afinidadeEscolhida.id : null,

                // 6. Snapshot dos Status Calculados (Opcional, mas √∫til)
                statusCalculados: {
                    vida: document.getElementById('stat-vida').textContent,
                    mana: document.getElementById('stat-mana').textContent,
                    foco: document.getElementById('stat-foco').textContent
                },

                // Novos dados de Gameplay
                statusAtuais: {
                    vida: document.getElementById('vida-atual').value,
                    mana: document.getElementById('mana-atual').value,
                    foco: document.getElementById('foco-atual').value,
                },
                inventario: inventario
            };
            
            try {
                if (!supabaseClient) throw new Error("Supabase n√£o configurado");

                let resposta;

                // SE J√Å TEM ID, ATUALIZA (UPDATE). SE N√ÉO, CRIA (INSERT).
                if (idFichaAtual) {
                    resposta = await supabaseClient
                        .from('Personagens')
                        .update({
                            nome: nomePersonagem,
                            classe: classe,
                            aura: aura,
                            trilha: trilha,
                            dados: ficha,
                        })
                        .eq('id', idFichaAtual);
                } else {
                    resposta = await supabaseClient
                        .from('Personagens')
                        .insert([
                            {
                                nome: nomePersonagem,
                                nivel: nivel,
                                aura: aura,
                                trilha: trilha,
                                classe: classe,
                                dados: ficha
                            }
                        ]);
                }

                
                if (resposta.error) throw resposta.error;
                
                if (!silencioso) {
                    alert(`Ficha de "${nomePersonagem}" salva com sucesso!`);
                } else {
                    console.log("Auto-save completo.");
                }

            } catch (erro) {
                console.error("Erro ao salvar:", erro);
                if (!silencioso) alert("Erro ao salvar.");
            } finally {
                if (!silencioso) {
                    btn.textContent = "SALVANDO / ATUALIZAR FICHA";
                    btn.disabled = false;
                }
            }
        }

        // --- CARREGAR DADOS DO SUPABASE (READ) ---
        async function carregarFicha() {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');

            if (!id) {
                setTimeout(() => {
                    document.getElementById('vida-atual').value = document.getElementById('stat-vida').textContent;
                    document.getElementById('mana-atual').value = document.getElementById('stat-mana').textContent;
                    atualizarBarras();
                }, 500);
                return; // Se n√£o tem ID, √© cria√ß√£o nova
            }
            idFichaAtual = id; // Salva o ID globalmente para usar no Update
            
            document.querySelector('.header-nome h1')?.remove(); // Opcional: remove titulo generico se tiver

            // Feedback de Carregamento
            document.querySelector('.input-nome').value = "Carregando..."

            try {
                const { data, error} = await supabaseClient
                    .from('Personagens')
                    .select('*')
                    .eq('id', id)
                    .single();
                if (error) throw error;
                if (!data) throw new Error("Personagem n√£o Encontrado");

                //POPULAR CAMPOS
                document.querySelector('.input-nome').value = data.nome;
                document.getElementById('nivel').value = data.nivel;
                document.getElementById('aura').value = data.aura;
                document.getElementById('trilha').value = data.trilha;
                document.getElementById('classe').value = data.classe;

                const d = data.dados;

                        // --- RESSON√ÇNCIA ---
                if (typeof data.ressonancia === 'boolean') {
                    ressonanciaAtiva = data.ressonancia;
                } else {
                    ressonanciaAtiva = false;
                }

                // Aplica visual inicial
                if (ressonanciaAtiva) {
                    document.body.classList.add('ressonancia-ativa');
                    atualizarVisualRessonancia(parseInt(elNivel.value)||1);
                } else {
                    document.body.classList.remove('ressonancia-ativa');
                }

                atualizarTextoRessonancia(parseInt(elNivel.value)||1);

                const btn = document.getElementById('btn-ressonancia-big');
                if (btn) {
                    if (ressonanciaAtiva) {
                        btn.classList.add('ativo');
                        btn.innerHTML = `‚ö° ATIVA <span class="custo" id="custo-ressonancia">Drenando...</span>`;
                    } else {
                        btn.classList.remove('ativo');
                        btn.innerHTML = `‚ö° RESSON√ÇNCIA <span class="custo" id="custo-ressonancia">Inativa</span>`;
                    }
                }

                //ATRIBUTOS
                if (d.atributos) {
                    document.getElementById('attr-forca').value = d.atributos.forca;
                    document.getElementById('attr-destreza').value = d.atributos.destreza;
                    document.getElementById('attr-vigor').value = d.atributos.vigor;
                    document.getElementById('attr-intelecto').value = d.atributos.intelecto;
                    document.getElementById('attr-presenca').value = d.atributos.presenca;
                }

                //PERICIAS
                if (d.pericias) {
                    document.getElementById('per-medicina').value = d.pericias.medicina;
                    document.getElementById('per-arcano').value = d.pericias.arcano;
                    document.getElementById('per-diplomacia').value = d.pericias.diplomacia;
                    document.getElementById('per-adestrar').value = d.pericias.adestrar;
                    document.getElementById('per-tecnologia').value = d.pericias.tecnologia;
                }

                if (d.habilidades) {
                    habilidadesSelecionadas = new Set(d.habilidades);
                    pontosHabilidadesGastos = d.habilidades.length;
                }
                if (d.magias) {
                    magiasSelecionadas = new Set(d.magias);
                    pontosGastosMagia = d.magias.length;
                    
                }  
                if (d.afinidade) {
                    // d.afinidade √© uma string ID (ex: 'af_reforco')
                    // Precisamos descobrir qual objeto atual corresponde a esse ID.
                    // Como as afinidades dependem do que est√° selecionado nos Dropdowns (Aura/Classe/Trilha),
                    // precisamos primeiro garantir que os dropdowns est√£o setados (o que j√° fazemos em 'd.origem' e 'data.classe')
                    
                    // Agora, simulamos a busca das op√ß√µes dispon√≠veis para ver se o ID salvo est√° entre elas.
                    const auraVal = document.getElementById('aura').value;
                    const classeVal = document.getElementById('classe').value;
                    const trilhaVal = document.getElementById('trilha').value;
                    
                    // Recria as op√ß√µes poss√≠veis
                    const possiveis = [
                        dadosAfinidade.auras[auraVal],
                        getDadosAfinidadeClasse(classeVal),
                        dadosAfinidade.trilhas[trilhaVal]
                    ];
                    
                    // Tenta encontrar o objeto completo pelo ID salvo
                    const encontrada = possiveis.find(p => p && p.id === d.afinidade);
                    
                    if (encontrada) {
                        afinidadeEscolhida = encontrada;
                    } else {
                        console.warn("Afinidade salva n√£o compat√≠vel com a configura√ß√£o atual.");
                    }
                }
                if (d.inventario) {
                    inventario = d.inventario;
                    renderizarInventario()
                }
                sincronizarMagiasAprendidas();

                atualizarTudo();
                

                if (d.statusAtuais) {
                    document.getElementById('vida-atual').value = d.statusAtuais.vida;
                    document.getElementById('mana-atual').value = d.statusAtuais.mana;
                    document.getElementById('foco-atual').value = d.statusAtuais.foco;
                }

                
                atualizarBarras();

                console.log("Ficha carregada:", data.nome);
                setupRealtime(id);
                toggleModo(); 
            } catch (erro) {
                console.error("Erro ao carregar:", erro);
                alert("Erro ao carregar ficha");
            }
        }


        // --- LISTENERS ---
        inputsGerais.forEach(el => {
            const inputsEstruturais = document.querySelectorAll('#aura, #classe, #trilha, #nivel');
            
            inputsEstruturais.forEach(el => {
                el.addEventListener('change', (e) => {
                    // Se mudou Aura, Classe ou Trilha, a√≠ sim resetamos as escolhas
                    if(e.target.id !== 'nivel') { 
                        pontosHabilidadesGastos = 0; 
                        habilidadesSelecionadas.clear(); 
                        magiasSelecionadas.clear(); 
                        pontosGastosMagia = 0;
                    }
                    atualizarBarras();
                    atualizarTudo();
                });
                
                // O n√≠vel tem um tratamento especial de 'input' para atualizar em tempo real
                if(el.id === 'nivel') {
                    el.addEventListener('input', atualizarTudo);
                }
            });
        });
        inputsAtributos.forEach(el => el.addEventListener('input', atualizarTudo));
        inputsPericias.forEach(el => el.addEventListener('input', atualizarTudo));

        carregarFicha();
        atualizarTudo();
        setTimeout(() => { if(!idFichaAtual) { /* popula barras iniciais */ atualizarBarras(); } }, 600);

    </script>
</body>
