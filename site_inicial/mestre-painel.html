<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Mestre - M√≥dulo 1: Resson√¢ncia</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Anima√ß√µes */
        .card-enter { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .active-turn { 
            border-color: #a855f7 !important; 
            background-color: #1e293b !important; 
            transform: scale(1.01);
            box-shadow: 0 10px 15px -3px rgba(168, 85, 247, 0.2);
            z-index: 10;
        }

        /* Efeito de Resson√¢ncia */
        .card-ressonancia {
            border-color: #d8b4fe !important;
            animation: pulseMagic 2s infinite alternate ease-in-out !important;
        }

        @keyframes pulseMagic {
            0% {
                box-shadow: 0 0 15px rgba(168, 85, 247, 0.3), inset 0 0 10px rgba(168, 85, 247, 0.1);
                background: linear-gradient(135deg, rgb(151, 180, 228) 0%, rgba(148, 7, 255, 0.25) 100%);
            }
            100% {
                box-shadow: 0 0 25px rgba(192, 132, 252, 0.6), inset 0 0 20px rgba(168, 85, 247, 0.2);
                border-color: #e9d5ff;
                background: linear-gradient(135deg, rgb(180, 200, 255) 0%, rgba(180, 80, 255, 0.4) 100%);
            }
        }

        /* Notifica√ß√£o Toast */
        #system-toast {
            transition: transform 0.3s ease, opacity 0.3s ease;
            transform: translateY(-100%);
            opacity: 0;
        }
        #system-toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        /* Utilit√°rios */
        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

        /* Timeline Cards */
        .timeline-card {
            min-width: 60px;
            height: 80px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.3s ease;
        }

        /* O Primeiro da fila (Vez atual) */
        .timeline-card.first {
            border-color: #a855f7;
            background: #1e293b;
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.4);
            z-index: 10;
            margin-right: 10px;
        }

        /* O Marco de Rodada */
        .timeline-marker {
            min-width: 4px;
            height: 80px;
            background: #fbbf24; /* Amarelo */
            border-radius: 2px;
            box-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
            margin: 0 5px;
            position: relative;
        }
        .timeline-marker::after {
            content: 'RODADA';
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 8px;
            color: #fbbf24;
            font-weight: bold;
        }
        /* Estilos do Log */
        .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid #1e293b;
            display: flex;
            gap: 6px;
        }
        .log-time { color: #64748b; font-size: 10px; min-width: 35px; }
        .log-msg { color: #cbd5e1; word-break: break-word; }

        /* Cores de Eventos */
        .log-dano { color: #f87171; } /* Vermelho */
        .log-cura { color: #4ade80; } /* Verde */
        .log-mana { color: #22d3ee; } /* Azul */
        .log-item { color: #fbbf24; } /* Amarelo */
        .log-info { color: #94a3b8; } /* Cinza */

        /* Estado Minimizado */
        .log-minimized {
            height: 40px !important;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen pb-20">

    <!-- HEADER -->
    <header class="bg-slate-950 border-b border-slate-800 p-4 sticky top-0 z-50 shadow-lg">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <svg class="text-purple-500 w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                <h1 class="text-xl font-bold bg-gradient-to-r from-purple-400 to-pink-600 bg-clip-text text-transparent">
                    Painel do Mestre <span class="text-xs text-green-500 font-mono bg-green-900/30 px-2 py-0.5 rounded ml-2 border border-green-800" id="status-conn">‚óè Online</span>
                </h1>
            </div>
            <button onclick="carregarPersonagens()" class="p-2 rounded-lg hover:bg-slate-800 text-slate-400 transition-colors" title="Sincronizar">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
            </button>
        </div>
    </header>

    <!-- TOAST DE SISTEMA -->
    <div id="system-toast" class="fixed top-20 left-1/2 -translate-x-1/2 z-[60] bg-blue-600 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 font-bold text-sm pointer-events-none border border-blue-400">
        <svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24" id="toast-icon"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
        <span id="toast-msg">Mensagem do Sistema</span>
    </div>

    <main class="max-w-6xl mx-auto p-4">
        
        <div id="error-box" class="hidden bg-red-500/10 border border-red-500 text-red-200 p-3 rounded-lg mb-6 text-sm flex items-center gap-2">
            <span id="error-msg">Erro</span>
        </div>

        <div id="view-combat">
            <!-- M√ìDULO 5: TIMELINE VISUAL -->
            <div class="mb-6">
                <h3 class="text-xs font-bold text-slate-500 uppercase mb-2">Linha do Tempo (Pr√≥ximos Turnos)</h3>
                <div class="flex items-center gap-2 overflow-x-auto pb-2 custom-scroll" id="timeline-track">
                    <!-- √çcones da timeline ser√£o injetados aqui -->
                </div>
            </div>

            <div class="flex flex-wrap gap-3 items-center bg-slate-800 p-4 rounded-xl border border-slate-700 shadow-lg mb-6">
                <button onclick="abrirModalImportacao()" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-bold transition-all">Importar</button>
                <button onclick="adicionarMonstro()" class="flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded text-sm font-bold transition-all">+ Monstro</button>
                <div class="h-6 w-px bg-slate-600 mx-2 hidden sm:block"></div>
                <button onclick="ordenarIniciativa()" class="flex items-center gap-2 bg-slate-700 hover:bg-slate-600 text-slate-200 px-4 py-2 rounded text-sm font-bold transition-all">Ordenar</button>
                <button onclick="proximoTurno()" class="flex items-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded text-sm font-bold ml-auto shadow-lg shadow-emerald-900/50 hover:scale-105 transition-transform">Pr√≥ximo Turno ‚Üí</button>
            </div>

            <div id="combat-list" class="grid gap-3">
                <div class="text-center py-24 text-slate-500 border-2 border-dashed border-slate-700 rounded-xl bg-slate-900/50">
                    <p class="text-lg font-medium">Carregando...</p>
                </div>
            </div>
        </div>

        <!-- MODAL IMPORTA√á√ÉO -->
        <div id="modal-importacao" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/70 backdrop-blur-sm p-4">
            <div class="bg-slate-900 w-full max-w-2xl rounded-xl border border-slate-700 shadow-2xl flex flex-col max-h-[90vh]">
                <div class="p-6 border-b border-slate-800 flex justify-between items-center bg-slate-900 rounded-t-xl">
                    <h2 class="text-xl font-bold text-white">Selecionar Personagens</h2>
                    <button onclick="fecharModalImportacao()" class="text-slate-500 hover:text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                </div>
                <div class="px-6 pt-4">
                    <input type="text" id="busca-importacao" onkeyup="filtrarListaImportacao()" placeholder="Buscar..." class="w-full bg-slate-950 border border-slate-800 rounded-lg p-3 text-sm text-white focus:border-blue-500 outline-none">
                </div>
                <div class="p-6 overflow-y-auto custom-scroll flex-1">
                    <div id="lista-importacao" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
                </div>
                <div class="p-4 border-t border-slate-800 bg-slate-900 rounded-b-xl flex justify-end gap-3">
                    <button onclick="fecharModalImportacao()" class="px-4 py-2 text-slate-400 hover:text-white font-medium">Cancelar</button>
                    <button onclick="confirmarImportacao()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold">Importar</button>
                </div>
            </div>
        </div>
    </main>

    <!-- MODAL DE EFEITOS (M√ìDULO 4 - COMPLETO) -->
    <div id="modal-efeitos" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/70 backdrop-blur-sm p-4">
        <div class="bg-slate-900 w-full max-w-sm rounded-xl border border-slate-700 shadow-2xl overflow-hidden">
            <div class="p-4 bg-slate-950 border-b border-slate-800 flex justify-between items-center">
                <h3 class="font-bold text-white">Adicionar Condi√ß√£o</h3>
                <button onclick="fecharModalEfeitos()" class="text-slate-500 hover:text-white">&times;</button>
            </div>
            
            <!-- Configura√ß√£o: Dura√ß√£o e Modificadores -->
            <div class="px-4 pt-4 pb-4 bg-slate-900/50 border-b border-slate-800">
                
                <!-- Dura√ß√£o -->
                <div class="flex items-center gap-2 mb-3">
                    <div class="flex-1">
                        <label class="text-[10px] text-slate-400 font-bold uppercase block mb-1">Dura√ß√£o (Rodadas)</label>
                        <input type="number" id="input-duracao-efeito" value="3" min="0" class="w-full bg-slate-950 border border-slate-700 rounded px-2 py-1 text-white font-mono text-center focus:border-blue-500 outline-none">
                    </div>
                    <span class="text-[10px] text-slate-500 w-16 leading-tight mt-4">0 = Infinito</span>
                </div>

                <!-- M√ìDULO 4: Modificadores por Rodada -->
                <label class="text-[10px] text-slate-400 font-bold uppercase block mb-1">Altera√ß√£o por Rodada (Ex: -5 ou 5)</label>
                <div class="grid grid-cols-3 gap-2">
                    <!-- Vida -->
                    <div class="relative">
                        <input type="number" id="mod-vida" placeholder="0" class="w-full bg-slate-950 border border-red-900/50 text-red-400 font-bold text-center rounded py-1 focus:border-red-500 outline-none placeholder-red-900/30">
                        <span class="absolute right-1 top-1/2 -translate-y-1/2 text-[8px] text-red-700 font-bold">HP</span>
                    </div>
                    <!-- Mana -->
                    <div class="relative">
                        <input type="number" id="mod-mana" placeholder="0" class="w-full bg-slate-950 border border-cyan-900/50 text-cyan-400 font-bold text-center rounded py-1 focus:border-cyan-500 outline-none placeholder-cyan-900/30">
                        <span class="absolute right-1 top-1/2 -translate-y-1/2 text-[8px] text-cyan-700 font-bold">MP</span>
                    </div>
                    <!-- Foco -->
                    <div class="relative">
                        <input type="number" id="mod-foco" placeholder="0" class="w-full bg-slate-950 border border-amber-900/50 text-amber-400 font-bold text-center rounded py-1 focus:border-amber-500 outline-none placeholder-amber-900/30">
                        <span class="absolute right-1 top-1/2 -translate-y-1/2 text-[8px] text-amber-700 font-bold">FP</span>
                    </div>
                </div>
            </div>
            
            <!-- Bot√µes R√°pidos -->
            <div class="p-4 grid grid-cols-2 gap-2">
                <button onclick="aplicarEfeito('Queimadura', 'üî•', 'text-orange-500', 'border-orange-500')" class="p-2 bg-slate-800 hover:bg-orange-900/30 border border-slate-700 hover:border-orange-500 rounded flex items-center justify-center gap-2 transition-all">
                    <span>üî•</span> <span class="text-xs font-bold text-orange-200">Queimadura</span>
                </button>
                <button onclick="aplicarEfeito('Congelado', '‚ùÑÔ∏è', 'text-cyan-400', 'border-cyan-400')" class="p-2 bg-slate-800 hover:bg-cyan-900/30 border border-slate-700 hover:border-cyan-400 rounded flex items-center justify-center gap-2 transition-all">
                    <span>‚ùÑÔ∏è</span> <span class="text-xs font-bold text-cyan-200">Congelado</span>
                </button>
                <button onclick="aplicarEfeito('Veneno', 'ü§¢', 'text-green-500', 'border-green-500')" class="p-2 bg-slate-800 hover:bg-green-900/30 border border-slate-700 hover:border-green-500 rounded flex items-center justify-center gap-2 transition-all">
                    <span>ü§¢</span> <span class="text-xs font-bold text-green-200">Veneno</span>
                </button>
                <button onclick="aplicarEfeito('Sangramento', 'ü©∏', 'text-red-600', 'border-red-600')" class="p-2 bg-slate-800 hover:bg-red-900/30 border border-slate-700 hover:border-red-600 rounded flex items-center justify-center gap-2 transition-all">
                    <span>ü©∏</span> <span class="text-xs font-bold text-red-200">Sangrando</span>
                </button>
                <button onclick="aplicarEfeito('Atordoado', '‚ö°', 'text-yellow-400', 'border-yellow-400')" class="p-2 bg-slate-800 hover:bg-yellow-900/30 border border-slate-700 hover:border-yellow-400 rounded flex items-center justify-center gap-2 transition-all">
                    <span>‚ö°</span> <span class="text-xs font-bold text-yellow-200">Atordoado</span>
                </button>
                <button onclick="aplicarEfeito('Regenera√ß√£o', 'üíñ', 'text-pink-400', 'border-pink-400')" class="p-2 bg-slate-800 hover:bg-pink-900/30 border border-slate-700 hover:border-pink-400 rounded flex items-center justify-center gap-2 transition-all">
                    <span>üíñ</span> <span class="text-xs font-bold text-pink-200">Regenera√ß√£o</span>
                </button>
            </div>
            
            <!-- Custom -->
            <div class="p-4 border-t border-slate-800 flex gap-2">
                <input type="text" id="input-efeito-custom" placeholder="Outro..." class="flex-1 bg-slate-950 border border-slate-700 rounded px-2 py-1 text-sm outline-none focus:border-blue-500">
                <button onclick="aplicarEfeitoCustom()" class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm font-bold">Add</button>
            </div>
        </div>
    </div>

    <!-- M√ìDULO 6: HIST√ìRICO DE COMBATE -->
    <div id="combat-log" class="fixed bottom-4 right-4 w-80 bg-slate-900 border border-slate-700 rounded-lg shadow-2xl flex flex-col overflow-hidden transition-all duration-300 z-50 h-96">
        <!-- Header com Toggle -->
        <div class="bg-slate-950 p-3 border-b border-slate-800 flex justify-between items-center cursor-pointer hover:bg-slate-900" onclick="toggleLog()">
            <h3 class="text-xs font-bold text-slate-400 uppercase flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                Hist√≥rico
            </h3>
            <button class="text-slate-500 hover:text-white">
                <svg id="log-arrow" class="w-4 h-4 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
        </div>
        
        <!-- Conte√∫do do Log -->
        <div id="log-content" class="flex-1 overflow-y-auto p-3 space-y-2 custom-scroll bg-slate-900/95 text-xs font-mono">
            <div class="text-slate-600 italic text-center py-4">In√≠cio do registro...</div>
        </div>
    </div>

    <script>
        // --- CONFIGURA√á√ÉO ---
        const { createClient } = window.supabase;
        const supabaseUrl = "https://uoeixaiwyqjtbcqduzid.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVvZWl4YWl3eXFqdGJjcWR1emlkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4ODI2OTgsImV4cCI6MjA3MTQ1ODY5OH0.o_FY6xyjNetUjzsLiqaKrES_-d7_nYUE8vL8vFG8MDA";
        const supabaseClient = createClient(supabaseUrl, supabaseKey);

        let combatentes = [];
        let turnoAtual = 0;
        let candidatosImportacao = [];
        let selecionadosParaImportar = new Set();
        let realtimeChannel = null;
        let saveTimers = {};
        let idAlvoEfeito = null; // Guarda quem vai receber o efeito enquanto o modal est√° aberto
        let tempoRodadaAcumulado = 100;
 

        // --- INICIALIZA√á√ÉO ---
        window.onload = function() {
            window.toggleSelecaoImportacao = toggleSelecaoImportacao;
            renderizarLista();
            iniciarRealtime();
            carregarPersonagens();
        };

        // --- TOAST NOTIFICATION ---
        function mostrarToast(msg, tipo = 'info') {
            const toast = document.getElementById('system-toast');
            const msgEl = document.getElementById('toast-msg');
            const iconEl = document.getElementById('toast-icon');
            
            msgEl.innerText = msg;
            toast.className = `fixed top-20 left-1/2 -translate-x-1/2 z-[60] px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 font-bold text-sm pointer-events-none border transition-all duration-300 transform `;
            
            if (tipo === 'info') {
                toast.classList.add('bg-blue-600', 'text-white', 'border-blue-400');
            } else if (tipo === 'magic') {
                toast.classList.add('bg-purple-600', 'text-white', 'border-purple-400');
            }

            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 1000);
        }

        // --- REALTIME LISTENER ---
        function iniciarRealtime() {
            if (realtimeChannel) supabaseClient.removeChannel(realtimeChannel);
            realtimeChannel = supabaseClient
                .channel('painel-mestre-global')
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'Personagens' }, payload => {
                    const novoDado = payload.new;
                    const idMudou = String(novoDado.id);
                    const index = combatentes.findIndex(c => c.id === idMudou);
                    const dadosAntigos = combatentes[index].dadosRaw || {}; // Pega o JSON completo que salvamos antes
                    compararEGerarLog(combatentes[index].nome, dadosAntigos, novoDado.dados);

                    if (index !== -1) {
                        // Ignora se eu mesmo estou editando
                        if (saveTimers[idMudou]) return;

                        // --- M√ìDULO 6: GERA O LOG ANTES DE ATUALIZAR ---
                        // Pegamos o objeto de dados antigo (que est√° na mem√≥ria do combatentes[index])
                        // Precisamos reconstruir a estrutura original "dados" para comparar com o novo "dados"
                        // Como 'combatentes' √© uma vers√£o processada, vamos comparar o que temos de mais importante
                        
                        // Estrat√©gia: Recriar um objeto parcial 'antigo' baseado no que temos na mem√≥ria
                        const charAntigoSimulado = {
                            statusAtuais: {
                                vida: combatentes[index].hpAtual,
                                mana: combatentes[index].manaAtual,
                                foco: combatentes[index].focoAtual
                            },
                            // Para invent√°rio, n√£o temos na mem√≥ria do combat tracker (s√≥ no objeto original se tiv√©ssemos salvo)
                            // Se voc√™ quiser log de invent√°rio preciso, precisaria guardar o 'rawDados' no objeto combatente.
                            // Mas para Vida/Mana funciona perfeitamente assim.
                        };

                        // O Payload novo traz o JSON completo em 'novoDado.dados'
                        compararEGerarLog(combatentes[index].nome, charAntigoSimulado, novoDado.dados);
                        
                        // ------------------------------------------------

                        const dadosAtualizados = parseCharacterData(novoDado);
                        
                        // Atualiza a mem√≥ria
                        combatentes[index] = { ...combatentes[index], ...dadosAtualizados };
                        
                        // Se quiser log de invent√°rio completo, seria ideal guardar o 'novoDado.dados' dentro de combatentes[index].dadosRaw
                        // combatentes[index].dadosRaw = novoDado.dados; 
                        
                        atualizarInterfaceUnitary(idMudou, combatentes[index]);
                    }
                })
                .subscribe();
        }

        // --- SALVAMENTO ---
        async function persistirAlteracoes(id) {
            if (id.startsWith('mob_')) return;
            const indicador = document.getElementById(`save-status-${id}`);
            if (indicador) indicador.innerHTML = `<svg class="animate-spin w-4 h-4 text-yellow-500" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;

            try {
                // 1. Pega dados atuais do banco
                const { data, error } = await supabaseClient.from('Personagens').select('dados').eq('id', id).single();
                if (error) throw error;

                const charLocal = combatentes.find(c => c.id === id);
                if (!charLocal) return;

                const dadosJson = data.dados || {};
                if (!dadosJson.statusAtuais) dadosJson.statusAtuais = {};
                
                // 2. Atualiza Status
                dadosJson.statusAtuais.vida = charLocal.hpAtual;
                dadosJson.statusAtuais.mana = charLocal.manaAtual;
                dadosJson.statusAtuais.foco = charLocal.focoAtual;
                dadosJson.iniciativa = charLocal.iniciativa;
                
                // 3. ATEN√á√ÉO: Salvar os Efeitos e Tempo tamb√©m!
                dadosJson.efeitos = charLocal.efeitos || [];
                // Opcional: Salvar o tempo acumulado da timeline se quiser persist√™ncia de turno
                // dadosJson.tempoCombate = charLocal.tempoAcumulado || 0; 

                // 4. Envia pro banco
                const { error: updateError } = await supabaseClient.from('Personagens').update({ dados: dadosJson }).eq('id', id);
                if (updateError) throw updateError;

                if (indicador) {
                    indicador.innerHTML = `<svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
                    setTimeout(() => indicador.innerHTML = '', 2000);
                }
                if (window.saveTimers && window.saveTimers[id]) delete window.saveTimers[id];

            } catch (err) {
                console.error("Erro ao salvar:", err);
                if (indicador) indicador.innerHTML = `<span class="text-red-500 text-xs">Erro!</span>`;
            }
        }

        function atualizarStatus(id, campo, valor) {
            const index = combatentes.findIndex(c => c.id == id);
            if (index !== -1) {
                combatentes[index][campo] = parseInt(valor);
                atualizarInterfaceUnitary(id, combatentes[index]);
                if (saveTimers[id]) clearTimeout(saveTimers[id]);
                saveTimers[id] = setTimeout(() => { persistirAlteracoes(id); }, 1000);
            }
        }

        // --- L√ìGICA DE TURNO E MODULO 1 (RESSON√ÇNCIA) ---
        function proximoTurno() {
            if (combatentes.length === 0) return;

            // 1. Descobre quem √© o primeiro da fila (pode ser char ou marker)
            let listaFila = combatentes.map(c => ({ 
                tipo: 'char', ref: c, tempo: c.tempoAcumulado || 0 
            }));
            
            // Adiciona o Marco de Rodada na simula√ß√£o da fila
            listaFila.push({ tipo: 'marker', tempo: tempoRodadaAcumulado });
            
            // Ordena: Menor tempo primeiro. Desempate: Marker sempre por √∫ltimo para garantir que chars ajam antes da virada
            listaFila.sort((a, b) => {
                if (Math.abs(a.tempo - b.tempo) < 0.1) {
                    if (a.tipo === 'marker') return 1; // Marker vai pro fim
                    if (b.tipo === 'marker') return -1;
                }
                return a.tempo - b.tempo;
            });

            const primeiro = listaFila[0];

            // --- CEN√ÅRIO A: √â O MARCO DE RODADA ---
            if (primeiro.tipo === 'marker') {
                // Dispara os efeitos globais (dreno de mana, veneno, etc)
                processarFimDeRodada(); 
                
                // --- CORRE√á√ÉO DA RODADA ---
                // Calcula a menor iniciativa da mesa para definir o tamanho da rodada
                // (A rodada anda na velocidade do mais lento)
                let menorIniciativa = 999;
                combatentes.forEach(c => {
                    // Ignora quem tem 0 ou menos de iniciativa para n√£o quebrar a conta, m√≠nimo 1
                    const inic = Math.max(1, c.iniciativa);
                    if (inic < menorIniciativa) menorIniciativa = inic;
                });
                
                // Se n√£o achou ningu√©m (lista vazia), usa padr√£o 10
                if (menorIniciativa === 999) menorIniciativa = 10;

                // O "Custo" da rodada √© baseado no mais lento.
                // Assim, a rodada s√≥ ser√° alcan√ßada novamente quando o mais lento tiver agido.
                const incrementoRodada = 1000 / menorIniciativa;
                
                tempoRodadaAcumulado += incrementoRodada;
                
                // Chama recursivamente para pular o marco e ir para o pr√≥ximo personagem imediatamente
                proximoTurno(); 
                return;
            }

            // --- CEN√ÅRIO B: √â UM PERSONAGEM ---
            const char = primeiro.ref;
            
            // Calcula o custo do turno baseado na iniciativa
            const iniciativa = Math.max(1, char.iniciativa);
            const custoTempo = 1000 / iniciativa;

            // Atualiza o tempo acumulado dele (joga ele para o final da fila)
            char.tempoAcumulado = (char.tempoAcumulado || 0) + custoTempo;

            // Atualiza a tela (Timeline visual e Destaque no Card)
            renderizarTimeline();
            
            // Se quiser salvar o tempo exato no banco para persist√™ncia entre refreshes:
            // persistirAlteracoes(char.id); 
        }

        function renderizarTimeline() {
            const track = document.getElementById('timeline-track');
            if (!track) return;

            // 1. CLONE PARA SIMULA√á√ÉO
            // Criamos uma c√≥pia dos tempos atuais para simular o futuro sem estragar o jogo real
            let simulacao = combatentes.map(c => ({
                id: c.id,
                nome: c.nome,
                avatar: c.nome.charAt(0),
                iniciativa: Math.max(1, c.iniciativa),
                tempo: c.tempoAcumulado || 0,
                tipo: c.tipo,
                cor: c.tipo === 'monstro' ? 'text-red-400' : 'text-blue-400'
            }));

            // Vari√°vel local para simular o avan√ßo do Marco de Rodada
            let simTempoRodada = tempoRodadaAcumulado;

            let listaVisual = [];
            const PASSOS_FUTUROS = 15; // Quantos turnos queremos ver no futuro

            // 2. LOOP DE PREVIS√ÉO
            for (let i = 0; i < PASSOS_FUTUROS; i++) {
                // Cria lista de candidatos (Chars simulados + Marco de Rodada simulado)
                let candidatos = simulacao.map(c => ({ ...c, tipoObj: 'char' }));
                
                candidatos.push({ 
                    tipoObj: 'marker', 
                    tempo: simTempoRodada 
                });

                // Descobre quem age primeiro nessa itera√ß√£o
                candidatos.sort((a, b) => {
                    if (Math.abs(a.tempo - b.tempo) < 0.1) {
                        // Se empatar, marker fica por √∫ltimo
                        if (a.tipoObj === 'marker') return 1;
                        if (b.tipoObj === 'marker') return -1;
                    }
                    return a.tempo - b.tempo;
                });

                const vencedor = candidatos[0];
                
                // Adiciona √† lista visual final
                // Copiamos os dados para que o valor de 'tempo' fique "congelado" nesse passo
                listaVisual.push({ ...vencedor });

                // AVAN√áA O TEMPO NA SIMULA√á√ÉO
                if (vencedor.tipoObj === 'marker') {
                    // Avan√ßa a rodada baseada no mais lento da simula√ß√£o
                    let menorIniciativa = 999;
                    simulacao.forEach(c => {
                        if (c.iniciativa < menorIniciativa) menorIniciativa = c.iniciativa;
                    });
                    if (menorIniciativa === 999) menorIniciativa = 10;
                    
                    simTempoRodada += (1000 / menorIniciativa);
                } else {
                    // Avan√ßa o personagem espec√≠fico na simula√ß√£o
                    // Precisamos atualizar o objeto dentro da array 'simulacao' para as pr√≥ximas itera√ß√µes
                    const charNaSimulacao = simulacao.find(c => c.id === vencedor.id);
                    charNaSimulacao.tempo += (1000 / charNaSimulacao.iniciativa);
                }
            }

            // 3. RENDERIZA√á√ÉO HTML
            let html = '';
            listaVisual.forEach((item, idx) => {
                if (item.tipoObj === 'marker') {
                    html += `<div class="timeline-marker" title="Fim da Rodada"></div>`;
                } else {
                    const isFirst = idx === 0;
                    const classeFirst = isFirst ? 'first' : 'opacity-70 scale-90';
                    
                    html += `
                    <div class="timeline-card ${classeFirst}">
                        <div class="font-bold text-lg ${item.cor}">${item.avatar}</div>
                        <div class="text-[8px] text-slate-400 truncate w-10 text-center">${item.nome}</div>
                        <div class="absolute -bottom-2 bg-slate-800 text-[8px] px-1 rounded border border-slate-600">${Math.floor(item.tempo)}</div>
                    </div>`;
                }
            });

            track.innerHTML = html;

            // 4. DESTAQUE NO CARD PRINCIPAL (Apenas para o atual real)
            const atualId = listaVisual[0].tipoObj === 'char' ? listaVisual[0].id : null;
            
            combatentes.forEach(c => {
                const card = document.getElementById(`card-${c.id}`);
                if (card) {
                    if (c.id === atualId) {
                        card.classList.add('active-turn', 'border-purple-500');
                        card.classList.remove('opacity-90', 'border-slate-800');
                    } else {
                        card.classList.remove('active-turn', 'border-purple-500');
                        card.classList.add('opacity-90', 'border-slate-800');
                    }
                }
            });
        }

        function processarFimDeRodada() {
            let afetadosRessonancia = 0;
            let totalDano = 0;
            let totalCura = 0;
            let precisaRedesenharTela = false; // Nova flag para controlar atualiza√ß√£o visual

            combatentes.forEach(char => {
                let mudouAlgo = false;

                // 1. Resson√¢ncia
                if (char.ressonancia === true) {
                    const custo = char.nivel > 0 ? char.nivel : 1;
                    const novaMana = Math.max(0, char.manaAtual - custo);
                    if (novaMana !== char.manaAtual) {
                        char.manaAtual = novaMana;
                        afetadosRessonancia++;
                        mudouAlgo = true;
                    }
                }

                // 2. Efeitos e Dura√ß√£o
                if (char.efeitos && char.efeitos.length > 0) {
                    const qtdInicial = char.efeitos.length;
                    
                    // Aplica modificadores (Vida/Mana/Foco)
                    char.efeitos.forEach(ef => {
                        if (ef.mods) {
                            if (ef.mods.vida !== 0) {
                                const antes = char.hpAtual;
                                char.hpAtual = Math.min(char.hpMax, Math.max(0, char.hpAtual + ef.mods.vida));
                                if (char.hpAtual !== antes) {
                                    mudouAlgo = true;
                                    if (ef.mods.vida < 0) totalDano += Math.abs(ef.mods.vida);
                                    else totalCura += ef.mods.vida;
                                }
                            }
                            if (ef.mods.mana !== 0) {
                                const antes = char.manaAtual;
                                char.manaAtual = Math.min(char.manaMax, Math.max(0, char.manaAtual + ef.mods.mana));
                                if (char.manaAtual !== antes) mudouAlgo = true;
                            }
                            if (ef.mods.foco !== 0) {
                                const antes = char.focoAtual;
                                char.focoAtual = Math.min(char.focoMax, Math.max(0, char.focoAtual + ef.mods.foco));
                                if (char.focoAtual !== antes) mudouAlgo = true;
                            }
                        }
                    });

                    // Decrementa Dura√ß√£o
                    char.efeitos = char.efeitos.filter(ef => {
                        if (ef.duracao === 0) return true; // 0 = Infinito
                        ef.duracao -= 1;
                        return ef.duracao > 0; // Remove se chegar a 0
                    });
                    
                    // Se a quantidade mudou OU se as dura√ß√µes mudaram (para atualizar o texto visual)
                    if (char.efeitos.length !== qtdInicial || char.efeitos.some(ef => ef.duracao >= 0)) {
                        mudouAlgo = true;
                        precisaRedesenharTela = true; // Avisa que precisamos atualizar o HTML dos efeitos
                    }
                }

                if (mudouAlgo) {
                    atualizarInterfaceUnitary(char.id, char); // Atualiza barras
                    persistirAlteracoes(char.id); // Salva no banco
                }
            });

            // CORRE√á√ÉO VISUAL: Se os efeitos mudaram, redesenha a lista para atualizar os n√∫meros (3)->(2)
            if (precisaRedesenharTela) {
                renderizarLista();
            }

            // Toasts (Feedback)
            let msg = [];
            if (afetadosRessonancia > 0) msg.push(`${afetadosRessonancia} resson√¢ncias`);
            if (totalDano > 0) msg.push(`-${totalDano} HP total`);
            if (totalCura > 0) msg.push(`+${totalCura} HP total`);
            
            if (msg.length > 0) {
                mostrarToast(`Fim de Rodada: ${msg.join(', ')}`, 'magic');
            } else {
                mostrarToast('Nova Rodada Iniciada', 'info');
            }
        }

        function ordenarIniciativa() {
            combatentes.sort((a, b) => b.iniciativa - a.iniciativa);
            turnoAtual = 0;
            renderizarLista();
        }

        // --- RENDERIZA√á√ÉO ---
        function atualizarInterfaceUnitary(id, char) {
            const hpBar = document.getElementById(`bar-hp-${id}`);
            const mpBar = document.getElementById(`bar-mp-${id}`);
            const focoBar = document.getElementById(`bar-foco-${id}`);

            if(hpBar) hpBar.style.width = `${char.hpMax > 0 ? Math.min(100, (char.hpAtual / char.hpMax) * 100) : 0}%`;
            if(mpBar) mpBar.style.width = `${char.manaMax > 0 ? Math.min(100, (char.manaAtual / char.manaMax) * 100) : 0}%`;
            if(focoBar) focoBar.style.width = `${char.focoMax > 0 ? Math.min(100, (char.focoAtual / char.focoMax) * 100) : 0}%`;

            const inputHp = document.getElementById(`input-hp-${id}`);
            const inputMp = document.getElementById(`input-mp-${id}`);
            const inputFoco = document.getElementById(`input-foco-${id}`);

            if (inputHp && document.activeElement !== inputHp) inputHp.value = char.hpAtual;
            if (inputMp && document.activeElement !== inputMp) inputMp.value = char.manaAtual;
            if (inputFoco && document.activeElement !== inputFoco) inputFoco.value = char.focoAtual;

            const card = document.getElementById(`card-${id}`);
            if (card) {
                if (char.ressonancia) card.classList.add('card-ressonancia');
                else card.classList.remove('card-ressonancia');
            }
        }

        // --- FUN√á√ïES DO M√ìDULO 2 ---

        function abrirModalEfeitos(id) {
            idAlvoEfeito = id;
            document.getElementById('modal-efeitos').classList.remove('hidden');
            document.getElementById('input-efeito-custom').value = '';
            document.getElementById('input-duracao-efeito').value = '3';
            
            // Limpa os modificadores
            document.getElementById('mod-vida').value = '';
            document.getElementById('mod-mana').value = '';
            document.getElementById('mod-foco').value = '';
        }


        // Fecha o modal
        function fecharModalEfeitos() {
            document.getElementById('modal-efeitos').classList.add('hidden');
            idAlvoEfeito = null;
        }
        function aplicarEfeito(nome, icone, corTexto, corBorda) {
            if (!idAlvoEfeito) return;
            
            const duracao = parseInt(document.getElementById('input-duracao-efeito').value) || 0;
            
            // M√ìDULO 4: Captura os modificadores
            const modVida = parseInt(document.getElementById('mod-vida').value) || 0;
            const modMana = parseInt(document.getElementById('mod-mana').value) || 0;
            const modFoco = parseInt(document.getElementById('mod-foco').value) || 0;

            adicionarDadosEfeito(idAlvoEfeito, {
                id: Date.now().toString(),
                nome: nome,
                icone: icone,
                classes: `${corTexto} ${corBorda}`,
                duracao: duracao,
                mods: { vida: modVida, mana: modMana, foco: modFoco } // Salva no objeto
            });
            
            fecharModalEfeitos();
        }

        // Adiciona efeito digitado manualmente
        function aplicarEfeitoCustom() {
            const nome = document.getElementById('input-efeito-custom').value;
            if (!nome || !idAlvoEfeito) return;
            
            aplicarEfeito(nome, '‚ú®', 'text-white', 'border-slate-400');
        }

        // L√≥gica central de adicionar ao array de combatentes
        function adicionarDadosEfeito(charId, efeitoObj) {
            const index = combatentes.findIndex(c => c.id === charId);
            if (index !== -1) {
                // Inicializa array se n√£o existir
                if (!combatentes[index].efeitos) combatentes[index].efeitos = [];
                
                // Adiciona o efeito
                combatentes[index].efeitos.push(efeitoObj);
                
                // Atualiza a tela imediatamente
                renderizarLista(); 
                
                // (Opcional) Salvar no Supabase se quiser persist√™ncia agora, 
                // mas podemos deixar para o pr√≥ximo m√≥dulo se preferir.
                // persistirAlteracoes(charId); 
            }
        }

        // Remove um efeito ao clicar nele
        function removerEfeito(charId, efeitoId) {
            const index = combatentes.findIndex(c => c.id === charId);
            if (index !== -1 && combatentes[index].efeitos) {
                combatentes[index].efeitos = combatentes[index].efeitos.filter(e => e.id !== efeitoId);
                renderizarLista();
                // persistirAlteracoes(charId);
            }
        }

        function renderizarLista() {
            const container = document.getElementById('combat-list');
            if (combatentes.length === 0) {
                container.innerHTML = `<div class="text-center py-24 text-slate-500 border-2 border-dashed border-slate-700 rounded-xl bg-slate-900/50"><p class="text-lg font-medium">Arena vazia</p></div>`;
                return;
            }

            let html = '';
            combatentes.forEach((char, index) => {
                const isActive = index === turnoAtual;
                let cardClasses = `relative flex flex-col md:flex-row items-center gap-4 p-4 rounded-xl border transition-all duration-300 card-enter `;
                if (isActive) cardClasses += 'active-turn border-purple-500 '; else cardClasses += 'bg-slate-900 border-slate-800 opacity-90 ';
                if (char.ressonancia) cardClasses += 'card-ressonancia ';
                if (char.hpAtual <= 0) cardClasses += 'grayscale opacity-50 ';

                const avatarBg = char.tipo === 'monstro' ? 'bg-red-900/40 text-red-400' : 'bg-blue-900/40 text-blue-400';
                const hpPct = char.hpMax > 0 ? Math.min(100, Math.max(0, (char.hpAtual / char.hpMax) * 100)) : 0;
                const mpPct = char.manaMax > 0 ? Math.min(100, Math.max(0, (char.manaAtual / char.manaMax) * 100)) : 0;
                const focoPct = char.focoMax > 0 ? Math.min(100, Math.max(0, (char.focoAtual / char.focoMax) * 100)) : 0;

                // --- RENDERIZA√á√ÉO DOS EFEITOS (EM COLUNA) ---
                let htmlEfeitos = '';
                if (char.efeitos && char.efeitos.length > 0) {
                    // Alterado para 'flex-col' (coluna) e removido 'col-span-3'
                    htmlEfeitos = `<div class="flex flex-col gap-1 mt-2 w-full">`;
                    char.efeitos.forEach(ef => {
                        const textoDuracao = ef.duracao > 0 ? `(${ef.duracao})` : '';

                        // M√ìDULO 4: Texto do Modificador
                        let textoMod = '';
                        if (ef.mods) {
                            if (ef.mods.vida < 0) textoMod += ` <span class="text-red-400 font-bold">${ef.mods.vida}</span>`;
                            if (ef.mods.vida > 0) textoMod += ` <span class="text-green-400 font-bold">+${ef.mods.vida}</span>`;
                            // Voc√™ pode adicionar mana/foco aqui se quiser, mas pode poluir muito o card. HP √© o principal.
                        }

                        htmlEfeitos += `
                            <div onclick="removerEfeito('${char.id}', '${ef.id}')" 
                                class="cursor-pointer bg-slate-950 border ${ef.classes || 'border-slate-600 text-slate-300'} px-2 py-0.5 rounded text-[10px] uppercase font-bold flex items-center gap-1 hover:bg-red-900/50 hover:border-red-500 transition-colors w-fit" title="Clique para remover">
                                <span>${ef.icone}</span> ${ef.nome} ${textoMod} <span class="ml-1 text-[9px] opacity-70">${textoDuracao}</span>
                            </div>
                        `;
                    });
                    htmlEfeitos += `</div>`;
                }

                html += `
                <div id="card-${char.id}" class="${cardClasses}">
                    
                    <!-- Coluna 1: Avatar, Info e EFEITOS -->
                    <div class="flex items-center gap-4 w-full md:w-auto min-w-[200px] self-start">
                        <div class="w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg ${avatarBg}">
                            ${char.nome.charAt(0)}
                        </div>
                        <div class="overflow-hidden w-full">
                            <h3 class="font-bold text-lg text-slate-100 truncate w-32 flex items-center gap-2">
                                ${char.nome}
                                <span id="save-status-${char.id}"></span>
                            </h3>
                            <div class="text-xs text-slate-400">Nv. ${char.nivel} - ${char.classe}</div>
                            
                            <!-- Efeitos inseridos aqui (agora em coluna) -->
                            ${htmlEfeitos}
                        </div>
                    </div>

                    <!-- Coluna 2: Barras -->
                    <div class="flex-1 w-full grid grid-cols-1 lg:grid-cols-3 gap-4 px-2">
                        <div class="flex items-center gap-2"><span class="text-red-500 text-xs font-bold w-6">HP</span><div class="flex-1 h-2 bg-slate-950 rounded-full overflow-hidden border border-slate-800"><div id="bar-hp-${char.id}" class="h-full bg-red-600 transition-all duration-300" style="width: ${hpPct}%"></div></div><input type="number" id="input-hp-${char.id}" class="w-14 bg-slate-950 border border-slate-700 rounded text-center text-sm text-red-200 outline-none focus:border-red-500" value="${char.hpAtual}" oninput="atualizarStatus('${char.id}', 'hpAtual', this.value)"></div>
                        <div class="flex items-center gap-2"><span class="text-cyan-500 text-xs font-bold w-6">MP</span><div class="flex-1 h-2 bg-slate-950 rounded-full overflow-hidden border border-slate-800"><div id="bar-mp-${char.id}" class="h-full bg-cyan-600 transition-all duration-300" style="width: ${mpPct}%"></div></div><input type="number" id="input-mp-${char.id}" class="w-14 bg-slate-950 border border-slate-700 rounded text-center text-sm text-cyan-200 outline-none focus:border-cyan-500" value="${char.manaAtual}" oninput="atualizarStatus('${char.id}', 'manaAtual', this.value)"></div>
                        <div class="flex items-center gap-2"><span class="text-amber-500 text-xs font-bold w-6">FP</span><div class="flex-1 h-2 bg-slate-950 rounded-full overflow-hidden border border-slate-800"><div id="bar-foco-${char.id}" class="h-full bg-amber-500 transition-all duration-300" style="width: ${focoPct}%"></div></div><input type="number" id="input-foco-${char.id}" class="w-14 bg-slate-950 border border-slate-700 rounded text-center text-sm text-amber-200 outline-none focus:border-amber-500" value="${char.focoAtual}" oninput="atualizarStatus('${char.id}', 'focoAtual', this.value)"></div>
                    </div>

                    <!-- Coluna 3: Iniciativa e Bot√µes (CORRIGIDO) -->
                    <div class="flex items-center gap-2 border-l border-slate-800 pl-4">
                        <div class="text-center">
                            <label class="text-[9px] text-slate-500 uppercase font-bold block">Inic</label>
                            <input type="number" class="w-12 bg-transparent text-xl font-bold text-center text-yellow-500 outline-none border-b border-transparent focus:border-yellow-500" value="${char.iniciativa}" onchange="atualizarStatus('${char.id}', 'iniciativa', this.value)">
                        </div>
                        
                        <!-- Bot√£o Efeitos -->
                        <button onclick="abrirModalEfeitos('${char.id}')" class="text-slate-500 hover:text-yellow-400 transition-colors p-2" title="Adicionar Efeito">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        </button>

                        <!-- Bot√£o Remover -->
                        <button onclick="removerCombatente('${char.id}')" class="text-slate-600 hover:text-red-500 transition-colors p-2" title="Remover Ficha">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        // --- SUPORTE ---
        async function carregarPersonagens() {
            try {
                const { data, error } = await supabaseClient.from('Personagens').select('*');
                if (error) throw error;
                if (data) {
                    data.forEach(novo => {
                        const idx = combatentes.findIndex(c => c.id === String(novo.id));
                        if(idx !== -1 && !saveTimers[String(novo.id)]) {
                            const parsed = parseCharacterData(novo);
                            combatentes[idx] = { ...combatentes[idx], ...parsed };
                        }
                    });
                    renderizarLista();
                }
            } catch (err) { console.error(err); }
        }

        function parseCharacterData(char) {
            const dados = char.dados || {};
            return {
                id: String(char.id),
                nome: char.nome,
                classe: (char.classe || 'N/C').toUpperCase(),
                nivel: char.nivel || 0,
                ressonancia: char.ressonancia === true,
                iniciativa: parseInt(dados.iniciativa || 0),
                hpAtual: parseInt(dados.statusAtuais?.vida || dados.statusCalculados?.vida || 0), 
                hpMax: parseInt(dados.statusCalculados?.vida || 0),
                manaAtual: parseInt(dados.statusAtuais?.mana || dados.statusCalculados?.mana || 0), 
                manaMax: parseInt(dados.statusCalculados?.mana || 0),
                focoAtual: parseInt(dados.statusAtuais?.foco || dados.statusCalculados?.foco || 0), 
                focoMax: parseInt(dados.statusCalculados?.foco || 0),    
                tipo: 'jogador',
                dadosRaw: dados, 
            };
        }

        async function abrirModalImportacao() {
            document.getElementById('modal-importacao').classList.remove('hidden');
            const lista = document.getElementById('lista-importacao');
            lista.innerHTML = '<p class="text-slate-500 text-center col-span-2 py-8">Buscando...</p>';
            try {
                const { data, error } = await supabaseClient.from('Personagens').select('*').order('nome', { ascending: true });
                if (error) throw error;
                candidatosImportacao = data.map(parseCharacterData);
                selecionadosParaImportar.clear();
                renderizarListaImportacao();
            } catch (err) { fecharModalImportacao(); }
        }
        function renderizarListaImportacao() {
            const container = document.getElementById('lista-importacao');
            const termo = document.getElementById('busca-importacao').value.toLowerCase();
            const filtrados = candidatosImportacao.filter(p => p.nome.toLowerCase().includes(termo));
            if (filtrados.length === 0) { container.innerHTML = '<p class="text-slate-500 col-span-2 text-center">Nada encontrado.</p>'; return; }
            let html = '';
            filtrados.forEach(char => {
                const jaEmCombate = combatentes.some(c => c.id === char.id);
                const selecionado = selecionadosParaImportar.has(char.id);
                const cardClass = jaEmCombate ? "bg-slate-950 opacity-50 cursor-not-allowed" : (selecionado ? "bg-blue-900/30 border-blue-500" : "bg-slate-800 hover:bg-slate-700");
                const onclick = jaEmCombate ? '' : `onclick="toggleSelecaoImportacao('${char.id}')"`;
                const check = selecionado ? `<svg class="w-6 h-6 text-blue-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>` : `<div class="w-6 h-6 rounded-full border-2 border-slate-600"></div>`;
                html += `<div ${onclick} class="border rounded-lg p-3 cursor-pointer flex justify-between items-center transition-all ${cardClass}"><div class="flex items-center gap-3 overflow-hidden"><div class="w-10 h-10 rounded-full bg-slate-900 flex items-center justify-center font-bold text-slate-400">${char.nome.charAt(0)}</div><div><h4 class="font-bold text-slate-200 truncate">${char.nome}</h4></div></div><div>${jaEmCombate ? '--' : check}</div></div>`;
            });
            container.innerHTML = html;
        }
        function toggleSelecaoImportacao(id) { const strId = String(id); if (selecionadosParaImportar.has(strId)) selecionadosParaImportar.delete(strId); else selecionadosParaImportar.add(strId); renderizarListaImportacao(); }
        function confirmarImportacao() { 
            const novos = candidatosImportacao.filter(c => selecionadosParaImportar.has(c.id)); if (novos.length > 0) { combatentes = [...combatentes, ...novos]; renderizarLista(); } fecharModalImportacao(); renderizarTimeline() }
        function filtrarListaImportacao() { renderizarListaImportacao(); }
        function fecharModalImportacao() { document.getElementById('modal-importacao').classList.add('hidden'); }
        function adicionarMonstro() { const idRandom = Math.random().toString(36).substr(2, 9); combatentes.push({ id: `mob_${idRandom}`, nome: 'Monstro', classe: 'Inimigo', nivel: 1, iniciativa: Math.floor(Math.random() * 20) + 1, hpAtual: 30, hpMax: 30, manaAtual: 0, manaMax: 0, focoAtual: 0, focoMax: 0, tipo: 'monstro', ressonancia: false }); renderizarLista(); }
        function removerCombatente(id) { combatentes = combatentes.filter(c => c.id !== id); if (turnoAtual >= combatentes.length) turnoAtual = 0; renderizarLista(); }

        // --- L√ìGICA DO HIST√ìRICO (M√ìDULO 6) ---

        function toggleLog() {
            const log = document.getElementById('combat-log');
            const arrow = document.getElementById('log-arrow');
            log.classList.toggle('log-minimized');
            arrow.classList.toggle('rotate-180');
        }

        function adicionarLog(msg, tipo = 'info') {
            const container = document.getElementById('log-content');
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            const div = document.createElement('div');
            div.className = 'log-entry animate-pulse'; // Anima√ß√£o r√°pida ao entrar
            div.innerHTML = `<span class="log-time">[${time}]</span> <span class="log-msg ${tipo}">${msg}</span>`;
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight; // Auto-scroll para o fim
            
            // Remove anima√ß√£o depois de um tempo
            setTimeout(() => div.classList.remove('animate-pulse'), 1000);
        }

        // A FUN√á√ÉO DETETIVE
        function compararEGerarLog(nome, dadosAntigos, dadosNovos) {
            if (!dadosAntigos || !dadosNovos) return;

            // 1. Status Atuais (Vida, Mana, Foco)
            const statsA = dadosAntigos.statusAtuais || {};
            const statsN = dadosNovos.statusAtuais || {};

            // Vida
            const diffVida = (parseInt(statsN.vida) || 0) - (parseInt(statsA.vida) || 0);
            if (diffVida !== 0) {
                if (diffVida < 0) adicionarLog(`${nome} perdeu ${Math.abs(diffVida)} HP`, 'log-dano');
                else adicionarLog(`${nome} recuperou ${diffVida} HP`, 'log-cura');
            }

            // Mana
            const diffMana = (parseInt(statsN.mana) || 0) - (parseInt(statsA.mana) || 0);
            if (diffMana !== 0) {
                if (diffMana < 0) adicionarLog(`${nome} gastou ${Math.abs(diffMana)} MP`, 'log-mana');
                else adicionarLog(`${nome} recuperou ${diffMana} MP`, 'log-mana');
            }

            // Foco (Opcional, pode poluir se mudar muito)
            const diffFoco = (parseInt(statsN.foco) || 0) - (parseInt(statsA.foco) || 0);
            if (diffFoco !== 0) {
                adicionarLog(`${nome} Foco: ${statsA.foco} -> ${statsN.foco}`, 'log-info');
            }

            // 2. Invent√°rio (Equipar/Desequipar)
            const invA = dadosAntigos.inventario || [];
            const invN = dadosNovos.inventario || [];

            // Verifica itens equipados
            // Mapeia por ID ou Nome para comparar
            invN.forEach(itemN => {
                const itemA = invA.find(i => i.instancia_id === itemN.instancia_id || i.nome === itemN.nome);
                
                if (itemA) {
                    // Se o item j√° existia, v√™ se mudou o status 'equipado'
                    if (itemN.equipado && !itemA.equipado) {
                        adicionarLog(`${nome} equipou: ${itemN.nome}`, 'log-item');
                    } else if (!itemN.equipado && itemA.equipado) {
                        adicionarLog(`${nome} desequipou: ${itemN.nome}`, 'log-info');
                    }
                }
            });
        }        
    </script>
</body>
</html>